<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å …å¿ƒè¨˜å¸³">
<meta name="theme-color" content="#2F2F2F">
<meta name="mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%232F2F2F'/><text x='96' y='120' text-anchor='middle' font-size='100'>ğŸ¥œ</text></svg>">
<title>å …å¿ƒè¨˜å¸³ â€” Outrun Nutrition ç‡Ÿé‹è¨˜å¸³ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* ==================== åŸºç¤è¨­å®š ==================== */
:root {
  --black: #2F2F2F;
  --orange: #ED5D2B;
  --orange-hover: #d14e1f;
  --blue: #145DDD;
  --dark-gray: #3A3A3A;
  --card-gray: #444444;
  --text-primary: #E0E0E0;
  --text-secondary: #A0A0A0;
  --text-dim: #707070;
  --danger: #E53935;
  --success: #43A047;
  --warning: #FB8C00;
  --radius-lg: 12px;
  --radius-sm: 6px;
  --radius-xs: 4px;
  --font-zh: 'Noto Sans TC', sans-serif;
  --font-en: 'Montserrat', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; }
body {
  font-family: var(--font-zh);
  background: var(--black);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ==================== é ‚éƒ¨å°è¦½ ==================== */
.top-bar {
  background: var(--dark-gray);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  border-bottom: 1px solid rgba(237, 93, 43, 0.3);
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand-icon {
  width: 32px;
  height: 32px;
  background: var(--orange);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.brand-name {
  font-family: var(--font-en);
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--orange);
}

.brand-sub {
  font-size: 11px;
  color: var(--text-secondary);
}

.sync-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);
}

.sync-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--success);
}

.sync-dot.offline { background: var(--warning); }
.sync-dot.error { background: var(--danger); }

/* ==================== åˆ†é å°è¦½ ==================== */
.tab-nav {
  display: flex;
  background: var(--dark-gray);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.tab-btn {
  flex: 1;
  min-width: 80px;
  padding: 12px 8px;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-family: var(--font-zh);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  text-align: center;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}

.tab-btn.active {
  color: var(--orange);
  border-bottom-color: var(--orange);
}

.tab-btn:hover { color: var(--text-primary); }

.tab-icon { font-size: 18px; display: block; margin-bottom: 2px; }

/* ==================== ä¸»å…§å®¹å€ ==================== */
.main-content {
  max-width: 640px;
  margin: 0 auto;
  padding: 16px;
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ==================== å¡ç‰‡å…ƒä»¶ ==================== */
.card {
  background: var(--dark-gray);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.card-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text-primary);
}

.card-badge {
  font-family: var(--font-en);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 3px 8px;
  border-radius: var(--radius-xs);
  background: rgba(237, 93, 43, 0.15);
  color: var(--orange);
}

/* ==================== è¡¨å–®å…ƒä»¶ ==================== */
.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.form-label .required {
  color: var(--orange);
  margin-left: 2px;
}

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px 12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh);
  font-size: 15px;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none;
  border-color: var(--orange);
  background: rgba(237, 93, 43, 0.05);
}

.form-input::placeholder { color: var(--text-dim); }

.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23A0A0A0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.form-textarea {
  resize: vertical;
  min-height: 60px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-row-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}

/* é‡‘é¡è¼¸å…¥ç‰¹æ®Šæ¨£å¼ */
.amount-input-wrap {
  position: relative;
}

.amount-input-wrap .currency {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  font-family: var(--font-en);
  font-size: 13px;
  font-weight: 600;
}

.amount-input-wrap .form-input {
  padding-left: 46px;
  font-family: var(--font-en);
  font-weight: 600;
  font-size: 18px;
}
.amount-preview {
  font-family: var(--font-en);
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 2px;
  padding-left: 4px;
  min-height: 16px;
}

/* ==================== ç…§ç‰‡ä¸Šå‚³ ==================== */
.photo-upload {
  border: 2px dashed rgba(255,255,255,0.15);
  border-radius: var(--radius-lg);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.photo-upload:hover, .photo-upload.drag-over {
  border-color: var(--orange);
  background: rgba(237, 93, 43, 0.05);
}

.photo-upload-icon { font-size: 32px; margin-bottom: 8px; }

.photo-upload-text {
  font-size: 13px;
  color: var(--text-secondary);
}

.photo-upload-text strong {
  color: var(--orange);
}

.photo-upload input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.photo-preview {
  display: none;
  position: relative;
  border-radius: var(--radius-sm);
  overflow: hidden;
  margin-top: 12px;
}

.photo-preview img {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-radius: var(--radius-sm);
}

.photo-preview .remove-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  background: rgba(0,0,0,0.7);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ==================== æŒ‰éˆ• ==================== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-zh);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
}

.btn-primary {
  background: var(--orange);
  color: #fff;
  width: 100%;
  padding: 14px;
  font-size: 16px;
}

.btn-primary:hover { background: var(--orange-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  background: rgba(255,255,255,0.08);
  color: var(--text-primary);
}

.btn-secondary:hover { background: rgba(255,255,255,0.12); }

.btn-outline {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--text-primary);
}

.btn-outline:hover {
  border-color: var(--orange);
  color: var(--orange);
}

.btn-danger {
  background: rgba(229, 57, 53, 0.15);
  color: var(--danger);
}

.btn-sm { padding: 6px 12px; font-size: 12px; }

.btn-group {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

/* ==================== è‡ªè¨‚ä¸‹æ‹‰é¸å–®ï¼ˆæ·±è‰²ä¸»é¡Œï¼‰ ==================== */
.custom-select {
  position: relative;
}

.custom-select-trigger {
  width: 100%;
  padding: 10px 36px 10px 12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh);
  font-size: 15px;
  cursor: pointer;
  transition: border-color 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  user-select: none;
  position: relative;
}

.custom-select-trigger::after {
  content: '';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 0;
  height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid var(--text-secondary);
  transition: transform 0.2s;
}

.custom-select.open .custom-select-trigger::after {
  transform: translateY(-50%) rotate(180deg);
}

.custom-select-trigger:hover,
.custom-select.open .custom-select-trigger {
  border-color: var(--orange);
  background: rgba(237, 93, 43, 0.05);
}

.custom-select-trigger .placeholder {
  color: var(--text-dim);
}

.custom-select-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  max-height: 320px;
  overflow-y: auto;
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--radius-sm);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  z-index: 50;
}

.custom-select.open .custom-select-dropdown {
  display: block;
  animation: fadeSlideIn 0.15s ease;
}

.custom-select-search {
  position: sticky;
  top: 0;
  background: var(--dark-gray);
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  z-index: 1;
}

.custom-select-search input {
  width: 100%;
  padding: 8px 10px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-xs);
  color: var(--text-primary);
  font-family: var(--font-zh);
  font-size: 13px;
  outline: none;
}

.custom-select-search input:focus {
  border-color: var(--orange);
}

.custom-select-search input::placeholder {
  color: var(--text-dim);
}

.custom-select-group-label {
  padding: 8px 12px 4px;
  font-size: 11px;
  font-weight: 700;
  color: var(--orange);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: var(--font-en);
  position: sticky;
  top: 0;
  background: var(--dark-gray);
}

.custom-select-dropdown.has-search .custom-select-group-label {
  top: 41px;
}

.custom-select-option {
  padding: 9px 12px;
  font-size: 14px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.1s;
}

.custom-select-option:hover {
  background: rgba(237, 93, 43, 0.1);
}

.custom-select-option.selected {
  background: rgba(237, 93, 43, 0.15);
  color: var(--orange);
  font-weight: 500;
}

.custom-select-option .option-icon {
  font-size: 16px;
  width: 22px;
  text-align: center;
  flex-shrink: 0;
}

.custom-select-option .option-code {
  font-family: var(--font-en);
  font-size: 11px;
  color: var(--text-dim);
  margin-left: auto;
  flex-shrink: 0;
}

.custom-select-empty {
  padding: 16px;
  text-align: center;
  font-size: 13px;
  color: var(--text-dim);
}

/* å» å•†æœå°‹é¸å–®é¡å¤–æ¨£å¼ */
.vendor-select-trigger {
  min-height: 42px;
}

.vendor-select-trigger .vendor-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(237, 93, 43, 0.12);
  color: var(--orange);
  border-radius: var(--radius-xs);
  padding: 2px 8px;
  font-size: 13px;
  font-weight: 500;
}

.custom-select-option .option-sub {
  font-size: 11px;
  color: var(--text-dim);
}

/* å» å•†é¸é …ï¼šå«ç·¨è¼¯åˆªé™¤æŒ‰éˆ• */
.vendor-option {
  padding: 0 !important;
  gap: 0 !important;
}

.vendor-option-main {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 4px 9px 12px;
  cursor: pointer;
  min-width: 0;
  overflow: hidden;
}

.vendor-option-actions {
  display: flex;
  align-items: center;
  gap: 2px;
  padding-right: 6px;
  opacity: 0;
  transition: opacity 0.15s;
  flex-shrink: 0;
}

.vendor-option:hover .vendor-option-actions {
  opacity: 1;
}

.vendor-action-btn {
  width: 26px;
  height: 26px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 12px;
  border-radius: var(--radius-xs);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-dim);
  transition: all 0.15s;
}

.vendor-action-btn:hover {
  background: rgba(255,255,255,0.08);
  color: var(--text-primary);
}

.vendor-action-del:hover {
  background: rgba(229, 57, 53, 0.15);
  color: var(--danger);
}

/* å» å•†è¡Œå…§ç·¨è¼¯æ¨¡å¼ */
.vendor-edit-inline {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  width: 100%;
}

.vendor-edit-inline input {
  flex: 1;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-xs);
  color: var(--text-primary);
  font-size: 13px;
  padding: 4px 8px;
  font-family: var(--font-zh);
}

.vendor-edit-inline input:focus {
  outline: none;
  border-color: var(--orange);
}

.vendor-edit-inline button {
  padding: 4px 8px;
  border: none;
  border-radius: var(--radius-xs);
  cursor: pointer;
  font-size: 12px;
  font-family: var(--font-zh);
}

.vendor-edit-save {
  background: var(--orange);
  color: #fff;
}

.vendor-edit-cancel {
  background: rgba(255,255,255,0.08);
  color: var(--text-secondary);
}

.custom-select-footer {
  padding: 6px 8px;
  border-top: 1px solid rgba(255,255,255,0.08);
  display: flex;
  gap: 6px;
  position: sticky;
  bottom: 0;
  background: var(--dark-gray);
}

.custom-select-footer button {
  flex: 1;
  padding: 6px 10px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-xs);
  color: var(--text-secondary);
  font-family: var(--font-zh);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
}

.custom-select-footer button:hover {
  border-color: var(--orange);
  color: var(--orange);
}

/* ä¸‹æ‹‰é¸å–®æ²è»¸ */
.custom-select-dropdown::-webkit-scrollbar {
  width: 6px;
}

.custom-select-dropdown::-webkit-scrollbar-track {
  background: transparent;
}

.custom-select-dropdown::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.15);
  border-radius: 3px;
}

.custom-select-dropdown::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.25);
}

/* åŸç”Ÿ select æ·±è‰²ä¿®è£œï¼ˆä»˜æ¬¾æ–¹å¼ã€ç™¼ç¥¨é¡å‹ç­‰è¼ƒç°¡å–®çš„æ¬„ä½ï¼‰ */
.form-select {
  color-scheme: dark;
}

.form-select optgroup {
  background: var(--dark-gray);
  color: var(--text-secondary);
  font-weight: 600;
}

.form-select option {
  background: var(--dark-gray);
  color: var(--text-primary);
  padding: 6px 8px;
}

/* ==================== æœå°‹/ç¯©é¸åˆ— ==================== */
.search-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.search-bar input {
  flex: 1;
  min-width: 120px;
  padding: 8px 12px;
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh);
  font-size: 13px;
}
.search-bar input:focus {
  outline: none;
  border-color: var(--orange);
}
.search-bar input::placeholder { color: var(--text-dim); }
.search-bar select {
  padding: 8px 10px;
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh);
  font-size: 13px;
  color-scheme: dark;
}
.search-bar select:focus { outline: none; border-color: var(--orange); }

/* ==================== å¹´åº¦è¶¨å‹¢åœ– ==================== */
.trend-chart {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  height: 120px;
  padding: 8px 0;
}
.trend-bar-wrap {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
}
.trend-bar {
  width: 100%;
  max-width: 28px;
  background: var(--orange);
  border-radius: 3px 3px 0 0;
  transition: height 0.3s;
  min-height: 2px;
}
.trend-label {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 4px;
  font-family: var(--font-en);
}
.trend-value {
  font-size: 9px;
  color: var(--text-secondary);
  margin-bottom: 4px;
  font-family: var(--font-en);
  white-space: nowrap;
}
.trend-summary {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-top: 1px solid rgba(255,255,255,0.08);
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-secondary);
}
.trend-summary strong { color: var(--text-primary); font-family: var(--font-en); }

@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==================== OCR è¾¨è­˜çµæœ ==================== */
.ocr-status {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.75);
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text-primary);
}

.ocr-result {
  margin-top: 12px;
  background: rgba(67, 160, 71, 0.08);
  border: 1px solid rgba(67, 160, 71, 0.25);
  border-radius: var(--radius-sm);
  padding: 12px;
  animation: fadeSlideIn 0.3s ease;
}

.ocr-result-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 13px;
  font-weight: 600;
  color: var(--success);
}

.ocr-field {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: 13px;
}

.ocr-field:last-child { border-bottom: none; }

.ocr-field-label {
  color: var(--text-secondary);
  min-width: 70px;
}

.ocr-field-value {
  font-weight: 500;
  text-align: right;
  flex: 1;
}

.ocr-field-value.amount {
  font-family: var(--font-en);
  font-weight: 700;
  color: var(--orange);
}

.ocr-field-btn {
  background: none;
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--text-secondary);
  border-radius: var(--radius-xs);
  padding: 2px 8px;
  font-size: 11px;
  cursor: pointer;
  margin-left: 8px;
  transition: all 0.15s;
}

.ocr-field-btn:hover {
  border-color: var(--orange);
  color: var(--orange);
}

.ocr-field-btn.applied {
  background: rgba(67, 160, 71, 0.15);
  border-color: var(--success);
  color: var(--success);
}

.ocr-progress {
  width: 100%;
  height: 3px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
  flex: 1;
}

.ocr-progress-bar {
  height: 100%;
  background: var(--orange);
  border-radius: 2px;
  transition: width 0.3s ease;
  width: 0%;
}

.ocr-status-text {
  font-size: 11px;
  color: var(--text-secondary);
  white-space: nowrap;
}

/* ==================== é ç®—é€²åº¦ ==================== */
.budget-row {
  margin-bottom: 12px;
}

.budget-row-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 12px;
}

.budget-row-label { color: var(--text-secondary); }

.budget-row-amount {
  font-family: var(--font-en);
  font-weight: 600;
  font-size: 12px;
}

.budget-row-amount.ok { color: var(--text-primary); }
.budget-row-amount.warn { color: var(--warning); }
.budget-row-amount.over { color: var(--danger); }

.budget-bar {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.06);
  border-radius: 4px;
  overflow: hidden;
}

.budget-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.budget-bar-fill.ok { background: var(--success); }
.budget-bar-fill.warn { background: var(--warning); }
.budget-bar-fill.over { background: var(--danger); }

.budget-over-tag {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: var(--radius-xs);
  background: rgba(229, 57, 53, 0.15);
  color: var(--danger);
  margin-left: 6px;
}

/* ==================== è²»ç”¨åˆ—è¡¨ ==================== */
.expense-list { list-style: none; }

.expense-item {
  display: flex;
  align-items: center;
  padding: 14px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  gap: 12px;
  cursor: pointer;
  transition: background 0.15s;
  margin: 0 -20px;
  padding-left: 20px;
  padding-right: 20px;
}

.expense-item:hover { background: rgba(255,255,255,0.03); }
.expense-item:last-child { border-bottom: none; }

.expense-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.expense-icon.cat-sales { background: rgba(237, 93, 43, 0.15); }
.expense-icon.cat-admin { background: rgba(20, 93, 221, 0.15); }
.expense-icon.cat-ops { background: rgba(67, 160, 71, 0.15); }
.expense-icon.cat-tax { background: rgba(251, 140, 0, 0.15); }

.expense-info { flex: 1; min-width: 0; }

.expense-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.expense-meta {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.expense-amount {
  font-family: var(--font-en);
  font-weight: 700;
  font-size: 15px;
  color: var(--text-primary);
  text-align: right;
  flex-shrink: 0;
}

.expense-amount .currency-sign {
  font-size: 11px;
  color: var(--text-secondary);
  font-weight: 500;
}

/* æœ‰ç™¼ç¥¨ç…§ç‰‡æ¨™è¨˜ */
.has-photo {
  width: 6px;
  height: 6px;
  background: var(--success);
  border-radius: 50%;
  flex-shrink: 0;
}

/* ==================== çµ±è¨ˆå¡ç‰‡ ==================== */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.stat-card {
  background: var(--dark-gray);
  border-radius: var(--radius-lg);
  padding: 16px;
}

.stat-card.wide { grid-column: span 2; }

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.stat-value {
  font-family: var(--font-en);
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
}

.stat-value .unit {
  font-size: 13px;
  font-weight: 400;
  color: var(--text-secondary);
}

.stat-change {
  font-size: 11px;
  margin-top: 4px;
}

.stat-change.up { color: var(--danger); }
.stat-change.down { color: var(--success); }

/* åˆ†é¡é•·æ¢åœ– */
.bar-chart { margin-top: 12px; }

.bar-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.bar-label {
  width: 80px;
  font-size: 12px;
  color: var(--text-secondary);
  text-align: right;
  flex-shrink: 0;
}

.bar-track {
  flex: 1;
  height: 24px;
  background: rgba(255,255,255,0.05);
  border-radius: var(--radius-xs);
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: var(--radius-xs);
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  padding-left: 8px;
  font-family: var(--font-en);
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
}

.bar-fill.sales { background: var(--orange); }
.bar-fill.admin { background: var(--blue); }
.bar-fill.ops { background: var(--success); }
.bar-fill.tax { background: var(--warning); }

/* ==================== ç¯©é¸åˆ— ==================== */
.filter-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  align-items: center;
}

.month-picker {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--dark-gray);
  border-radius: var(--radius-sm);
  padding: 4px;
}

.month-picker button {
  width: 32px;
  height: 32px;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: var(--radius-xs);
  font-size: 16px;
}

.month-picker button:hover { background: rgba(255,255,255,0.08); }

.month-picker .current-month {
  font-family: var(--font-en);
  font-weight: 600;
  font-size: 14px;
  padding: 0 8px;
  min-width: 100px;
  text-align: center;
}

/* ==================== å ±è¡¨é  ==================== */
.report-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.report-section {
  margin-top: 20px;
}

.report-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-family: var(--font-en);
  margin-bottom: 12px;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.report-table th {
  text-align: left;
  padding: 8px 12px;
  background: rgba(255,255,255,0.05);
  color: var(--text-secondary);
  font-weight: 500;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.report-table th:last-child,
.report-table td:last-child {
  text-align: right;
}

.report-table td {
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}

.report-table tr.total-row {
  font-weight: 700;
  border-top: 2px solid var(--orange);
}

.report-table tr.total-row td {
  padding-top: 12px;
  color: var(--orange);
}

/* ==================== è¨­å®šé  ==================== */
.setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.setting-label { font-size: 14px; }
.setting-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

/* Toggle é–‹é—œ */
.toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
}

.toggle.active { background: var(--orange); }

.toggle::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: left 0.2s;
}

.toggle.active::after { left: 22px; }

/* ==================== Toast é€šçŸ¥ ==================== */
.toast-container {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 200;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}

.toast {
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  padding: 12px 20px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s;
  pointer-events: auto;
}

.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--danger); }
.toast.info { border-left: 3px solid var(--blue); }

@keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

/* ==================== Modal ==================== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 300;
  align-items: flex-end;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--dark-gray);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  width: 100%;
  max-width: 640px;
  max-height: 85vh;
  overflow-y: auto;
  padding: 24px 20px;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal-handle {
  width: 36px;
  height: 4px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  margin: 0 auto 16px;
}

/* ==================== ç©ºç‹€æ…‹ ==================== */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-secondary);
}

.empty-state-icon { font-size: 48px; margin-bottom: 12px; }
.empty-state-text { font-size: 14px; margin-bottom: 16px; }

/* ==================== Loading ==================== */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.2);
  border-top-color: var(--orange);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ==================== éŸ¿æ‡‰å¼ ==================== */
@media (min-width: 768px) {
  .main-content { padding: 24px; }
  .modal { border-radius: var(--radius-lg); margin-bottom: 40px; }
  .modal-overlay { align-items: center; }
}

@media (max-width: 360px) {
  .form-row { grid-template-columns: 1fr; }
  .form-row-3 { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .stat-card.wide { grid-column: span 1; }
}

/* ==================== åˆ—å°æ¨£å¼ ==================== */
@media print {
  body { background: white; color: #333; }
  .top-bar, .tab-nav, .btn, .filter-bar, .photo-upload { display: none; }
  .card { background: white; border: 1px solid #ddd; }
}
</style>
</head>
<body>

<!-- ==================== é ‚éƒ¨å°è¦½ ==================== -->
<header class="top-bar">
  <div class="brand">
    <div class="brand-icon">ğŸ¥œ</div>
    <div>
      <div class="brand-name">Expense Tracker</div>
      <div class="brand-sub">å …å¿ƒç‡Ÿé‹è¨˜å¸³</div>
    </div>
  </div>
  <div class="sync-status" id="syncStatus">
    <span class="sync-dot" id="syncDot"></span>
    <span id="syncText">æœ¬åœ°æ¨¡å¼</span>
  </div>
</header>

<!-- ==================== åˆ†é å°è¦½ ==================== -->
<nav class="tab-nav">
  <button class="tab-btn active" data-tab="add">
    <span class="tab-icon">âœï¸</span> è¨˜å¸³
  </button>
  <button class="tab-btn" data-tab="list">
    <span class="tab-icon">ğŸ“‹</span> æ˜ç´°
  </button>
  <button class="tab-btn" data-tab="stats">
    <span class="tab-icon">ğŸ“Š</span> çµ±è¨ˆ
  </button>
  <button class="tab-btn" data-tab="report">
    <span class="tab-icon">ğŸ“„</span> å ±è¡¨
  </button>
  <button class="tab-btn" data-tab="settings">
    <span class="tab-icon">âš™ï¸</span> è¨­å®š
  </button>
</nav>

<!-- ==================== ä¸»å…§å®¹å€ ==================== -->
<main class="main-content">

  <!-- ===== è¨˜å¸³é  ===== -->
  <div class="tab-panel active" id="tab-add">
    <div class="card">
      <div class="card-header">
        <span class="card-title">æ–°å¢è²»ç”¨</span>
        <span class="card-badge">NEW ENTRY</span>
      </div>

      <!-- ç¯„æœ¬å¿«é¸ + æ‰¹æ¬¡æ¨¡å¼ -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <div class="custom-select" id="templateSelect" style="flex:1;min-width:180px">
          <div class="custom-select-trigger" onclick="toggleCustomSelect('templateSelect')" style="padding:8px 12px;font-size:13px">
            <span style="margin-right:4px">ğŸ“‹</span>
            <span class="placeholder">å¾ç¯„æœ¬å¿«é€Ÿå¸¶å…¥...</span>
          </div>
          <div class="custom-select-dropdown" id="templateDropdown" style="min-width:280px">
            <div id="templateOptions">
              <!-- å‹•æ…‹ç”¢ç”Ÿ -->
            </div>
            <div class="custom-select-empty" id="templateEmpty" style="display:none">å°šç„¡ç¯„æœ¬ï¼Œå„²å­˜è²»ç”¨å¾Œå¯å»ºç«‹ç¯„æœ¬</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);white-space:nowrap">
          <div class="toggle" id="toggleBatchMode" onclick="toggleBatchMode()" style="width:36px;height:20px"></div>
          <span>æ‰¹æ¬¡æ¨¡å¼</span>
        </div>
      </div>

      <form id="expenseForm">
        <!-- æ—¥æœŸ -->
        <div class="form-group">
          <label class="form-label">æ—¥æœŸ <span class="required">*</span></label>
          <input type="date" class="form-input" id="expDate" required>
        </div>

        <!-- é‡‘é¡ -->
        <div class="form-group">
          <label class="form-label">é‡‘é¡ï¼ˆå«ç¨…ï¼‰ <span class="required">*</span></label>
          <div class="amount-input-wrap">
            <span class="currency">NTD</span>
            <input type="number" class="form-input" id="expAmount" placeholder="0" min="0" step="1" required inputmode="numeric"
              oninput="updateAmountPreview()">
          </div>
          <div class="amount-preview" id="amountPreview"></div>
        </div>

        <!-- ç¨…é¡èˆ‡æœªç¨…ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç¨…é¡ï¼ˆ5%ï¼‰</label>
            <div class="amount-input-wrap">
              <span class="currency">NTD</span>
              <input type="number" class="form-input" id="expTax" placeholder="è‡ªå‹•" step="1">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">æœªç¨…é‡‘é¡</label>
            <div class="amount-input-wrap">
              <span class="currency">NTD</span>
              <input type="number" class="form-input" id="expNet" placeholder="è‡ªå‹•" step="1">
            </div>
          </div>
        </div>

        <!-- è²»ç”¨åˆ†é¡ï¼ˆè‡ªè¨‚æ·±è‰²ä¸‹æ‹‰ï¼‰ -->
        <div class="form-group">
          <label class="form-label">è²»ç”¨åˆ†é¡ <span class="required">*</span></label>
          <input type="hidden" id="expCategory" required>
          <div class="custom-select" id="categorySelect">
            <div class="custom-select-trigger" onclick="toggleCustomSelect('categorySelect')">
              <span class="placeholder">é¸æ“‡è²»ç”¨ç§‘ç›®...</span>
            </div>
            <div class="custom-select-dropdown" id="categoryDropdown">
              <div id="categoryOptions">
                <!-- å‹•æ…‹ç”¢ç”Ÿ -->
              </div>
            </div>
          </div>
        </div>

        <!-- ç™¼ç¥¨è³‡è¨Š -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç™¼ç¥¨è™Ÿç¢¼</label>
            <input type="text" class="form-input" id="expInvoice" placeholder="AB-12345678" maxlength="11"
              style="font-family: var(--font-en); letter-spacing: 0.05em; text-transform: uppercase;"
              oninput="formatInvoiceNumber(this)" onblur="validateInvoiceNumber(this)">
          </div>
          <div class="form-group">
            <label class="form-label">ç™¼ç¥¨é¡å‹</label>
            <select class="form-select" id="expInvoiceType">
              <option value="é›»å­ç™¼ç¥¨">é›»å­ç™¼ç¥¨</option>
              <option value="ç´™æœ¬ç™¼ç¥¨">ç´™æœ¬ç™¼ç¥¨</option>
              <option value="æ”¶æ“š">æ”¶æ“š</option>
              <option value="ç„¡">ç„¡</option>
            </select>
          </div>
        </div>

        <!-- ä»˜æ¬¾æ–¹å¼èˆ‡å» å•† -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ä»˜æ¬¾æ–¹å¼ <span class="required">*</span></label>
            <select class="form-select" id="expPayment" required>
              <option value="è½‰å¸³">è½‰å¸³</option>
              <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="Line Pay">Line Pay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">å» å•†/å°è±¡</label>
            <input type="hidden" id="expVendor">
            <div class="custom-select" id="vendorSelect">
              <div class="custom-select-trigger vendor-select-trigger" onclick="toggleCustomSelect('vendorSelect')">
                <span class="placeholder">æœå°‹æˆ–æ–°å¢å» å•†...</span>
              </div>
              <div class="custom-select-dropdown has-search" id="vendorDropdown">
                <div class="custom-select-search">
                  <input type="text" id="vendorSearchInput" placeholder="ğŸ” è¼¸å…¥å» å•†åç¨±..." oninput="filterVendorOptions(this.value)">
                </div>
                <div id="vendorOptions">
                  <!-- å‹•æ…‹ç”¢ç”Ÿ -->
                </div>
                <div class="custom-select-footer">
                  <button type="button" onclick="addNewVendorFromSearch()">ï¼‹ æ–°å¢ç‚ºå¸¸ç”¨å» å•†</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å‚™è¨» -->
        <div class="form-group">
          <label class="form-label">å‚™è¨»</label>
          <textarea class="form-textarea" id="expNote" placeholder="è£œå……èªªæ˜..." rows="2"></textarea>
        </div>

        <!-- ç™¼ç¥¨æƒæ / ç…§ç‰‡ä¸Šå‚³ -->
        <div class="form-group">
          <label class="form-label">ç™¼ç¥¨ / æ”¶æ“š</label>
          <div class="photo-upload" id="photoUpload">
            <input type="file" id="photoFile" accept="image/*" capture="environment">
            <div class="photo-upload-icon">ğŸ“·</div>
            <div class="photo-upload-text">
              <strong>æ‹ç…§æƒæç™¼ç¥¨</strong>ï¼Œè‡ªå‹•è¾¨è­˜å¸¶å…¥<br>
              <span style="font-size: 11px; color: var(--text-dim);">æ”¯æ´çµ±ä¸€ç™¼ç¥¨ã€é›»å­ç™¼ç¥¨ã€æ”¶æ“š Â· ä¹Ÿå¯é¸æ“‡æª”æ¡ˆ</span>
            </div>
          </div>
          <div class="photo-preview" id="photoPreview">
            <img id="previewImg" src="" alt="é è¦½">
            <button type="button" class="remove-btn" onclick="removePhoto()">âœ•</button>
            <div class="ocr-status" id="ocrStatus" style="display:none">
              <div class="loading-spinner"></div>
              <div style="flex:1;display:flex;flex-direction:column;gap:4px">
                <span class="ocr-status-text" id="ocrStatusText">æ­£åœ¨è¾¨è­˜ç™¼ç¥¨...</span>
                <div class="ocr-progress"><div class="ocr-progress-bar" id="ocrProgressBar"></div></div>
              </div>
            </div>
          </div>
          <div class="ocr-result" id="ocrResult" style="display:none">
            <div class="ocr-result-header">
              <span>ğŸ¤– è¾¨è­˜çµæœ</span>
              <button type="button" class="btn btn-sm btn-secondary" onclick="applyOcrResult()">å¥—ç”¨å…¨éƒ¨</button>
            </div>
            <div class="ocr-fields" id="ocrFields">
              <!-- å‹•æ…‹å¡«å…¥è¾¨è­˜çµæœ -->
            </div>
          </div>
        </div>

        <!-- é€å‡ºæŒ‰éˆ• -->
        <button type="submit" class="btn btn-primary" id="submitBtn">
          ğŸ’¾ å„²å­˜é€™ç­†è²»ç”¨
        </button>
        <div style="display:flex;justify-content:center;margin-top:8px">
          <button type="button" class="btn btn-sm" style="background:none;color:var(--text-dim);font-size:12px" onclick="saveAsTemplate()">
            â­ å„²å­˜ç‚ºå¸¸ç”¨ç¯„æœ¬
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== æ˜ç´°é  ===== -->
  <div class="tab-panel" id="tab-list">
    <div class="filter-bar">
      <div class="month-picker">
        <button onclick="changeMonth(-1)">â—€</button>
        <span class="current-month" id="listMonth"></span>
        <button onclick="changeMonth(1)">â–¶</button>
      </div>
      <div style="flex:1"></div>
      <span id="listCount" style="font-size:12px;color:var(--text-secondary)"></span>
    </div>

    <div class="card" style="padding:12px 20px">
      <div class="search-bar">
        <input type="text" id="listSearch" placeholder="æœå°‹é—œéµå­—ï¼ˆç§‘ç›®ã€å» å•†ã€å‚™è¨»ã€ç™¼ç¥¨ï¼‰" oninput="renderExpenseList()">
        <select id="listFilterPayment" onchange="renderExpenseList()">
          <option value="">å…¨éƒ¨ä»˜æ¬¾æ–¹å¼</option>
          <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
          <option value="ç¾é‡‘">ç¾é‡‘</option>
          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
          <option value="é›»å­æ”¯ä»˜">é›»å­æ”¯ä»˜</option>
        </select>
      </div>
      <ul class="expense-list" id="expenseList">
        <!-- å‹•æ…‹è¼‰å…¥ -->
      </ul>
      <div class="empty-state" id="listEmpty" style="display:none;">
        <div class="empty-state-icon">ğŸ“­</div>
        <div class="empty-state-text">é€™å€‹æœˆé‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„</div>
        <button class="btn btn-secondary btn-sm" onclick="switchTab('add')">æ–°å¢ç¬¬ä¸€ç­†</button>
      </div>
    </div>
  </div>

  <!-- ===== çµ±è¨ˆé  ===== -->
  <div class="tab-panel" id="tab-stats">
    <div class="filter-bar">
      <div class="month-picker">
        <button onclick="changeStatsMonth(-1)">â—€</button>
        <span class="current-month" id="statsMonth"></span>
        <button onclick="changeStatsMonth(1)">â–¶</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card wide">
        <div class="stat-label">æœ¬æœˆç¸½æ”¯å‡º</div>
        <div class="stat-value" id="statTotal">$0 <span class="unit">NTD</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è¨˜å¸³ç­†æ•¸</div>
        <div class="stat-value" id="statCount">0 <span class="unit">ç­†</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å¹³å‡æ¯ç­†</div>
        <div class="stat-value" id="statAvg">$0 <span class="unit">NTD</span></div>
      </div>
    </div>

    <!-- é ç®—é€²åº¦ -->
    <div class="card" id="budgetCard" style="display:none">
      <div class="card-header">
        <span class="card-title">é ç®—é€²åº¦</span>
        <span class="card-badge" id="budgetBadge">ON TRACK</span>
      </div>
      <div id="budgetBars">
        <!-- å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">åˆ†é¡ä½”æ¯”</span>
      </div>
      <div class="bar-chart" id="categoryChart">
        <!-- å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">ä»˜æ¬¾æ–¹å¼åˆ†å¸ƒ</span>
      </div>
      <div class="bar-chart" id="paymentChart">
        <!-- å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">å¹´åº¦æœˆè¶¨å‹¢</span>
        <span class="card-badge" id="trendYear"></span>
      </div>
      <div class="trend-chart" id="trendChart">
        <!-- å‹•æ…‹ç”¢ç”Ÿ -->
      </div>
      <div class="trend-summary" id="trendSummary"></div>
    </div>
  </div>

  <!-- ===== å ±è¡¨é  ===== -->
  <div class="tab-panel" id="tab-report">
    <div class="card">
      <div class="card-header">
        <span class="card-title">æœˆå ±åŒ¯å‡º</span>
        <span class="card-badge">REPORT</span>
      </div>

      <div class="form-row" style="margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">å¹´ä»½</label>
          <select class="form-select" id="reportYear"></select>
        </div>
        <div class="form-group">
          <label class="form-label">æœˆä»½</label>
          <select class="form-select" id="reportMonth">
            <option value="1">1 æœˆ</option><option value="2">2 æœˆ</option>
            <option value="3">3 æœˆ</option><option value="4">4 æœˆ</option>
            <option value="5">5 æœˆ</option><option value="6">6 æœˆ</option>
            <option value="7">7 æœˆ</option><option value="8">8 æœˆ</option>
            <option value="9">9 æœˆ</option><option value="10">10 æœˆ</option>
            <option value="11">11 æœˆ</option><option value="12">12 æœˆ</option>
          </select>
        </div>
      </div>

      <div class="report-actions">
        <button class="btn btn-primary" onclick="generatePDF()" style="flex:1">
          ğŸ“„ ç”¢å‡º PDF å ±è¡¨
        </button>
        <button class="btn btn-secondary" onclick="exportCSV()" style="flex:1">
          ğŸ“Š åŒ¯å‡º CSV
        </button>
      </div>
      <div style="margin-top:8px">
        <button class="btn btn-secondary" onclick="exportAccountingCSV()" style="width:100%;background:rgba(20,93,221,0.15);border-color:var(--blue)">
          ğŸ§¾ åŒ¯å‡ºæœƒè¨ˆå‚³ç¥¨æ ¼å¼
        </button>
      </div>
    </div>

    <!-- å ±è¡¨é è¦½ -->
    <div class="card" id="reportPreview" style="display:none">
      <div class="card-header">
        <span class="card-title">å ±è¡¨é è¦½</span>
      </div>

      <div class="report-section">
        <div class="report-section-title">Summary</div>
        <div class="stats-grid" style="margin-bottom:0">
          <div class="stat-card">
            <div class="stat-label">ç¸½æ”¯å‡º</div>
            <div class="stat-value" id="rptTotal" style="font-size:18px"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ç¸½ç¨…é¡</div>
            <div class="stat-value" id="rptTax" style="font-size:18px"></div>
          </div>
        </div>
      </div>

      <div class="report-section">
        <div class="report-section-title">By Category</div>
        <table class="report-table" id="rptCatTable">
          <thead>
            <tr><th>åˆ†é¡</th><th>ç­†æ•¸</th><th>é‡‘é¡</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="report-section">
        <div class="report-section-title">Detail</div>
        <table class="report-table" id="rptDetailTable">
          <thead>
            <tr><th>æ—¥æœŸ</th><th>ç§‘ç›®</th><th>å» å•†</th><th>é‡‘é¡</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== è¨­å®šé  ===== -->
  <div class="tab-panel" id="tab-settings">
    <div class="card">
      <div class="card-header">
        <span class="card-title">ç³»çµ±è¨­å®š</span>
        <span class="card-badge">CONFIG</span>
      </div>

      <div class="form-group">
        <label class="form-label">è¨˜å¸³äººå“¡åç¨± <span class="required">*</span></label>
        <input type="text" class="form-input" id="settingRecorder" placeholder="ä¾‹å¦‚ï¼šAngusã€å°ç¾" maxlength="20"
          style="font-size:15px;font-weight:600">
        <div style="font-size:11px;color:var(--text-dim);margin-top:4px">
          æ¯ç­†è²»ç”¨æœƒè‡ªå‹•æ¨™è¨»è¨˜å¸³äººå“¡ï¼Œæ–¹ä¾¿åœ˜éšŠè¾¨è­˜
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Google Apps Script URL</label>
        <input type="url" class="form-input" id="settingApiUrl" placeholder="https://script.google.com/macros/s/...">
        <div style="font-size:11px;color:var(--text-dim);margin-top:4px">
          éƒ¨ç½² Apps Script å¾Œå–å¾—çš„ Web App URL
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-secondary" onclick="saveSettings()" style="flex:1">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <button class="btn btn-outline" onclick="testConnection()" style="flex:1">ğŸ”— æ¸¬è©¦é€£ç·š</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">è³‡æ–™ç®¡ç†</span>
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-label">è‡ªå‹•è¨ˆç®—ç¨…é¡</div>
          <div class="setting-desc">è¼¸å…¥å«ç¨…é‡‘é¡æ™‚è‡ªå‹•è¨ˆç®— 5% ç‡Ÿæ¥­ç¨…</div>
        </div>
        <div class="toggle active" id="toggleAutoTax" onclick="toggleSetting('autoTax')"></div>
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-label">é›¢ç·šå¿«å–</div>
          <div class="setting-desc">æ–·ç·šæ™‚å…ˆå­˜åˆ°æœ¬æ©Ÿï¼Œé€£ç·šå¾Œè‡ªå‹•åŒæ­¥</div>
        </div>
        <div class="toggle active" id="toggleOffline" onclick="toggleSetting('offline')"></div>
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-label">æ‰¹æ¬¡è¨˜å¸³æ¨¡å¼</div>
          <div class="setting-desc">é€å‡ºå¾Œä¿ç•™åˆ†é¡ã€ä»˜æ¬¾æ–¹å¼ï¼Œåƒ…æ¸…ç©ºé‡‘é¡èˆ‡ç™¼ç¥¨</div>
        </div>
        <div class="toggle" id="toggleBatch" onclick="toggleSetting('batchMode')"></div>
      </div>

      <div class="btn-group">
        <button class="btn btn-outline btn-sm" onclick="syncToCloud()" style="flex:1">â˜ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
        <button class="btn btn-outline btn-sm" onclick="pullExpensesFromCloud()" style="flex:1">â¬‡ï¸ å¾é›²ç«¯åŒ¯å…¥</button>
      </div>
      <div style="margin-top:8px">
        <button class="btn btn-danger btn-sm" onclick="confirmClearLocal()" style="width:100%">ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°å¿«å–</button>
      </div>

      <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
        <div style="font-size:12px;color:var(--text-dim)">
          æœ¬åœ°ç´€éŒ„ï¼š<span id="localCount">0</span> ç­† Â·
          å¾…åŒæ­¥ï¼š<span id="pendingCount">0</span> ç­†
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">æœˆåº¦é ç®—è¨­å®š</span>
        <span class="card-badge">BUDGET</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
        ç‚ºå„å¤§é¡è¨­å®šæ¯æœˆé ç®—ä¸Šé™ï¼Œè¶…æ”¯æ™‚æœƒåœ¨çµ±è¨ˆé é¡¯ç¤ºè­¦ç¤º
      </div>
      <div id="budgetSettings">
        <div class="form-row" style="margin-bottom:8px">
          <div class="form-group" style="margin-bottom:8px">
            <label class="form-label" style="font-size:12px">ğŸª éŠ·å”®è²»ç”¨</label>
            <div class="amount-input-wrap">
              <span class="currency" style="font-size:11px">NTD</span>
              <input type="number" class="form-input" id="budget_sales" placeholder="ä¸é™" style="font-size:14px;padding-left:42px" min="0">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:8px">
            <label class="form-label" style="font-size:12px">ğŸ“‹ ç®¡ç†è²»ç”¨</label>
            <div class="amount-input-wrap">
              <span class="currency" style="font-size:11px">NTD</span>
              <input type="number" class="form-input" id="budget_admin" placeholder="ä¸é™" style="font-size:14px;padding-left:42px" min="0">
            </div>
          </div>
        </div>
        <div class="form-row" style="margin-bottom:8px">
          <div class="form-group" style="margin-bottom:8px">
            <label class="form-label" style="font-size:12px">ğŸ¢ ç‡Ÿæ¥­è²»ç”¨</label>
            <div class="amount-input-wrap">
              <span class="currency" style="font-size:11px">NTD</span>
              <input type="number" class="form-input" id="budget_ops" placeholder="ä¸é™" style="font-size:14px;padding-left:42px" min="0">
            </div>
          </div>
          <div class="form-group" style="margin-bottom:8px">
            <label class="form-label" style="font-size:12px">ğŸ›ï¸ ç¨…å‹™è²»ç”¨</label>
            <div class="amount-input-wrap">
              <span class="currency" style="font-size:11px">NTD</span>
              <input type="number" class="form-input" id="budget_tax" placeholder="ä¸é™" style="font-size:14px;padding-left:42px" min="0">
            </div>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:8px">
          <label class="form-label" style="font-size:12px">ğŸ’° æ¯æœˆç¸½é ç®—</label>
          <div class="amount-input-wrap">
            <span class="currency" style="font-size:11px">NTD</span>
            <input type="number" class="form-input" id="budget_total" placeholder="ä¸é™" style="font-size:14px;padding-left:42px" min="0">
          </div>
        </div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="saveBudgets()" style="width:100%;margin-top:4px">ğŸ’¾ å„²å­˜é ç®—è¨­å®š</button>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">æœˆå ±è‡ªå‹•å¯„é€</span>
        <span class="card-badge">EMAIL</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
        è¨­å®šå¾Œé€é Apps Script æ¯æœˆ 1 è™Ÿè‡ªå‹•å¯„å‡ºä¸Šæœˆè²»ç”¨å ±è¡¨
      </div>
      <div class="form-group">
        <label class="form-label">æ”¶ä»¶äºº Email</label>
        <input type="email" class="form-input" id="settingReportEmail" placeholder="accountant@example.com" style="font-size:13px">
      </div>
      <div class="setting-item" style="border-bottom:none;padding-bottom:0">
        <div>
          <div class="setting-label">å•Ÿç”¨è‡ªå‹•å¯„é€</div>
          <div class="setting-desc">æ¯æœˆ 1 è™Ÿå¯„å‡ºä¸Šæœˆ PDF å ±è¡¨</div>
        </div>
        <div class="toggle" id="toggleAutoReport" onclick="toggleSetting('autoReport')"></div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="setupAutoReport()" style="width:100%;margin-top:8px">âš™ï¸ éƒ¨ç½²åˆ° Apps Script</button>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">å¸¸ç”¨å» å•†ç®¡ç†</span>
        <span class="card-badge">VENDORS</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
        æ–°å¢å¸¸ç”¨å» å•†ï¼Œè¨˜å¸³æ™‚å¯å¿«é€Ÿæœå°‹é¸å–ã€‚ä¹Ÿå¯å¾ CSV / XLSX æ‰¹æ¬¡åŒ¯å…¥ã€‚
      </div>

      <!-- æ–°å¢å» å•† -->
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input type="text" class="form-input" id="newVendorName" placeholder="å» å•†åç¨±" style="flex:1;font-size:13px;padding:8px 10px">
        <input type="text" class="form-input" id="newVendorNote" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰" style="flex:1;font-size:13px;padding:8px 10px">
        <button class="btn btn-secondary btn-sm" onclick="addVendor()">ï¼‹ æ–°å¢</button>
      </div>

      <!-- åŒ¯å…¥ & é›²ç«¯åŒæ­¥ -->
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;flex-wrap:wrap">
        <label class="btn btn-outline btn-sm" style="cursor:pointer;margin:0">
          ğŸ“‚ åŒ¯å…¥ CSV/XLSX
          <input type="file" id="vendorImportFile" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleVendorImport(event)">
        </label>
        <button class="btn btn-outline btn-sm" onclick="syncVendorsToCloud()">â˜ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
        <button class="btn btn-outline btn-sm" onclick="pullVendorsFromCloud()">â¬‡ï¸ å¾é›²ç«¯åŒ¯å…¥</button>
        <span style="font-size:11px;color:var(--text-dim);width:100%">æ ¼å¼ï¼šç¬¬ä¸€æ¬„å» å•†åç¨±ï¼Œç¬¬äºŒæ¬„å‚™è¨»ï¼ˆé¸å¡«ï¼‰</span>
      </div>

      <!-- å» å•†åˆ—è¡¨ -->
      <div id="vendorList" style="font-size:13px;max-height:300px;overflow-y:auto">
        <!-- å‹•æ…‹è¼‰å…¥ -->
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">æœƒè¨ˆç§‘ç›®ç®¡ç†</span>
      </div>
      <div id="categoryList" style="font-size:13px">
        <!-- å‹•æ…‹è¼‰å…¥ -->
      </div>
    </div>
  </div>
</main>

<!-- ==================== è©³æƒ… Modal ==================== -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="modalContent">
      <!-- å‹•æ…‹å¡«å…¥ -->
    </div>
  </div>
</div>

<!-- ==================== Toast å®¹å™¨ ==================== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ==================== jsPDF CDN ==================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<!-- ==================== Tesseract.js OCR ==================== -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- ==================== SheetJS (XLSX è§£æ) ==================== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// ==================== å…¨åŸŸè¨­å®š ====================
const APP_CONFIG = {
  STORAGE_KEY: 'outrun_expenses',
  SETTINGS_KEY: 'outrun_settings',
  PENDING_KEY: 'outrun_pending_sync',
  VENDORS_KEY: 'outrun_vendors',
};

// é è¨­æœƒè¨ˆç§‘ç›®
const DEFAULT_CATEGORIES = [
  { code: '6201', name: 'é‹è²»', parent: 'éŠ·å”®è²»ç”¨', desc: 'ç‰©æµé…é€ã€åŒ…æè²»ç”¨', icon: 'ğŸšš' },
  { code: '6202', name: 'å»£å‘Šè¡ŒéŠ·è²»', parent: 'éŠ·å”®è²»ç”¨', desc: 'å»£å‘ŠæŠ•æ”¾ã€KOLåˆä½œ', icon: 'ğŸ“£' },
  { code: '6203', name: 'å¹³å°æ‰‹çºŒè²»', parent: 'éŠ·å”®è²»ç”¨', desc: 'è¦çš®ã€Cyberbiz æ‰‹çºŒè²»', icon: 'ğŸª' },
  { code: '6204', name: 'åŒ…è£è²»', parent: 'éŠ·å”®è²»ç”¨', desc: 'å•†å“åŒ…è£ã€ç¦®ç›’ææ–™', icon: 'ğŸ“¦' },
  { code: '6205', name: 'å±•æœƒæ´»å‹•è²»', parent: 'éŠ·å”®è²»ç”¨', desc: 'è·¯è·‘è´ŠåŠ©ã€å±•è¦½æ”¤ä½', icon: 'ğŸƒ' },
  { code: '6301', name: 'æ–‡å…·äº‹å‹™ç”¨å“', parent: 'ç®¡ç†è²»ç”¨', desc: 'è¾¦å…¬æ–‡å…·ã€è€—æ', icon: 'ğŸ“' },
  { code: '6302', name: 'éƒµé›»è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'é›»è©±è²»ã€ç¶²è·¯è²»', icon: 'ğŸ“' },
  { code: '6303', name: 'æ—…è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'å‡ºå·®äº¤é€šã€ä½å®¿', icon: 'âœˆï¸' },
  { code: '6304', name: 'é¤è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'æ¥­å‹™é¤è²»ã€æœƒè­°é¤é»', icon: 'ğŸ±' },
  { code: '6305', name: 'äº¤éš›è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'å®¢æˆ¶æ‹›å¾…ã€ä¼´æ‰‹ç¦®', icon: 'ğŸ¤' },
  { code: '6306', name: 'é›œè²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'é›¶æ˜Ÿæ”¯å‡º', icon: 'ğŸ“‹' },
  { code: '6307', name: 'è»Ÿé«”è¨‚é–±è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'SaaS å·¥å…·æœˆè²»', icon: 'ğŸ’»' },
  { code: '6308', name: 'å¤–åŒ…æœå‹™è²»', parent: 'ç®¡ç†è²»ç”¨', desc: 'è¨­è¨ˆã€æ”å½±å¤–åŒ…', icon: 'ğŸ¨' },
  { code: '6101', name: 'è–ªè³‡æ”¯å‡º', parent: 'ç‡Ÿæ¥­è²»ç”¨', desc: 'å“¡å·¥è–ªè³‡ã€çé‡‘', icon: 'ğŸ’°' },
  { code: '6102', name: 'ç§Ÿé‡‘æ”¯å‡º', parent: 'ç‡Ÿæ¥­è²»ç”¨', desc: 'è¾¦å…¬å®¤ã€å€‰åº«ç§Ÿé‡‘', icon: 'ğŸ¢' },
  { code: '6103', name: 'æ°´é›»ç“¦æ–¯è²»', parent: 'ç‡Ÿæ¥­è²»ç”¨', desc: 'è¾¦å…¬å®¤æ°´é›»è²»', icon: 'ğŸ’¡' },
  { code: '6104', name: 'ä¿éšªè²»', parent: 'ç‡Ÿæ¥­è²»ç”¨', desc: 'å‹å¥ä¿ã€å•†æ¥­ä¿éšª', icon: 'ğŸ›¡ï¸' },
  { code: '6105', name: 'ä¿®ç¹•è²»', parent: 'ç‡Ÿæ¥­è²»ç”¨', desc: 'è¨­å‚™ç¶­ä¿®ä¿é¤Š', icon: 'ğŸ”§' },
  { code: '6401', name: 'ç¨…æ', parent: 'ç¨…å‹™è²»ç”¨', desc: 'ç‡Ÿæ¥­ç¨…ã€ç‡Ÿæ‰€ç¨…', icon: 'ğŸ›ï¸' },
  { code: '6402', name: 'è¦è²»', parent: 'ç¨…å‹™è²»ç”¨', desc: 'æ”¿åºœè¦è²»ã€è­‰ç…§è²»', icon: 'ğŸ“œ' },
];

// é è¨­å¸¸ç”¨å» å•†ï¼ˆåˆå§‹å€¼ï¼Œä½¿ç”¨è€…å¯è‡ªè¡Œæ–°å¢/åŒ¯å…¥ï¼‰
const DEFAULT_VENDORS = [
  { name: 'é»‘è²“å®…æ€¥ä¾¿', note: 'ç‰©æµ' },
  { name: 'æ–°ç«¹ç‰©æµ', note: 'ç‰©æµ' },
  { name: '7-ELEVEN äº¤è²¨ä¾¿', note: 'ç‰©æµ' },
  { name: 'å…¨å®¶åº—åˆ°åº—', note: 'ç‰©æµ' },
  { name: 'è¦çš®è³¼ç‰©', note: 'å¹³å°' },
  { name: 'Cyberbiz', note: 'å¹³å°' },
  { name: 'Google', note: 'å»£å‘Š/è»Ÿé«”' },
  { name: 'Meta (Facebook)', note: 'å»£å‘Š' },
  { name: 'OpenAI / ChatGPT', note: 'è»Ÿé«”' },
  { name: 'Anthropic / Claude', note: 'è»Ÿé«”' },
];

// ==================== ç‹€æ…‹ç®¡ç† ====================
let state = {
  expenses: [],
  pendingSync: [],
  currentMonth: new Date(),
  statsMonth: new Date(),
  settings: {
    apiUrl: '',
    autoTax: true,
    offline: true,
  },
  selectedPhoto: null,
  photoBase64: null,
  ocrResult: null,
  ocrFields: null,
  vendors: [],
};

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  loadExpenses();
  loadVendors();
  initForm();
  initTabs();
  initMonthPickers();
  renderCategorySelect();
  renderVendorSelect();
  renderTemplateSelect();
  renderCategoryList();
  renderVendorList();
  loadBudgetUI();
  updateSyncStatus();
  refreshAllViews();
  initClickOutside();
  // åŒæ­¥æ‰¹æ¬¡æ¨¡å¼ toggle ç‹€æ…‹
  updateToggle('toggleBatchMode', state.settings.batchMode || false);
  updateToggle('toggleBatch', state.settings.batchMode || false);
  // æœˆå ± email
  const emailEl = document.getElementById('settingReportEmail');
  if (emailEl && state.settings.reportEmail) emailEl.value = state.settings.reportEmail;
  updateToggle('toggleAutoReport', state.settings.autoReport || false);

  // é¦–æ¬¡ä½¿ç”¨æç¤ºè¨­å®šè¨˜å¸³äººå“¡åç¨±
  if (!state.settings.recorder) {
    setTimeout(() => {
      const name = prompt('æ­¡è¿ä½¿ç”¨å …å¿ƒè¨˜å¸³ï¼\n\nè«‹è¼¸å…¥ä½ çš„åç¨±ï¼ˆç”¨æ–¼æ¨™è¨»æ¯ç­†ç´€éŒ„ï¼‰ï¼š');
      if (name && name.trim()) {
        state.settings.recorder = name.trim();
        document.getElementById('settingRecorder').value = name.trim();
        localStorage.setItem(APP_CONFIG.SETTINGS_KEY, JSON.stringify(state.settings));
        showToast(`å—¨ ${name.trim()}ï¼è¨˜å¸³äººå“¡å·²è¨­å®š`, 'success');
      }
    }, 500);
  }
});

function loadSettings() {
  const saved = localStorage.getItem(APP_CONFIG.SETTINGS_KEY);
  if (saved) {
    state.settings = { ...state.settings, ...JSON.parse(saved) };
  }
  document.getElementById('settingRecorder').value = state.settings.recorder || '';
  document.getElementById('settingApiUrl').value = state.settings.apiUrl || '';
  updateToggle('toggleAutoTax', state.settings.autoTax);
  updateToggle('toggleOffline', state.settings.offline);
}

function loadExpenses() {
  const saved = localStorage.getItem(APP_CONFIG.STORAGE_KEY);
  state.expenses = saved ? JSON.parse(saved) : [];

  const pending = localStorage.getItem(APP_CONFIG.PENDING_KEY);
  state.pendingSync = pending ? JSON.parse(pending) : [];

  updateLocalCount();
}

function saveExpenses() {
  localStorage.setItem(APP_CONFIG.STORAGE_KEY, JSON.stringify(state.expenses));
  updateLocalCount();
}

function saveSettings() {
  state.settings.recorder = document.getElementById('settingRecorder').value.trim();
  state.settings.apiUrl = document.getElementById('settingApiUrl').value.trim();
  localStorage.setItem(APP_CONFIG.SETTINGS_KEY, JSON.stringify(state.settings));
  showToast('è¨­å®šå·²å„²å­˜', 'success');
  updateSyncStatus();
}

// ==================== åˆ†é å°è¦½ ====================
function initTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
  if (tab === 'list') renderExpenseList();
  if (tab === 'stats') renderStats();
  if (tab === 'report') initReportPage();
}

// ==================== è¡¨å–®åˆå§‹åŒ– ====================
function initForm() {
  // è¨­å®šä»Šå¤©æ—¥æœŸ
  document.getElementById('expDate').value = formatDate(new Date());

  // é‡‘é¡è‡ªå‹•è¨ˆç®—ç¨…é¡
  document.getElementById('expAmount').addEventListener('input', (e) => {
    if (state.settings.autoTax) {
      const total = Number(e.target.value) || 0;
      const tax = Math.round(total - total / 1.05);
      const net = total - tax;
      document.getElementById('expTax').value = tax || '';
      document.getElementById('expNet').value = net || '';
    }
  });

  // ç…§ç‰‡ä¸Šå‚³
  document.getElementById('photoFile').addEventListener('change', handlePhotoSelect);

  // Drag & Drop
  const dropZone = document.getElementById('photoUpload');
  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });

  // è¡¨å–®é€å‡º
  document.getElementById('expenseForm').addEventListener('submit', handleSubmit);
}

// ==================== è‡ªè¨‚ä¸‹æ‹‰é¸å–®ç³»çµ± ====================

// å…¨åŸŸï¼šé»æ“Šå¤–éƒ¨é—œé–‰æ‰€æœ‰ä¸‹æ‹‰
function initClickOutside() {
  document.addEventListener('click', (e) => {
    document.querySelectorAll('.custom-select.open').forEach(sel => {
      if (!sel.contains(e.target)) {
        sel.classList.remove('open');
      }
    });
  });
}

function toggleCustomSelect(id) {
  const sel = document.getElementById(id);
  const isOpen = sel.classList.contains('open');

  // å…ˆé—œé–‰å…¶ä»–
  document.querySelectorAll('.custom-select.open').forEach(s => {
    if (s.id !== id) s.classList.remove('open');
  });

  sel.classList.toggle('open', !isOpen);

  // é–‹å•Ÿæ™‚è‡ªå‹• focus åˆ°æœå°‹æ¡†
  if (!isOpen) {
    const searchInput = sel.querySelector('.custom-select-search input');
    if (searchInput) setTimeout(() => searchInput.focus(), 50);
  }
}

// ---- è²»ç”¨åˆ†é¡é¸å–® ----
function renderCategorySelect() {
  const parentIcons = { 'éŠ·å”®è²»ç”¨': 'ğŸª', 'ç®¡ç†è²»ç”¨': 'ğŸ“‹', 'ç‡Ÿæ¥­è²»ç”¨': 'ğŸ¢', 'ç¨…å‹™è²»ç”¨': 'ğŸ›ï¸' };

  const groups = {};
  DEFAULT_CATEGORIES.forEach(cat => {
    if (!groups[cat.parent]) groups[cat.parent] = [];
    groups[cat.parent].push(cat);
  });

  let html = '';
  for (const [parent, cats] of Object.entries(groups)) {
    const icon = parentIcons[parent] || '';
    html += `<div class="custom-select-group-label">${icon} ${parent}</div>`;
    cats.forEach(cat => {
      html += `
        <div class="custom-select-option" data-value="${cat.code}" data-name="${cat.name}" data-parent="${cat.parent}" data-search="${cat.name}${cat.code}${cat.parent}${cat.desc}" onclick="selectCategory('${cat.code}')">
          <span class="option-icon">${cat.icon}</span>
          <span>${cat.name}</span>
          <span class="option-code">${cat.code}</span>
        </div>`;
    });
  }

  document.getElementById('categoryOptions').innerHTML = html;
}

function selectCategory(code) {
  const cat = DEFAULT_CATEGORIES.find(c => c.code === code);
  if (!cat) return;

  document.getElementById('expCategory').value = code;

  const trigger = document.querySelector('#categorySelect .custom-select-trigger');
  trigger.innerHTML = `<span class="option-icon">${cat.icon}</span> ${cat.name} <span style="font-family:var(--font-en);font-size:11px;color:var(--text-dim);margin-left:auto">${cat.code}</span>`;

  // æ›´æ–°é¸ä¸­æ¨£å¼
  document.querySelectorAll('#categoryOptions .custom-select-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === code);
  });

  document.getElementById('categorySelect').classList.remove('open');
}

function filterCategoryOptions(keyword) {
  const kw = keyword.toLowerCase().trim();
  const options = document.querySelectorAll('#categoryOptions .custom-select-option');
  const groups = document.querySelectorAll('#categoryOptions .custom-select-group-label');

  if (!kw) {
    options.forEach(o => o.style.display = '');
    groups.forEach(g => g.style.display = '');
    return;
  }

  // å…ˆéš±è—æ‰€æœ‰
  options.forEach(o => {
    const match = o.dataset.search.toLowerCase().includes(kw);
    o.style.display = match ? '' : 'none';
  });

  // å¦‚æœç¾¤çµ„ä¸‹æ‰€æœ‰é¸é …éƒ½éš±è—ï¼Œä¹Ÿéš±è—ç¾¤çµ„æ¨™ç±¤
  groups.forEach(g => {
    let next = g.nextElementSibling;
    let hasVisible = false;
    while (next && !next.classList.contains('custom-select-group-label')) {
      if (next.style.display !== 'none') hasVisible = true;
      next = next.nextElementSibling;
    }
    g.style.display = hasVisible ? '' : 'none';
  });
}

// ---- å» å•†é¸å–® ----
function loadVendors() {
  const saved = localStorage.getItem(APP_CONFIG.VENDORS_KEY);
  if (saved) {
    state.vendors = JSON.parse(saved);
  } else {
    state.vendors = [...DEFAULT_VENDORS];
    saveVendors();
  }
}

function saveVendors() {
  localStorage.setItem(APP_CONFIG.VENDORS_KEY, JSON.stringify(state.vendors));
}

function renderVendorSelect() {
  const container = document.getElementById('vendorOptions');
  if (!container) return;

  if (state.vendors.length === 0) {
    container.innerHTML = '<div class="custom-select-empty">å°šç„¡å¸¸ç”¨å» å•†ï¼Œå¯åœ¨è¨­å®šé æ–°å¢æˆ–åŒ¯å…¥</div>';
    return;
  }

  // ä¾æœ€è¿‘ä½¿ç”¨æ’åºï¼ˆå¦‚æœæœ‰ usedAt æ¬„ä½ï¼‰ï¼Œå¦å‰‡ä¾å­—æ¯
  const sorted = [...state.vendors].sort((a, b) => {
    if (a.usedAt && b.usedAt) return new Date(b.usedAt) - new Date(a.usedAt);
    if (a.usedAt) return -1;
    if (b.usedAt) return 1;
    return a.name.localeCompare(b.name, 'zh-TW');
  });

  container.innerHTML = sorted.map(v => {
    const safeName = v.name.replace(/'/g, "\\'");
    return `
    <div class="custom-select-option vendor-option" data-value="${v.name}" data-search="${v.name}${v.note || ''}">
      <div class="vendor-option-main" onclick="selectVendor('${safeName}')">
        <span>${v.name}</span>
        ${v.note ? `<span class="option-sub">${v.note}</span>` : ''}
      </div>
      <div class="vendor-option-actions">
        <button type="button" class="vendor-action-btn" onclick="event.stopPropagation();editVendorInline('${safeName}')" title="ç·¨è¼¯">âœï¸</button>
        <button type="button" class="vendor-action-btn vendor-action-del" onclick="event.stopPropagation();removeVendorFromDropdown('${safeName}')" title="åˆªé™¤">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function selectVendor(name) {
  document.getElementById('expVendor').value = name;

  const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
  trigger.innerHTML = `<span class="vendor-tag">${name}</span>`;

  // æ›´æ–°æœ€è¿‘ä½¿ç”¨æ™‚é–“
  const vendor = state.vendors.find(v => v.name === name);
  if (vendor) {
    vendor.usedAt = new Date().toISOString();
    saveVendors();
  }

  document.querySelectorAll('#vendorOptions .custom-select-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === name);
  });

  document.getElementById('vendorSelect').classList.remove('open');
}

function filterVendorOptions(keyword) {
  const kw = keyword.toLowerCase().trim();
  const options = document.querySelectorAll('#vendorOptions .custom-select-option');

  if (!kw) {
    options.forEach(o => o.style.display = '');
    return;
  }

  let hasMatch = false;
  options.forEach(o => {
    const match = o.dataset.search.toLowerCase().includes(kw);
    o.style.display = match ? '' : 'none';
    if (match) hasMatch = true;
  });

  // å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œé¡¯ç¤ºå¯æ–°å¢æç¤ºï¼ˆfooter çš„æŒ‰éˆ•æœƒè™•ç†ï¼‰
}

function addNewVendorFromSearch() {
  const input = document.getElementById('vendorSearchInput');
  const name = input.value.trim();
  if (!name) {
    showToast('è«‹è¼¸å…¥å» å•†åç¨±', 'error');
    return;
  }

  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (state.vendors.some(v => v.name === name)) {
    selectVendor(name);
    return;
  }

  // æ–°å¢ä¸¦é¸å–
  state.vendors.push({ name, note: '', usedAt: new Date().toISOString(), createdAt: new Date().toISOString() });
  saveVendors();
  renderVendorSelect();
  renderVendorList();
  selectVendor(name);
  showToast(`å·²æ–°å¢å» å•†ã€Œ${name}ã€`, 'success');
}

// ---- å» å•†è¡Œå…§ç·¨è¼¯/åˆªé™¤ï¼ˆä¸‹æ‹‰é¸å–®å…§ï¼‰ ----
function editVendorInline(name) {
  const vendor = state.vendors.find(v => v.name === name);
  if (!vendor) return;

  // æ‰¾åˆ°å°æ‡‰çš„é¸é …å…ƒç´ æ›¿æ›ç‚ºç·¨è¼¯è¡¨å–®
  const options = document.querySelectorAll('#vendorOptions .vendor-option');
  for (const opt of options) {
    if (opt.dataset.value === name) {
      opt.innerHTML = `
        <div class="vendor-edit-inline">
          <input type="text" id="editVendorName" value="${vendor.name.replace(/"/g, '&quot;')}" placeholder="å» å•†åç¨±">
          <input type="text" id="editVendorNote" value="${(vendor.note || '').replace(/"/g, '&quot;')}" placeholder="å‚™è¨»" style="max-width:100px">
          <button class="vendor-edit-save" onclick="saveVendorEdit('${name.replace(/'/g, "\\'")}')">âœ“</button>
          <button class="vendor-edit-cancel" onclick="cancelVendorEdit()">âœ•</button>
        </div>`;
      opt.classList.add('editing');
      setTimeout(() => {
        const input = document.getElementById('editVendorName');
        if (input) { input.focus(); input.select(); }
      }, 50);
      break;
    }
  }
}

function saveVendorEdit(originalName) {
  const newName = document.getElementById('editVendorName').value.trim();
  const newNote = document.getElementById('editVendorNote').value.trim();

  if (!newName) {
    showToast('å» å•†åç¨±ä¸èƒ½ç‚ºç©º', 'error');
    return;
  }

  // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–å» å•†é‡åï¼ˆæ’é™¤è‡ªå·±ï¼‰
  if (newName !== originalName && state.vendors.some(v => v.name === newName)) {
    showToast('æ­¤å» å•†åç¨±å·²å­˜åœ¨', 'error');
    return;
  }

  const vendor = state.vendors.find(v => v.name === originalName);
  if (vendor) {
    vendor.name = newName;
    vendor.note = newNote;
    saveVendors();
    renderVendorSelect();
    renderVendorList();

    // å¦‚æœç›®å‰è¡¨å–®é¸çš„å°±æ˜¯é€™å€‹å» å•†ï¼Œæ›´æ–°é¡¯ç¤º
    if (document.getElementById('expVendor').value === originalName) {
      document.getElementById('expVendor').value = newName;
      const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
      trigger.innerHTML = `<span class="vendor-tag">${newName}</span>`;
    }

    showToast(`å·²æ›´æ–°å» å•†ã€Œ${newName}ã€`, 'success');
  }
}

function cancelVendorEdit() {
  renderVendorSelect();
}

function removeVendorFromDropdown(name) {
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤å» å•†ã€Œ${name}ã€å—ï¼Ÿ`)) return;

  state.vendors = state.vendors.filter(v => v.name !== name);
  saveVendors();
  renderVendorSelect();
  renderVendorList();

  // å¦‚æœç›®å‰è¡¨å–®é¸çš„å°±æ˜¯é€™å€‹å» å•†ï¼Œæ¸…é™¤
  if (document.getElementById('expVendor').value === name) {
    document.getElementById('expVendor').value = '';
    const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
    trigger.innerHTML = '<span class="placeholder">æœå°‹æˆ–æ–°å¢å» å•†...</span>';
  }

  showToast(`å·²åˆªé™¤å» å•†ã€Œ${name}ã€`, 'success');
}

// ---- å» å•†ç®¡ç†ï¼ˆè¨­å®šé ï¼‰ ----
function addVendor() {
  const nameEl = document.getElementById('newVendorName');
  const noteEl = document.getElementById('newVendorNote');
  const name = nameEl.value.trim();
  const note = noteEl.value.trim();

  if (!name) {
    showToast('è«‹è¼¸å…¥å» å•†åç¨±', 'error');
    return;
  }

  if (state.vendors.some(v => v.name === name)) {
    showToast('æ­¤å» å•†å·²å­˜åœ¨', 'error');
    return;
  }

  state.vendors.push({ name, note, createdAt: new Date().toISOString() });
  saveVendors();
  renderVendorSelect();
  renderVendorList();

  nameEl.value = '';
  noteEl.value = '';
  showToast(`å·²æ–°å¢ã€Œ${name}ã€`, 'success');
}

function removeVendor(name) {
  if (!confirm(`ç¢ºå®šè¦ç§»é™¤å» å•†ã€Œ${name}ã€å—ï¼Ÿ`)) return;
  state.vendors = state.vendors.filter(v => v.name !== name);
  saveVendors();
  renderVendorSelect();
  renderVendorList();

  // å¦‚æœç›®å‰è¡¨å–®é¸çš„å°±æ˜¯é€™å€‹å» å•†ï¼Œæ¸…é™¤
  if (document.getElementById('expVendor').value === name) {
    document.getElementById('expVendor').value = '';
    const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
    trigger.innerHTML = '<span class="placeholder">æœå°‹æˆ–æ–°å¢å» å•†...</span>';
  }

  showToast(`å·²ç§»é™¤ã€Œ${name}ã€`, 'success');
}

function editVendorInList(name) {
  const vendor = state.vendors.find(v => v.name === name);
  if (!vendor) return;

  const newName = prompt('å» å•†åç¨±ï¼š', vendor.name);
  if (newName === null) return;  // å–æ¶ˆ
  const trimName = newName.trim();
  if (!trimName) {
    showToast('å» å•†åç¨±ä¸èƒ½ç‚ºç©º', 'error');
    return;
  }
  if (trimName !== name && state.vendors.some(v => v.name === trimName)) {
    showToast('æ­¤å» å•†åç¨±å·²å­˜åœ¨', 'error');
    return;
  }

  const newNote = prompt('å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š', vendor.note || '');
  vendor.name = trimName;
  vendor.note = (newNote || '').trim();
  saveVendors();
  renderVendorSelect();
  renderVendorList();

  // å¦‚æœç›®å‰è¡¨å–®é¸çš„å°±æ˜¯é€™å€‹å» å•†ï¼Œæ›´æ–°é¡¯ç¤º
  if (document.getElementById('expVendor').value === name) {
    document.getElementById('expVendor').value = trimName;
    const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
    trigger.innerHTML = `<span class="vendor-tag">${trimName}</span>`;
  }

  showToast(`å·²æ›´æ–°å» å•†ã€Œ${trimName}ã€`, 'success');
}

function renderVendorList() {
  const container = document.getElementById('vendorList');
  if (!container) return;

  if (state.vendors.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-dim)">å°šæœªæ–°å¢ä»»ä½•å» å•†</div>';
    return;
  }

  container.innerHTML = state.vendors.map(v => {
    const safeName = v.name.replace(/'/g, "\\'");
    return `
    <div class="vendor-list-item" id="vendorListItem_${v.name.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '_')}">
      <div class="vendor-list-view" style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
        <span style="flex:1">${v.name}</span>
        <span style="font-size:11px;color:var(--text-dim)">${v.note || ''}</span>
        <button class="btn btn-sm" style="padding:2px 8px;font-size:11px;color:var(--text-secondary);background:none;border:none;cursor:pointer" onclick="editVendorInList('${safeName}')">âœï¸</button>
        <button class="btn btn-sm" style="padding:2px 8px;font-size:11px;color:var(--danger);background:none;border:none;cursor:pointer" onclick="removeVendor('${safeName}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// ---- å» å•†åŒ¯å…¥ (CSV/XLSX) ----
function handleVendorImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();

  if (ext === 'csv') {
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const rows = parseCSV(text);
      importVendorRows(rows, file.name);
    };
    reader.readAsText(file, 'UTF-8');
  } else if (['xlsx', 'xls'].includes(ext)) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        importVendorRows(rows, file.name);
      } catch (err) {
        showToast('XLSX è§£æå¤±æ•—ï¼š' + err.message, 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    showToast('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼', 'error');
  }

  // æ¸…é™¤ input è®“åŒä¸€æª”æ¡ˆå¯å†æ¬¡é¸å–
  event.target.value = '';
}

function parseCSV(text) {
  return text.split('\n')
    .map(line => line.trim())
    .filter(Boolean)
    .map(line => {
      // ç°¡æ˜“ CSV è§£æï¼ˆè™•ç†å¼•è™Ÿï¼‰
      const cols = [];
      let current = '';
      let inQuotes = false;
      for (const char of line) {
        if (char === '"') { inQuotes = !inQuotes; continue; }
        if (char === ',' && !inQuotes) { cols.push(current.trim()); current = ''; continue; }
        current += char;
      }
      cols.push(current.trim());
      return cols;
    });
}

function importVendorRows(rows, fileName) {
  let added = 0;
  let skipped = 0;

  // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœç¬¬ä¸€åˆ—çœ‹èµ·ä¾†åƒæ¨™é¡Œï¼‰
  let startIdx = 0;
  if (rows.length > 0) {
    const firstCell = String(rows[0][0] || '').toLowerCase();
    if (['å» å•†', 'åç¨±', 'vendor', 'name', 'å…¬å¸'].some(k => firstCell.includes(k))) {
      startIdx = 1;
    }
  }

  for (let i = startIdx; i < rows.length; i++) {
    const row = rows[i];
    const name = String(row[0] || '').trim();
    const note = String(row[1] || '').trim();

    if (!name) continue;

    if (state.vendors.some(v => v.name === name)) {
      skipped++;
      continue;
    }

    state.vendors.push({ name, note, createdAt: new Date().toISOString() });
    added++;
  }

  saveVendors();
  renderVendorSelect();
  renderVendorList();

  showToast(`å·²å¾ã€Œ${fileName}ã€åŒ¯å…¥ ${added} ç­†${skipped > 0 ? `ï¼ˆè·³é ${skipped} ç­†é‡è¤‡ï¼‰` : ''}`, 'success');
}

// ==================== ç…§ç‰‡è™•ç† ====================
function handlePhotoSelect(e) {
  if (e.target.files.length) handleFile(e.target.files[0]);
}

function handleFile(file) {
  if (!file.type.startsWith('image/')) {
    showToast('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'error');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showToast('æª”æ¡ˆå¤ªå¤§ï¼Œè«‹æ§åˆ¶åœ¨ 5MB ä»¥å…§', 'error');
    return;
  }

  state.selectedPhoto = file;

  const reader = new FileReader();
  reader.onload = (e) => {
    state.photoBase64 = e.target.result;
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('photoPreview').style.display = 'block';
    document.getElementById('photoUpload').style.display = 'none';

    // è‡ªå‹•å•Ÿå‹• OCR è¾¨è­˜
    runOcr(e.target.result);
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  state.selectedPhoto = null;
  state.photoBase64 = null;
  state.ocrResult = null;
  document.getElementById('photoFile').value = '';
  document.getElementById('photoPreview').style.display = 'none';
  document.getElementById('photoUpload').style.display = 'block';
  hideOcrResult();
}

// ==================== OCR ç™¼ç¥¨è¾¨è­˜ ====================
let ocrWorker = null;

async function runOcr(imageDataUrl) {
  const statusEl = document.getElementById('ocrStatus');
  const statusText = document.getElementById('ocrStatusText');
  const progressBar = document.getElementById('ocrProgressBar');

  // é¡¯ç¤ºè¾¨è­˜ä¸­ç‹€æ…‹
  statusEl.style.display = 'flex';
  statusText.textContent = 'æ­£åœ¨è¼‰å…¥è¾¨è­˜å¼•æ“...';
  progressBar.style.width = '5%';

  try {
    // ä½¿ç”¨ Tesseract.js v5 recognize API
    const result = await Tesseract.recognize(
      imageDataUrl,
      'chi_tra+eng',  // ç¹é«”ä¸­æ–‡ + è‹±æ–‡
      {
        logger: (m) => {
          if (m.status === 'loading tesseract core') {
            statusText.textContent = 'è¼‰å…¥è¾¨è­˜æ ¸å¿ƒ...';
            progressBar.style.width = '10%';
          } else if (m.status === 'initializing tesseract') {
            statusText.textContent = 'åˆå§‹åŒ–è¾¨è­˜å¼•æ“...';
            progressBar.style.width = '15%';
          } else if (m.status === 'loading language traineddata') {
            statusText.textContent = 'è¼‰å…¥ä¸­æ–‡èªè¨€åŒ…...';
            progressBar.style.width = '25%';
          } else if (m.status === 'initializing api') {
            statusText.textContent = 'æº–å‚™è¾¨è­˜...';
            progressBar.style.width = '35%';
          } else if (m.status === 'recognizing text') {
            const pct = Math.round(35 + (m.progress || 0) * 60);
            statusText.textContent = `è¾¨è­˜ä¸­ ${Math.round((m.progress || 0) * 100)}%`;
            progressBar.style.width = pct + '%';
          }
        },
      }
    );

    progressBar.style.width = '100%';
    statusText.textContent = 'è¾¨è­˜å®Œæˆï¼æ­£åœ¨è§£æ...';

    const ocrText = result.data.text;
    console.log('OCR è¾¨è­˜åŸæ–‡ï¼š', ocrText);

    // è§£æç™¼ç¥¨è³‡è¨Š
    const parsed = parseInvoiceText(ocrText);
    state.ocrResult = parsed;

    // çŸ­æš«å»¶é²å¾Œéš±è—ç‹€æ…‹åˆ—ï¼Œé¡¯ç¤ºçµæœ
    setTimeout(() => {
      statusEl.style.display = 'none';
      if (parsed && Object.keys(parsed).some(k => parsed[k])) {
        showOcrResult(parsed, ocrText);
      } else {
        showToast('æœªèƒ½è¾¨è­˜å‡ºç™¼ç¥¨è³‡è¨Šï¼Œè«‹æ‰‹å‹•å¡«å…¥', 'info');
      }
    }, 500);

  } catch (err) {
    console.error('OCR è¾¨è­˜å¤±æ•—ï¼š', err);
    statusEl.style.display = 'none';
    showToast('ç™¼ç¥¨è¾¨è­˜å¤±æ•—ï¼Œè«‹æ‰‹å‹•å¡«å…¥', 'error');
  }
}

/**
 * è§£æ OCR è¾¨è­˜æ–‡å­—ï¼Œæå–ç™¼ç¥¨é—œéµè³‡è¨Š
 */
function parseInvoiceText(text) {
  const result = {
    invoiceNumber: null,  // ç™¼ç¥¨è™Ÿç¢¼
    date: null,           // æ—¥æœŸ
    amount: null,         // ç¸½é‡‘é¡
    taxAmount: null,      // ç¨…é¡
    netAmount: null,      // æœªç¨…é‡‘é¡
    vendor: null,         // å» å•†åç¨±
  };

  // çµ±ä¸€æ–‡å­—è™•ç†ï¼šå…¨å½¢è½‰åŠå½¢ã€å»å¤šé¤˜ç©ºç™½
  const normalized = text
    .replace(/[ï¼¡-ï¼º]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
    .replace(/[ï½-ï½š]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
    .replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
    .replace(/ï¼Œ/g, ',')
    .replace(/ï¼š/g, ':')
    .replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')')
    .replace(/\r\n/g, '\n');

  const lines = normalized.split('\n').map(l => l.trim()).filter(Boolean);

  // 1. ç™¼ç¥¨è™Ÿç¢¼ï¼šæ ¼å¼ç‚º XX-12345678 (å…©å­—æ¯-å…«æ•¸å­—)
  const invoicePatterns = [
    /([A-Z]{2})\s*[-â€“â€”]\s*(\d{8})/i,
    /([A-Z]{2})\s*(\d{8})/i,
    /ç™¼ç¥¨.*?([A-Z]{2})\s*[-â€“â€”]?\s*(\d{8})/i,
    /è™Ÿç¢¼.*?([A-Z]{2})\s*[-â€“â€”]?\s*(\d{8})/i,
  ];
  for (const pattern of invoicePatterns) {
    const match = normalized.match(pattern);
    if (match) {
      result.invoiceNumber = match[1].toUpperCase() + '-' + match[2];
      break;
    }
  }

  // 2. æ—¥æœŸï¼šæ”¯æ´å¤šç¨®æ ¼å¼
  const datePatterns = [
    // æ°‘åœ‹å¹´ï¼š113/01/15 æˆ– 113-01-15 æˆ– 113.01.15
    /(\d{2,3})\s*[/\-.å¹´]\s*(\d{1,2})\s*[/\-.æœˆ]\s*(\d{1,2})/,
    // è¥¿å…ƒå¹´ï¼š2024/01/15 æˆ– 2024-01-15
    /(20\d{2})\s*[/\-.å¹´]\s*(\d{1,2})\s*[/\-.æœˆ]\s*(\d{1,2})/,
  ];
  for (const pattern of datePatterns) {
    const match = normalized.match(pattern);
    if (match) {
      let year = parseInt(match[1]);
      const month = parseInt(match[2]);
      const day = parseInt(match[3]);
      // æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´
      if (year < 200) year += 1911;
      if (year >= 2020 && year <= 2030 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
        result.date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        break;
      }
    }
  }

  // 3. é‡‘é¡ï¼šæ‰¾å‡ºç¸½è¨ˆ/åˆè¨ˆ/é‡‘é¡ ç›¸é—œæ•¸å­—
  const amountPatterns = [
    /(?:ç¸½[è¨ˆé‡‘é¡]|åˆ[è¨ˆé‡‘é¡]|TOTAL|total|Total)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/i,
    /(?:æ‡‰ä»˜|å¯¦ä»˜|å…±è¨ˆ|å°è¨ˆ)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/i,
    /\$\s*([\d,]+(?:\.\d{1,2})?)/,
    /(?:é‡‘é¡|AMOUNT)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/i,
  ];
  for (const pattern of amountPatterns) {
    const match = normalized.match(pattern);
    if (match) {
      const val = parseInt(match[1].replace(/,/g, ''));
      if (val > 0 && val < 10000000) {
        result.amount = val;
        break;
      }
    }
  }

  // å¦‚æœä¸Šé¢æ²’æ‰¾åˆ°é‡‘é¡ï¼Œå˜—è©¦æ‰¾æœ€å¤§çš„æ•¸å­—ï¼ˆæ’é™¤ç™¼ç¥¨è™Ÿç¢¼å’Œæ—¥æœŸä¸­çš„æ•¸å­—ï¼‰
  if (!result.amount) {
    const allNumbers = [];
    const cleanText = normalized
      .replace(/[A-Z]{2}\s*[-â€“â€”]?\s*\d{8}/gi, '')  // ç§»é™¤ç™¼ç¥¨è™Ÿç¢¼
      .replace(/\d{2,4}[/\-.]\d{1,2}[/\-.]\d{1,2}/g, '');  // ç§»é™¤æ—¥æœŸ

    const numMatches = cleanText.matchAll(/([\d,]+(?:\.\d{1,2})?)/g);
    for (const m of numMatches) {
      const val = parseInt(m[1].replace(/,/g, ''));
      if (val >= 10 && val < 10000000) {
        allNumbers.push(val);
      }
    }
    if (allNumbers.length > 0) {
      result.amount = Math.max(...allNumbers);
    }
  }

  // 4. ç¨…é¡
  const taxPatterns = [
    /(?:ç¨…é¡|ç‡Ÿæ¥­ç¨…|TAX)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/i,
    /(?:ç¨…)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/,
  ];
  for (const pattern of taxPatterns) {
    const match = normalized.match(pattern);
    if (match) {
      const val = parseInt(match[1].replace(/,/g, ''));
      if (val > 0 && val < result.amount) {
        result.taxAmount = val;
        break;
      }
    }
  }

  // 5. æœªç¨…é‡‘é¡
  const netPatterns = [
    /(?:æœªç¨…|éŠ·å”®é¡|èª²ç¨…åˆ¥)\s*[:ï¼š]?\s*\$?\s*([\d,]+)/i,
  ];
  for (const pattern of netPatterns) {
    const match = normalized.match(pattern);
    if (match) {
      const val = parseInt(match[1].replace(/,/g, ''));
      if (val > 0) {
        result.netAmount = val;
        break;
      }
    }
  }

  // å¦‚æœæœ‰ç¸½é‡‘é¡ä½†æ²’æœ‰ç¨…é¡ï¼Œè‡ªå‹•è¨ˆç®— 5%
  if (result.amount && !result.taxAmount) {
    result.taxAmount = Math.round(result.amount - result.amount / 1.05);
    result.netAmount = result.amount - result.taxAmount;
  }

  // 6. å» å•†åç¨±ï¼šé€šå¸¸åœ¨ç™¼ç¥¨æœ€ä¸Šæ–¹å¹¾è¡Œ
  const vendorPatterns = [
    /(?:è³£æ–¹|åº—å|å…¬å¸)\s*[:ï¼š]?\s*(.{2,20})/,
  ];
  for (const pattern of vendorPatterns) {
    const match = normalized.match(pattern);
    if (match) {
      result.vendor = match[1].trim().replace(/[,ï¼Œã€‚.]$/, '');
      break;
    }
  }

  // å¦‚æœæ²’æ‰¾åˆ°å» å•†ï¼Œå˜—è©¦å–å‰å¹¾è¡Œä¸­åŒ…å«ã€Œå…¬å¸ã€ã€Œè¡Œã€ã€Œåº—ã€çš„
  if (!result.vendor) {
    for (let i = 0; i < Math.min(5, lines.length); i++) {
      const line = lines[i];
      if (/(å…¬å¸|ä¼æ¥­|å•†è¡Œ|è¡Œ$|åº—$|æœ‰é™|è‚¡ä»½)/.test(line) && line.length >= 3 && line.length <= 30) {
        result.vendor = line.replace(/çµ±ä¸€ç·¨è™Ÿ.*$/, '').replace(/åœ°å€.*$/, '').trim();
        break;
      }
    }
  }

  return result;
}

/**
 * é¡¯ç¤º OCR è¾¨è­˜çµæœé¢æ¿
 */
function showOcrResult(parsed, rawText) {
  const container = document.getElementById('ocrResult');
  const fieldsEl = document.getElementById('ocrFields');

  const fields = [];

  if (parsed.invoiceNumber) {
    fields.push({
      key: 'invoiceNumber',
      label: 'ç™¼ç¥¨è™Ÿç¢¼',
      value: parsed.invoiceNumber,
      target: 'expInvoice',
      display: parsed.invoiceNumber,
    });
  }

  if (parsed.date) {
    fields.push({
      key: 'date',
      label: 'æ—¥æœŸ',
      value: parsed.date,
      target: 'expDate',
      display: parsed.date,
    });
  }

  if (parsed.amount) {
    fields.push({
      key: 'amount',
      label: 'é‡‘é¡ï¼ˆå«ç¨…ï¼‰',
      value: parsed.amount,
      target: 'expAmount',
      display: `$${numberFormat(parsed.amount)}`,
      isAmount: true,
    });
  }

  if (parsed.taxAmount) {
    fields.push({
      key: 'taxAmount',
      label: 'ç¨…é¡',
      value: parsed.taxAmount,
      target: 'expTax',
      display: `$${numberFormat(parsed.taxAmount)}`,
      isAmount: true,
    });
  }

  if (parsed.netAmount) {
    fields.push({
      key: 'netAmount',
      label: 'æœªç¨…é‡‘é¡',
      value: parsed.netAmount,
      target: 'expNet',
      display: `$${numberFormat(parsed.netAmount)}`,
      isAmount: true,
    });
  }

  if (parsed.vendor) {
    fields.push({
      key: 'vendor',
      label: 'å» å•†',
      value: parsed.vendor,
      target: 'expVendor',
      display: parsed.vendor,
    });
  }

  if (fields.length === 0) {
    container.style.display = 'none';
    return;
  }

  fieldsEl.innerHTML = fields.map((f, i) => `
    <div class="ocr-field" data-index="${i}">
      <span class="ocr-field-label">${f.label}</span>
      <span class="ocr-field-value${f.isAmount ? ' amount' : ''}">${f.display}</span>
      <button type="button" class="ocr-field-btn" onclick="applySingleOcrField(${i})" data-field-index="${i}">å¸¶å…¥</button>
    </div>
  `).join('');

  // å„²å­˜åˆ° state ä»¥ä¾› applyOcrResult ä½¿ç”¨
  state.ocrFields = fields;

  container.style.display = 'block';
}

/**
 * å¸¶å…¥å–®ä¸€ OCR è¾¨è­˜æ¬„ä½
 */
function applySingleOcrField(index) {
  const field = state.ocrFields[index];
  if (!field) return;

  applyOcrFieldValue(field);

  // æ¨™è¨˜ç‚ºå·²å¸¶å…¥
  const btn = document.querySelector(`[data-field-index="${index}"]`);
  if (btn) {
    btn.textContent = 'âœ“ å·²å¸¶å…¥';
    btn.classList.add('applied');
  }

  showToast(`å·²å¸¶å…¥${field.label}`, 'success');
}

/**
 * å¥—ç”¨å…¨éƒ¨ OCR çµæœ
 */
function applyOcrResult() {
  if (!state.ocrFields || state.ocrFields.length === 0) return;

  state.ocrFields.forEach((field, index) => {
    applyOcrFieldValue(field);

    const btn = document.querySelector(`[data-field-index="${index}"]`);
    if (btn) {
      btn.textContent = 'âœ“ å·²å¸¶å…¥';
      btn.classList.add('applied');
    }
  });

  showToast(`å·²å¥—ç”¨ ${state.ocrFields.length} å€‹æ¬„ä½`, 'success');
}

/**
 * å°‡ OCR è¾¨è­˜æ¬„ä½å€¼å¯«å…¥å°æ‡‰è¡¨å–®æ§ä»¶
 */
function applyOcrFieldValue(field) {
  // å» å•†æ¬„ä½ä½¿ç”¨è‡ªè¨‚é¸å–®
  if (field.target === 'expVendor') {
    document.getElementById('expVendor').value = field.value;
    const trigger = document.querySelector('#vendorSelect .custom-select-trigger');
    trigger.innerHTML = `<span class="vendor-tag">${field.value}</span>`;
    return;
  }

  const el = document.getElementById(field.target);
  if (el) {
    el.value = field.value;
    el.dispatchEvent(new Event('input', { bubbles: true }));
  }
}

/**
 * éš±è— OCR çµæœé¢æ¿
 */
function hideOcrResult() {
  const container = document.getElementById('ocrResult');
  if (container) container.style.display = 'none';
  const status = document.getElementById('ocrStatus');
  if (status) status.style.display = 'none';
  state.ocrFields = null;
  state.ocrResult = null;
}

// ==================== è¡¨å–®é€å‡º ====================
async function handleSubmit(e) {
  e.preventDefault();

  const catCode = document.getElementById('expCategory').value;
  const cat = DEFAULT_CATEGORIES.find(c => c.code === catCode);

  if (!cat) {
    showToast('è«‹é¸æ“‡è²»ç”¨åˆ†é¡', 'error');
    return;
  }

  // é‡è¤‡ç™¼ç¥¨è™Ÿç¢¼æª¢æŸ¥
  const invoiceVal = document.getElementById('expInvoice').value.trim();
  if (invoiceVal) {
    const duplicate = state.expenses.find(e =>
      e.status !== 'ä½œå»¢' && e.invoiceNumber === invoiceVal
    );
    if (duplicate) {
      const dupDate = duplicate.date;
      const dupVendor = duplicate.vendor || 'ç„¡å» å•†';
      const dupAmount = numberFormat(duplicate.amount);
      if (!confirm(`ç™¼ç¥¨è™Ÿç¢¼ ${invoiceVal} å·²å­˜åœ¨ï¼\n\næ—¢æœ‰ç´€éŒ„ï¼š${dupDate} / ${dupVendor} / $${dupAmount}\n\nç¢ºå®šè¦é‡è¤‡è¨˜éŒ„å—ï¼Ÿ`)) {
        return;
      }
    }
  }

  const expense = {
    id: 'EXP-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4),
    date: document.getElementById('expDate').value,
    categoryCode: cat.code,
    categoryName: cat.name,
    parentCategory: cat.parent,
    amount: Number(document.getElementById('expAmount').value),
    taxAmount: Number(document.getElementById('expTax').value) || 0,
    netAmount: Number(document.getElementById('expNet').value) || 0,
    invoiceNumber: invoiceVal,
    invoiceType: document.getElementById('expInvoiceType').value,
    paymentMethod: document.getElementById('expPayment').value,
    vendor: document.getElementById('expVendor').value.trim(),
    note: document.getElementById('expNote').value.trim(),
    imageUrl: '',
    imageDriveId: '',
    imageLocal: state.photoBase64 || '',
    recorder: state.settings.recorder || 'æœªè¨­å®š',
    createdAt: new Date().toISOString(),
    status: 'æ­£å¸¸',
    synced: false,
  };

  // å„²å­˜åˆ°æœ¬åœ°
  state.expenses.unshift(expense);
  saveExpenses();

  // åŠ å…¥å¾…åŒæ­¥ä½‡åˆ—
  state.pendingSync.push(expense);
  localStorage.setItem(APP_CONFIG.PENDING_KEY, JSON.stringify(state.pendingSync));

  showToast(`å·²å„²å­˜ $${numberFormat(expense.amount)} â€” ${cat.name}`, 'success');

  // å˜—è©¦åŒæ­¥åˆ°é›²ç«¯
  if (state.settings.apiUrl) {
    syncExpense(expense);
  }

  // é‡ç½®è¡¨å–®
  resetForm();
  refreshAllViews();
}

function resetForm() {
  document.getElementById('expenseForm').reset();
  document.getElementById('expDate').value = formatDate(new Date());
  document.getElementById('expTax').value = '';
  document.getElementById('expNet').value = '';
  // é‡ç½®è‡ªè¨‚åˆ†é¡é¸å–®
  document.getElementById('expCategory').value = '';
  document.querySelector('#categorySelect .custom-select-trigger').innerHTML = '<span class="placeholder">é¸æ“‡è²»ç”¨ç§‘ç›®...</span>';
  document.querySelectorAll('#categoryOptions .custom-select-option').forEach(o => o.classList.remove('selected'));
  // é‡ç½®è‡ªè¨‚å» å•†é¸å–®
  document.getElementById('expVendor').value = '';
  document.querySelector('#vendorSelect .custom-select-trigger').innerHTML = '<span class="placeholder">æœå°‹æˆ–æ–°å¢å» å•†...</span>';
  document.querySelectorAll('#vendorOptions .custom-select-option').forEach(o => o.classList.remove('selected'));
  removePhoto();
  hideOcrResult();
}

// ==================== é›²ç«¯åŒæ­¥ ====================
async function syncExpense(expense) {
  if (!state.settings.apiUrl) return;

  try {
    // å¦‚æœæœ‰ç…§ç‰‡ï¼Œå…ˆä¸Šå‚³
    if (expense.imageLocal) {
      const base64Data = expense.imageLocal.split(',')[1];
      const mimeType = expense.imageLocal.split(';')[0].split(':')[1];
      const fileName = `invoice_${expense.date}_${expense.id}.jpg`;

      const imgRes = await callApi('POST', {
        action: 'uploadImage',
        fileName: fileName,
        fileData: base64Data,
        mimeType: mimeType,
      });

      if (imgRes.success) {
        expense.imageUrl = imgRes.data.directUrl;
        expense.imageDriveId = imgRes.data.fileId;
      }
    }

    // ä¸Šå‚³è²»ç”¨ç´€éŒ„
    const expenseData = { ...expense };
    delete expenseData.imageLocal; // ä¸å‚³æœ¬åœ°åœ–ç‰‡è³‡æ–™

    const res = await callApi('POST', {
      action: 'addExpense',
      expense: expenseData,
    });

    if (res.success) {
      expense.synced = true;
      // ç§»é™¤å¾…åŒæ­¥ä½‡åˆ—
      state.pendingSync = state.pendingSync.filter(p => p.id !== expense.id);
      localStorage.setItem(APP_CONFIG.PENDING_KEY, JSON.stringify(state.pendingSync));
      saveExpenses();
      updateSyncStatus();
      updateLocalCount();
    }
  } catch (err) {
    console.warn('åŒæ­¥å¤±æ•—ï¼Œè³‡æ–™å·²ä¿å­˜åœ¨æœ¬åœ°:', err);
  }
}

async function syncToCloud() {
  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
    return;
  }

  if (state.pendingSync.length === 0) {
    showToast('æ²’æœ‰éœ€è¦åŒæ­¥çš„è³‡æ–™', 'info');
    return;
  }

  const total = state.pendingSync.length;
  showToast(`æ­£åœ¨åŒæ­¥ ${total} ç­†...`, 'info');

  // å°‡å¾…åŒæ­¥çš„è²»ç”¨åˆ†ç‚ºéœ€ä¸Šå‚³åœ–ç‰‡å’Œä¸éœ€ä¸Šå‚³åœ–ç‰‡çš„
  const withImage = state.pendingSync.filter(e => e.imageLocal);
  const withoutImage = state.pendingSync.filter(e => !e.imageLocal);

  // æœ‰åœ–ç‰‡çš„é€ç­†è™•ç†ï¼ˆå› ç‚ºéœ€è¦å…ˆä¸Šå‚³åœ–ç‰‡ï¼‰
  for (const expense of [...withImage]) {
    await syncExpense(expense);
  }

  // ç„¡åœ–ç‰‡çš„ä½¿ç”¨ batchAdd ä¸€æ¬¡é€å‡º
  if (withoutImage.length > 0) {
    try {
      const expenses = withoutImage.map(e => {
        const data = { ...e };
        delete data.imageLocal;
        return data;
      });

      const res = await callApi('POST', {
        action: 'batchAdd',
        expenses: expenses,
      });

      if (res.success) {
        // æ¨™è¨˜ç‚ºå·²åŒæ­¥
        withoutImage.forEach(expense => {
          expense.synced = true;
          state.pendingSync = state.pendingSync.filter(p => p.id !== expense.id);
        });
        localStorage.setItem(APP_CONFIG.PENDING_KEY, JSON.stringify(state.pendingSync));
        saveExpenses();
        updateSyncStatus();
        updateLocalCount();
      }
    } catch (err) {
      // æ‰¹æ¬¡å¤±æ•—å°±é€€å›é€ç­†åŒæ­¥
      console.warn('æ‰¹æ¬¡åŒæ­¥å¤±æ•—ï¼Œæ”¹ç”¨é€ç­†åŒæ­¥:', err);
      for (const expense of [...withoutImage]) {
        await syncExpense(expense);
      }
    }
  }

  showToast(`åŒæ­¥å®Œæˆï¼å…± ${total} ç­†`, 'success');
}

/**
 * å¾é›²ç«¯æ‹‰å›è²»ç”¨è³‡æ–™åˆ°æœ¬åœ°
 * åˆä½µç­–ç•¥ï¼šä»¥é›²ç«¯ç‚ºä¸»ï¼Œæœ¬åœ°ä¸å­˜åœ¨çš„æœƒæ–°å¢ï¼Œå·²å­˜åœ¨çš„ä»¥é›²ç«¯ç‚ºæº–æ›´æ–°
 */
async function pullExpensesFromCloud() {
  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
    return;
  }

  // å–å¾—ç›®å‰é¡¯ç¤ºçš„å¹´æœˆ
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  try {
    showToast('æ­£åœ¨å¾é›²ç«¯è®€å–è³‡æ–™...', 'info');

    const res = await callApi('GET', {
      action: 'getExpenses',
      year: year,
      month: month,
    });

    if (!res.success || !Array.isArray(res.data)) {
      showToast('è®€å–å¤±æ•—ï¼š' + (res.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
      return;
    }

    const cloudExpenses = res.data;
    if (cloudExpenses.length === 0) {
      showToast(`é›²ç«¯ ${year}/${month} æœˆç„¡è²»ç”¨ç´€éŒ„`, 'info');
      return;
    }

    let added = 0;
    let updated = 0;

    cloudExpenses.forEach(ce => {
      // å˜—è©¦ç”¨ id åŒ¹é…ï¼ˆROW-N æ ¼å¼ï¼‰
      const existing = state.expenses.find(e => e.id === ce.id);

      if (existing) {
        // æ›´æ–°å·²å­˜åœ¨çš„ç´€éŒ„ï¼ˆä»¥é›²ç«¯ç‚ºæº–ï¼‰
        Object.assign(existing, {
          date: ce.date,
          categoryName: ce.categoryName,
          amount: ce.amount,
          paymentMethod: ce.paymentMethod,
          vendor: ce.vendor,
          note: ce.note,
          categoryCode: ce.categoryCode,
          parentCategory: ce.parentCategory,
          taxAmount: ce.taxAmount,
          netAmount: ce.netAmount,
          invoiceNumber: ce.invoiceNumber,
          invoiceType: ce.invoiceType,
          imageUrl: ce.imageUrl,
          status: ce.status,
          synced: true,
        });
        updated++;
      } else {
        // æ–°å¢ä¸å­˜åœ¨çš„ç´€éŒ„
        state.expenses.push({
          ...ce,
          synced: true,
        });
        added++;
      }
    });

    saveExpenses();
    refreshAllViews();
    updateSyncStatus();
    updateLocalCount();

    showToast(`å·²å¾é›²ç«¯åŒ¯å…¥ ${year}/${month} æœˆè³‡æ–™ï¼šæ–°å¢ ${added} ç­†ï¼Œæ›´æ–° ${updated} ç­†`, 'success');
  } catch (err) {
    showToast('å¾é›²ç«¯åŒ¯å…¥å¤±æ•—ï¼š' + err.message, 'error');
  }
}

async function callApi(method, data) {
  const url = state.settings.apiUrl;
  if (!url) throw new Error('æœªè¨­å®š API URL');

  if (method === 'GET') {
    const params = new URLSearchParams(data).toString();
    const res = await fetch(`${url}?${params}`);
    return await res.json();
  } else {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(data),
    });
    return await res.json();
  }
}

async function testConnection() {
  const url = document.getElementById('settingApiUrl').value.trim();
  if (!url) {
    showToast('è«‹å…ˆè¼¸å…¥ Apps Script URL', 'error');
    return;
  }

  try {
    showToast('æ­£åœ¨æ¸¬è©¦é€£ç·š...', 'info');
    const res = await fetch(`${url}?action=getCategories`);
    const json = await res.json();
    if (json.success) {
      showToast('é€£ç·šæˆåŠŸï¼', 'success');
      document.getElementById('syncDot').className = 'sync-dot';
      document.getElementById('syncText').textContent = 'å·²é€£ç·š';
    } else {
      showToast('é€£ç·šå¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
    }
  } catch (err) {
    showToast('é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
  }
}

function updateSyncStatus() {
  const dot = document.getElementById('syncDot');
  const text = document.getElementById('syncText');
  if (state.settings.apiUrl) {
    if (state.pendingSync.length > 0) {
      dot.className = 'sync-dot offline';
      text.textContent = `å¾…åŒæ­¥ ${state.pendingSync.length} ç­†`;
    } else {
      dot.className = 'sync-dot';
      text.textContent = 'å·²åŒæ­¥';
    }
  } else {
    dot.className = 'sync-dot offline';
    text.textContent = 'æœ¬åœ°æ¨¡å¼';
  }
}

function updateLocalCount() {
  document.getElementById('localCount').textContent = state.expenses.length;
  document.getElementById('pendingCount').textContent = state.pendingSync.length;
}

// ==================== æœˆä»½é¸æ“‡å™¨ ====================
function initMonthPickers() {
  updateMonthDisplay();
  initReportPage();
}

function changeMonth(delta) {
  state.currentMonth.setMonth(state.currentMonth.getMonth() + delta);
  updateMonthDisplay();
  renderExpenseList();
}

function changeStatsMonth(delta) {
  state.statsMonth.setMonth(state.statsMonth.getMonth() + delta);
  document.getElementById('statsMonth').textContent =
    `${state.statsMonth.getFullYear()}/${String(state.statsMonth.getMonth() + 1).padStart(2, '0')}`;
  renderStats();
}

function updateMonthDisplay() {
  const y = state.currentMonth.getFullYear();
  const m = String(state.currentMonth.getMonth() + 1).padStart(2, '0');
  document.getElementById('listMonth').textContent = `${y}/${m}`;

  const sy = state.statsMonth.getFullYear();
  const sm = String(state.statsMonth.getMonth() + 1).padStart(2, '0');
  document.getElementById('statsMonth').textContent = `${sy}/${sm}`;
}

// ==================== è²»ç”¨æ˜ç´°åˆ—è¡¨ ====================
function renderExpenseList() {
  const y = state.currentMonth.getFullYear();
  const m = state.currentMonth.getMonth() + 1;

  // æœå°‹èˆ‡ç¯©é¸
  const keyword = (document.getElementById('listSearch')?.value || '').trim().toLowerCase();
  const payFilter = document.getElementById('listFilterPayment')?.value || '';

  const filtered = state.expenses.filter(exp => {
    if (exp.status === 'ä½œå»¢') return false;
    const d = new Date(exp.date);
    if (d.getFullYear() !== y || (d.getMonth() + 1) !== m) return false;
    if (payFilter && exp.paymentMethod !== payFilter) return false;
    if (keyword) {
      const haystack = [exp.categoryName, exp.vendor, exp.note, exp.invoiceNumber, exp.parentCategory, exp.recorder].join(' ').toLowerCase();
      if (!haystack.includes(keyword)) return false;
    }
    return true;
  }).sort((a, b) => new Date(b.date) - new Date(a.date));

  const list = document.getElementById('expenseList');
  const empty = document.getElementById('listEmpty');
  const countEl = document.getElementById('listCount');

  if (filtered.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    countEl.textContent = keyword || payFilter ? 'ç„¡ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„' : '';
    return;
  }

  empty.style.display = 'none';
  const total = filtered.reduce((s, e) => s + (Number(e.amount) || 0), 0);
  countEl.textContent = `${filtered.length} ç­† Â· $${numberFormat(total)}`;

  list.innerHTML = filtered.map(exp => {
    const cat = DEFAULT_CATEGORIES.find(c => c.code === exp.categoryCode);
    const iconClass = getParentClass(exp.parentCategory);
    return `
      <li class="expense-item" onclick="showDetail('${exp.id}')">
        <div class="expense-icon ${iconClass}">${cat ? cat.icon : 'ğŸ“‹'}</div>
        <div class="expense-info">
          <div class="expense-name">${exp.categoryName}${exp.vendor ? ' Â· ' + exp.vendor : ''}</div>
          <div class="expense-meta">${exp.date} Â· ${exp.paymentMethod}${exp.recorder ? ' Â· ' + exp.recorder : ''}${exp.invoiceNumber ? ' Â· ' + exp.invoiceNumber : ''}</div>
        </div>
        ${(exp.imageLocal || exp.imageUrl) ? '<div class="has-photo" title="æœ‰ç™¼ç¥¨ç…§ç‰‡"></div>' : ''}
        <div class="expense-amount"><span class="currency-sign">$</span>${numberFormat(exp.amount)}</div>
      </li>
    `;
  }).join('');
}

function getParentClass(parent) {
  const map = { 'éŠ·å”®è²»ç”¨': 'cat-sales', 'ç®¡ç†è²»ç”¨': 'cat-admin', 'ç‡Ÿæ¥­è²»ç”¨': 'cat-ops', 'ç¨…å‹™è²»ç”¨': 'cat-tax' };
  return map[parent] || 'cat-admin';
}

// ==================== çµ±è¨ˆé  ====================
function renderStats() {
  const y = state.statsMonth.getFullYear();
  const m = state.statsMonth.getMonth() + 1;

  const filtered = state.expenses.filter(exp => {
    if (exp.status === 'ä½œå»¢') return false;
    const d = new Date(exp.date);
    return d.getFullYear() === y && (d.getMonth() + 1) === m;
  });

  const total = filtered.reduce((s, e) => s + (Number(e.amount) || 0), 0);
  const count = filtered.length;
  const avg = count > 0 ? Math.round(total / count) : 0;

  document.getElementById('statTotal').innerHTML = `$${numberFormat(total)} <span class="unit">NTD</span>`;
  document.getElementById('statCount').innerHTML = `${count} <span class="unit">ç­†</span>`;
  document.getElementById('statAvg').innerHTML = `$${numberFormat(avg)} <span class="unit">NTD</span>`;

  // é ç®—é€²åº¦
  renderBudgetProgress(filtered);

  // åˆ†é¡é•·æ¢åœ–
  const byParent = {};
  filtered.forEach(exp => {
    if (!byParent[exp.parentCategory]) byParent[exp.parentCategory] = 0;
    byParent[exp.parentCategory] += Number(exp.amount) || 0;
  });

  const maxVal = Math.max(...Object.values(byParent), 1);
  const barColors = { 'éŠ·å”®è²»ç”¨': 'sales', 'ç®¡ç†è²»ç”¨': 'admin', 'ç‡Ÿæ¥­è²»ç”¨': 'ops', 'ç¨…å‹™è²»ç”¨': 'tax' };

  document.getElementById('categoryChart').innerHTML = Object.entries(byParent)
    .sort((a, b) => b[1] - a[1])
    .map(([name, amount]) => `
      <div class="bar-row">
        <div class="bar-label">${name}</div>
        <div class="bar-track">
          <div class="bar-fill ${barColors[name] || 'sales'}" style="width:${(amount / maxVal * 100)}%">
            $${numberFormat(amount)}
          </div>
        </div>
      </div>
    `).join('') || '<div style="text-align:center;color:var(--text-dim);padding:20px">å°šç„¡è³‡æ–™</div>';

  // ä»˜æ¬¾æ–¹å¼
  const byPayment = {};
  filtered.forEach(exp => {
    if (!byPayment[exp.paymentMethod]) byPayment[exp.paymentMethod] = 0;
    byPayment[exp.paymentMethod] += Number(exp.amount) || 0;
  });

  const maxPay = Math.max(...Object.values(byPayment), 1);
  document.getElementById('paymentChart').innerHTML = Object.entries(byPayment)
    .sort((a, b) => b[1] - a[1])
    .map(([name, amount]) => `
      <div class="bar-row">
        <div class="bar-label">${name}</div>
        <div class="bar-track">
          <div class="bar-fill admin" style="width:${(amount / maxPay * 100)}%">
            $${numberFormat(amount)}
          </div>
        </div>
      </div>
    `).join('') || '<div style="text-align:center;color:var(--text-dim);padding:20px">å°šç„¡è³‡æ–™</div>';

  // å¹´åº¦æœˆè¶¨å‹¢åœ–
  renderTrendChart(y);
}

function renderTrendChart(year) {
  const monthlyData = [];
  for (let m = 1; m <= 12; m++) {
    const monthExpenses = state.expenses.filter(e => {
      if (e.status === 'ä½œå»¢') return false;
      const d = new Date(e.date);
      return d.getFullYear() === year && (d.getMonth() + 1) === m;
    });
    monthlyData.push({
      month: m,
      total: monthExpenses.reduce((s, e) => s + (Number(e.amount) || 0), 0),
      count: monthExpenses.length,
    });
  }

  const maxTotal = Math.max(...monthlyData.map(d => d.total), 1);
  const yearTotal = monthlyData.reduce((s, d) => s + d.total, 0);
  const activeMonths = monthlyData.filter(d => d.total > 0).length;
  const avgMonthly = activeMonths > 0 ? Math.round(yearTotal / activeMonths) : 0;

  document.getElementById('trendYear').textContent = year;
  document.getElementById('trendChart').innerHTML = monthlyData.map(d => `
    <div class="trend-bar-wrap">
      <div class="trend-value">${d.total > 0 ? (d.total >= 10000 ? Math.round(d.total / 1000) + 'K' : numberFormat(d.total)) : ''}</div>
      <div style="flex:1;display:flex;align-items:flex-end;width:100%">
        <div class="trend-bar" style="height:${d.total > 0 ? Math.max(d.total / maxTotal * 100, 3) : 0}%;width:100%;max-width:28px;margin:0 auto"></div>
      </div>
      <div class="trend-label">${d.month}æœˆ</div>
    </div>
  `).join('');

  document.getElementById('trendSummary').innerHTML = `
    <span>å¹´åº¦åˆè¨ˆ <strong>$${numberFormat(yearTotal)}</strong></span>
    <span>æœˆå¹³å‡ <strong>$${numberFormat(avgMonthly)}</strong></span>
    <span>å…± <strong>${activeMonths}</strong> å€‹æœˆæœ‰ç´€éŒ„</span>
  `;
}

// ==================== å ±è¡¨é  ====================
function initReportPage() {
  const yearSelect = document.getElementById('reportYear');
  const now = new Date();
  yearSelect.innerHTML = '';
  for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
  document.getElementById('reportMonth').value = now.getMonth() + 1;
}

function getReportData() {
  const year = Number(document.getElementById('reportYear').value);
  const month = Number(document.getElementById('reportMonth').value);

  return state.expenses.filter(exp => {
    if (exp.status === 'ä½œå»¢') return false;
    const d = new Date(exp.date);
    return d.getFullYear() === year && (d.getMonth() + 1) === month;
  }).sort((a, b) => new Date(a.date) - new Date(b.date));
}

function generatePDF() {
  const data = getReportData();
  const year = document.getElementById('reportYear').value;
  const month = document.getElementById('reportMonth').value;

  if (data.length === 0) {
    showToast('è©²æœˆä»½æ²’æœ‰è³‡æ–™', 'error');
    return;
  }

  // å…ˆé¡¯ç¤ºé è¦½
  showReportPreview(data, year, month);

  // ç”¢ç”Ÿ PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  // æ¨™é¡Œ
  doc.setFontSize(18);
  doc.text(`Outrun Nutrition`, 14, 20);
  doc.setFontSize(11);
  doc.text(`Monthly Expense Report - ${year}/${String(month).padStart(2, '0')}`, 14, 28);
  doc.setFontSize(9);
  doc.text(`Generated: ${formatDate(new Date())}`, 14, 34);

  // å½™ç¸½
  const total = data.reduce((s, e) => s + (Number(e.amount) || 0), 0);
  const totalTax = data.reduce((s, e) => s + (Number(e.taxAmount) || 0), 0);

  doc.setFontSize(10);
  doc.text(`Total: NTD ${numberFormat(total)}  |  Tax: NTD ${numberFormat(totalTax)}  |  Entries: ${data.length}`, 14, 42);

  doc.line(14, 45, 196, 45);

  // åˆ†é¡å½™ç¸½è¡¨
  const byParent = {};
  data.forEach(exp => {
    if (!byParent[exp.parentCategory]) byParent[exp.parentCategory] = { amount: 0, count: 0 };
    byParent[exp.parentCategory].amount += Number(exp.amount) || 0;
    byParent[exp.parentCategory].count++;
  });

  const catRows = Object.entries(byParent).map(([name, v]) => [
    name,
    v.count.toString(),
    `NTD ${numberFormat(v.amount)}`,
    (v.amount / total * 100).toFixed(1) + '%',
  ]);
  catRows.push(['Total', data.length.toString(), `NTD ${numberFormat(total)}`, '100%']);

  doc.autoTable({
    startY: 50,
    head: [['Category', 'Count', 'Amount', '%']],
    body: catRows,
    theme: 'grid',
    headStyles: { fillColor: [237, 93, 43], fontSize: 9 },
    bodyStyles: { fontSize: 8 },
    footStyles: { fillColor: [47, 47, 47], textColor: [237, 93, 43] },
    columnStyles: {
      2: { halign: 'right' },
      3: { halign: 'right' },
    },
  });

  // æ˜ç´°è¡¨
  const detailRows = data.map(exp => [
    exp.date,
    `${exp.categoryCode} ${exp.categoryName}`,
    exp.vendor || '-',
    exp.invoiceNumber || '-',
    exp.paymentMethod,
    `NTD ${numberFormat(exp.amount)}`,
  ]);

  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 12,
    head: [['Date', 'Category', 'Vendor', 'Invoice #', 'Payment', 'Amount']],
    body: detailRows,
    theme: 'striped',
    headStyles: { fillColor: [20, 93, 221], fontSize: 8 },
    bodyStyles: { fontSize: 7 },
    columnStyles: {
      5: { halign: 'right' },
    },
  });

  // é å°¾
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(7);
    doc.setTextColor(150);
    doc.text(`Outrun Nutrition Expense Report | Page ${i}/${pageCount}`, 14, 290);
  }

  doc.save(`Outrun_Expense_${year}${String(month).padStart(2, '0')}.pdf`);
  showToast('PDF å·²ä¸‹è¼‰ï¼', 'success');
}

function showReportPreview(data, year, month) {
  const preview = document.getElementById('reportPreview');
  preview.style.display = 'block';

  const total = data.reduce((s, e) => s + (Number(e.amount) || 0), 0);
  const totalTax = data.reduce((s, e) => s + (Number(e.taxAmount) || 0), 0);

  document.getElementById('rptTotal').textContent = `$${numberFormat(total)}`;
  document.getElementById('rptTax').textContent = `$${numberFormat(totalTax)}`;

  // åˆ†é¡è¡¨
  const byParent = {};
  data.forEach(exp => {
    if (!byParent[exp.parentCategory]) byParent[exp.parentCategory] = { amount: 0, count: 0 };
    byParent[exp.parentCategory].amount += Number(exp.amount) || 0;
    byParent[exp.parentCategory].count++;
  });

  const catBody = document.querySelector('#rptCatTable tbody');
  catBody.innerHTML = Object.entries(byParent).map(([name, v]) =>
    `<tr><td>${name}</td><td>${v.count}</td><td>$${numberFormat(v.amount)}</td></tr>`
  ).join('') + `<tr class="total-row"><td>åˆè¨ˆ</td><td>${data.length}</td><td>$${numberFormat(total)}</td></tr>`;

  // æ˜ç´°è¡¨
  const detailBody = document.querySelector('#rptDetailTable tbody');
  detailBody.innerHTML = data.map(exp =>
    `<tr><td>${exp.date}</td><td>${exp.categoryName}</td><td>${exp.vendor || '-'}</td><td>$${numberFormat(exp.amount)}</td></tr>`
  ).join('') + `<tr class="total-row"><td colspan="3">åˆè¨ˆ</td><td>$${numberFormat(total)}</td></tr>`;
}

// ==================== CSV åŒ¯å‡º ====================
function exportCSV() {
  const data = getReportData();
  const year = document.getElementById('reportYear').value;
  const month = document.getElementById('reportMonth').value;

  if (data.length === 0) {
    showToast('è©²æœˆä»½æ²’æœ‰è³‡æ–™', 'error');
    return;
  }

  const headers = ['æ—¥æœŸ', 'ç§‘ç›®ä»£ç¢¼', 'ç§‘ç›®åç¨±', 'ä¸Šå±¤åˆ†é¡', 'é‡‘é¡ï¼ˆå«ç¨…ï¼‰', 'ç¨…é¡', 'æœªç¨…é‡‘é¡', 'ç™¼ç¥¨è™Ÿç¢¼', 'ç™¼ç¥¨é¡å‹', 'ä»˜æ¬¾æ–¹å¼', 'å» å•†', 'è¨˜å¸³äººå“¡', 'å‚™è¨»'];
  const rows = data.map(exp => [
    exp.date, exp.categoryCode, exp.categoryName, exp.parentCategory,
    exp.amount, exp.taxAmount, exp.netAmount, exp.invoiceNumber,
    exp.invoiceType, exp.paymentMethod, exp.vendor, exp.recorder || '', exp.note,
  ]);

  // åŠ å…¥ BOM è®“ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡
  let csv = '\uFEFF' + headers.join(',') + '\n';
  rows.forEach(row => {
    csv += row.map(cell => {
      const str = String(cell || '');
      return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
    }).join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Outrun_Expense_${year}${String(month).padStart(2, '0')}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  showToast('CSV å·²ä¸‹è¼‰ï¼', 'success');
}

// ==================== æœƒè¨ˆå‚³ç¥¨æ ¼å¼åŒ¯å‡º ====================
function exportAccountingCSV() {
  const data = getReportData();
  const year = document.getElementById('reportYear').value;
  const month = document.getElementById('reportMonth').value;

  if (data.length === 0) {
    showToast('è©²æœˆä»½æ²’æœ‰è³‡æ–™', 'error');
    return;
  }

  const headers = ['å‚³ç¥¨æ—¥æœŸ', 'å‚³ç¥¨è™Ÿç¢¼', 'æ‘˜è¦', 'ç§‘ç›®ä»£ç¢¼', 'ç§‘ç›®åç¨±', 'å€Ÿæ–¹é‡‘é¡', 'è²¸æ–¹é‡‘é¡', 'ç¨…é¡', 'ç™¼ç¥¨è™Ÿç¢¼', 'å» å•†'];
  const rows = [];
  let voucherSeq = 1;

  data.forEach(exp => {
    const voucherNo = `${year}${String(month).padStart(2, '0')}-${String(voucherSeq).padStart(4, '0')}`;
    const summary = `${exp.categoryName}${exp.vendor ? ' / ' + exp.vendor : ''}${exp.note ? ' / ' + exp.note : ''}`;

    // å€Ÿæ–¹ï¼šè²»ç”¨ç§‘ç›®
    rows.push([
      exp.date, voucherNo, summary,
      exp.categoryCode, exp.categoryName,
      exp.netAmount || exp.amount, '', exp.taxAmount || 0,
      exp.invoiceNumber || '', exp.vendor || '',
    ]);

    // è‹¥æœ‰ç¨…é¡ï¼Œç¨ç«‹ä¸€è¡Œé€²é …ç¨…é¡
    if (exp.taxAmount && exp.taxAmount > 0) {
      rows.push([
        exp.date, voucherNo, 'é€²é …ç¨…é¡',
        '1171', 'ç•™æŠµç¨…é¡',
        exp.taxAmount, '', '',
        exp.invoiceNumber || '', exp.vendor || '',
      ]);
    }

    // è²¸æ–¹ï¼šä»˜æ¬¾æ–¹å¼å°æ‡‰ç§‘ç›®
    const paymentAccount = {
      'ç¾é‡‘': { code: '1001', name: 'åº«å­˜ç¾é‡‘' },
      'åŒ¯æ¬¾': { code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾' },
      'ä¿¡ç”¨å¡': { code: '2121', name: 'æ‡‰ä»˜å¸³æ¬¾-ä¿¡ç”¨å¡' },
      'é›»å­æ”¯ä»˜': { code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾' },
    };
    const pay = paymentAccount[exp.paymentMethod] || { code: '1001', name: 'åº«å­˜ç¾é‡‘' };

    rows.push([
      exp.date, voucherNo, `ä»˜æ¬¾ - ${exp.paymentMethod}`,
      pay.code, pay.name,
      '', exp.amount, '',
      '', '',
    ]);

    voucherSeq++;
  });

  let csv = '\uFEFF' + headers.join(',') + '\n';
  rows.forEach(row => {
    csv += row.map(cell => {
      const str = String(cell ?? '');
      return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
    }).join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Outrun_æœƒè¨ˆå‚³ç¥¨_${year}${String(month).padStart(2, '0')}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  showToast('æœƒè¨ˆå‚³ç¥¨ CSV å·²ä¸‹è¼‰ï¼', 'success');
}

// ==================== è©³æƒ…å½ˆçª— ====================
function showDetail(id) {
  const exp = state.expenses.find(e => e.id === id);
  if (!exp) return;

  const cat = DEFAULT_CATEGORIES.find(c => c.code === exp.categoryCode);
  const modal = document.getElementById('detailModal');
  const content = document.getElementById('modalContent');

  content.innerHTML = `
    <h3 style="font-size:18px;margin-bottom:16px">${cat ? cat.icon : 'ğŸ“‹'} ${exp.categoryName}</h3>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div>
        <div style="font-size:11px;color:var(--text-secondary)">é‡‘é¡</div>
        <div style="font-family:var(--font-en);font-size:22px;font-weight:700;color:var(--orange)">$${numberFormat(exp.amount)}</div>
      </div>
      <div>
        <div style="font-size:11px;color:var(--text-secondary)">æ—¥æœŸ</div>
        <div style="font-size:15px;font-weight:500">${exp.date}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px">
      <div><span style="color:var(--text-secondary)">ç§‘ç›®ä»£ç¢¼ï¼š</span>${exp.categoryCode}</div>
      <div><span style="color:var(--text-secondary)">ä¸Šå±¤åˆ†é¡ï¼š</span>${exp.parentCategory}</div>
      <div><span style="color:var(--text-secondary)">ä»˜æ¬¾æ–¹å¼ï¼š</span>${exp.paymentMethod}</div>
      <div><span style="color:var(--text-secondary)">ç™¼ç¥¨é¡å‹ï¼š</span>${exp.invoiceType || 'ç„¡'}</div>
      ${exp.invoiceNumber ? `<div><span style="color:var(--text-secondary)">ç™¼ç¥¨è™Ÿç¢¼ï¼š</span><span style="font-family:var(--font-en)">${exp.invoiceNumber}</span></div>` : ''}
      ${exp.vendor ? `<div><span style="color:var(--text-secondary)">å» å•†ï¼š</span>${exp.vendor}</div>` : ''}
      ${exp.taxAmount ? `<div><span style="color:var(--text-secondary)">ç¨…é¡ï¼š</span>$${numberFormat(exp.taxAmount)}</div>` : ''}
      ${exp.netAmount ? `<div><span style="color:var(--text-secondary)">æœªç¨…ï¼š</span>$${numberFormat(exp.netAmount)}</div>` : ''}
      ${exp.recorder ? `<div><span style="color:var(--text-secondary)">è¨˜å¸³äººå“¡ï¼š</span>${exp.recorder}</div>` : ''}
    </div>

    ${exp.note ? `<div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;font-size:13px;color:var(--text-secondary)">${exp.note}</div>` : ''}

    ${(exp.imageLocal || exp.imageUrl) ? `
      <div style="margin-top:16px">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">ç™¼ç¥¨ç…§ç‰‡</div>
        <img src="${exp.imageLocal || exp.imageUrl}" style="width:100%;border-radius:8px;max-height:300px;object-fit:cover">
      </div>
    ` : ''}

    <div style="margin-top:12px;font-size:11px;color:var(--text-dim)">
      ID: ${exp.id} Â· ${exp.synced ? 'âœ… å·²åŒæ­¥' : 'â³ å¾…åŒæ­¥'}
    </div>

    <div class="btn-group">
      <button class="btn btn-outline btn-sm" onclick="createTemplateFromExpense('${exp.id}')" style="flex:1">â­ å­˜ç‚ºç¯„æœ¬</button>
      <button class="btn btn-danger btn-sm" onclick="deleteExpense('${exp.id}')" style="flex:1">ğŸ—‘ï¸ åˆªé™¤</button>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()" style="flex:1">é—œé–‰</button>
    </div>
  `;

  modal.classList.add('active');
}

function closeModal() {
  document.getElementById('detailModal').classList.remove('active');
}

// é»æ“ŠèƒŒæ™¯é—œé–‰
document.getElementById('detailModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});

async function deleteExpense(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;

  const idx = state.expenses.findIndex(e => e.id === id);
  if (idx !== -1) {
    state.expenses[idx].status = 'ä½œå»¢';
    saveExpenses();
    closeModal();
    refreshAllViews();
    showToast('å·²åˆªé™¤', 'success');

    // åŒæ­¥åˆªé™¤åˆ°é›²ç«¯ï¼ˆå¦‚æœå·²åŒæ­¥éä¸”æœ‰ API URLï¼‰
    if (state.expenses[idx].synced && state.settings.apiUrl) {
      try {
        await callApi('POST', { action: 'deleteExpense', id: id });
      } catch (err) {
        console.warn('é›²ç«¯åˆªé™¤åŒæ­¥å¤±æ•—ï¼Œä¸‹æ¬¡åŒæ­¥æ™‚å†è™•ç†:', err);
      }
    }
  }
}

// ==================== è¨­å®šé  ====================
function toggleSetting(key) {
  state.settings[key] = !state.settings[key];
  // æ˜ å°„ setting key åˆ° toggle element ID
  const toggleMap = {
    autoTax: 'toggleAutoTax',
    offline: 'toggleOffline',
    batchMode: 'toggleBatch',
    autoReport: 'toggleAutoReport',
  };
  const toggleId = toggleMap[key];
  if (toggleId) updateToggle(toggleId, state.settings[key]);
  // åŒæ­¥è¨˜å¸³é çš„æ‰¹æ¬¡æ¨¡å¼ toggle
  if (key === 'batchMode') updateToggle('toggleBatchMode', state.settings[key]);
  localStorage.setItem(APP_CONFIG.SETTINGS_KEY, JSON.stringify(state.settings));
}

function updateToggle(id, active) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('active', active);
}

function confirmClearLocal() {
  if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰æœ¬åœ°å¿«å–è³‡æ–™å—ï¼Ÿ\nï¼ˆæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼‰')) {
    state.expenses = [];
    state.pendingSync = [];
    localStorage.removeItem(APP_CONFIG.STORAGE_KEY);
    localStorage.removeItem(APP_CONFIG.PENDING_KEY);
    refreshAllViews();
    updateLocalCount();
    showToast('æœ¬åœ°å¿«å–å·²æ¸…é™¤', 'success');
  }
}

function renderCategoryList() {
  const groups = {};
  DEFAULT_CATEGORIES.forEach(cat => {
    if (!groups[cat.parent]) groups[cat.parent] = [];
    groups[cat.parent].push(cat);
  });

  const container = document.getElementById('categoryList');
  container.innerHTML = Object.entries(groups).map(([parent, cats]) => `
    <div style="margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--orange);margin-bottom:8px;font-family:var(--font-en);text-transform:uppercase;letter-spacing:0.08em">${parent}</div>
      ${cats.map(c => `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
          <span>${c.icon}</span>
          <span style="font-family:var(--font-en);font-size:12px;color:var(--text-dim);width:40px">${c.code}</span>
          <span style="flex:1">${c.name}</span>
          <span style="font-size:11px;color:var(--text-dim)">${c.desc}</span>
        </div>
      `).join('')}
    </div>
  `).join('');
}

// ==================== å·¥å…·å‡½å¼ ====================
function formatDate(d) {
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function numberFormat(n) {
  return Number(n || 0).toLocaleString('en-US');
}

function updateAmountPreview() {
  const val = Number(document.getElementById('expAmount').value) || 0;
  const el = document.getElementById('amountPreview');
  el.textContent = val >= 1000 ? `NTD ${numberFormat(val)}` : '';
}

function refreshAllViews() {
  renderExpenseList();
  renderStats();
  updateLocalCount();
  updateSyncStatus();
}

// ==================== Toast é€šçŸ¥ ====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ==================== å¾æ—¢æœ‰è²»ç”¨å»ºç«‹ç¯„æœ¬ ====================
function createTemplateFromExpense(id) {
  const exp = state.expenses.find(e => e.id === id);
  if (!exp) return;

  const name = prompt('ç¯„æœ¬åç¨±ï¼š', `${exp.categoryName}${exp.vendor ? ' â€” ' + exp.vendor : ''}`);
  if (!name) return;

  const templates = loadTemplates();
  templates.unshift({
    name,
    categoryCode: exp.categoryCode,
    amount: exp.amount || 0,
    vendor: exp.vendor || '',
    paymentMethod: exp.paymentMethod || 'è½‰å¸³',
    invoiceType: exp.invoiceType || 'é›»å­ç™¼ç¥¨',
    note: exp.note || '',
  });

  if (templates.length > 20) templates.length = 20;
  saveTemplates(templates);
  renderTemplateSelect();
  closeModal();
  showToast(`å·²å„²å­˜ç¯„æœ¬ã€Œ${name}ã€`, 'success');
}

// ==================== â‘  å¸¸ç”¨ç¯„æœ¬ç³»çµ± ====================
const TEMPLATES_KEY = 'outrun_templates';

function loadTemplates() {
  const saved = localStorage.getItem(TEMPLATES_KEY);
  return saved ? JSON.parse(saved) : [];
}

function saveTemplates(templates) {
  localStorage.setItem(TEMPLATES_KEY, JSON.stringify(templates));
}

function renderTemplateSelect() {
  const templates = loadTemplates();
  const container = document.getElementById('templateOptions');
  const emptyEl = document.getElementById('templateEmpty');

  if (templates.length === 0) {
    container.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }

  emptyEl.style.display = 'none';
  container.innerHTML = templates.map((t, i) => {
    const cat = DEFAULT_CATEGORIES.find(c => c.code === t.categoryCode);
    return `
      <div class="custom-select-option" style="justify-content:space-between" onclick="applyTemplate(${i})">
        <span style="display:flex;align-items:center;gap:6px">
          <span class="option-icon">${cat ? cat.icon : 'ğŸ“‹'}</span>
          <span>${t.name}</span>
        </span>
        <span style="display:flex;align-items:center;gap:6px">
          <span style="font-family:var(--font-en);font-size:12px;color:var(--text-dim)">$${numberFormat(t.amount)}</span>
          <button type="button" onclick="event.stopPropagation();removeTemplate(${i})" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:0 2px">âœ•</button>
        </span>
      </div>`;
  }).join('');
}

function saveAsTemplate() {
  const catCode = document.getElementById('expCategory').value;
  const cat = DEFAULT_CATEGORIES.find(c => c.code === catCode);
  const amount = Number(document.getElementById('expAmount').value);

  if (!cat) {
    showToast('è«‹å…ˆå¡«å¯«åˆ†é¡å†å„²å­˜ç¯„æœ¬', 'error');
    return;
  }

  const vendor = document.getElementById('expVendor').value.trim();
  const name = prompt('ç¯„æœ¬åç¨±ï¼š', `${cat.name}${vendor ? ' â€” ' + vendor : ''}`);
  if (!name) return;

  const templates = loadTemplates();
  templates.unshift({
    name,
    categoryCode: catCode,
    amount: amount || 0,
    vendor,
    paymentMethod: document.getElementById('expPayment').value,
    invoiceType: document.getElementById('expInvoiceType').value,
    note: document.getElementById('expNote').value.trim(),
  });

  // æœ€å¤šä¿å­˜ 20 å€‹ç¯„æœ¬
  if (templates.length > 20) templates.length = 20;

  saveTemplates(templates);
  renderTemplateSelect();
  showToast(`å·²å„²å­˜ç¯„æœ¬ã€Œ${name}ã€`, 'success');
}

function applyTemplate(index) {
  const templates = loadTemplates();
  const t = templates[index];
  if (!t) return;

  // å¸¶å…¥å„æ¬„ä½
  if (t.categoryCode) selectCategory(t.categoryCode);
  if (t.amount) document.getElementById('expAmount').value = t.amount;
  if (t.vendor) {
    document.getElementById('expVendor').value = t.vendor;
    document.querySelector('#vendorSelect .custom-select-trigger').innerHTML =
      `<span class="vendor-tag">${t.vendor}</span>`;
  }
  if (t.paymentMethod) document.getElementById('expPayment').value = t.paymentMethod;
  if (t.invoiceType) document.getElementById('expInvoiceType').value = t.invoiceType;
  if (t.note) document.getElementById('expNote').value = t.note;

  // è§¸ç™¼ç¨…é¡è¨ˆç®—
  document.getElementById('expAmount').dispatchEvent(new Event('input', { bubbles: true }));

  document.getElementById('templateSelect').classList.remove('open');
  showToast(`å·²å¥—ç”¨ç¯„æœ¬ã€Œ${t.name}ã€`, 'success');
}

function removeTemplate(index) {
  const templates = loadTemplates();
  const name = templates[index]?.name;
  templates.splice(index, 1);
  saveTemplates(templates);
  renderTemplateSelect();
  showToast(`å·²ç§»é™¤ç¯„æœ¬ã€Œ${name}ã€`, 'success');
}

// ==================== â‘¡ æ‰¹æ¬¡è¨˜å¸³æ¨¡å¼ ====================
function toggleBatchMode() {
  state.settings.batchMode = !state.settings.batchMode;
  updateToggle('toggleBatchMode', state.settings.batchMode);
  updateToggle('toggleBatch', state.settings.batchMode);
  localStorage.setItem(APP_CONFIG.SETTINGS_KEY, JSON.stringify(state.settings));
  showToast(state.settings.batchMode ? 'æ‰¹æ¬¡æ¨¡å¼ï¼šON â€” é€å‡ºå¾Œä¿ç•™åˆ†é¡èˆ‡ä»˜æ¬¾' : 'æ‰¹æ¬¡æ¨¡å¼ï¼šOFF', 'info');
}

// è¦†å¯« resetFormï¼Œæ”¯æ´æ‰¹æ¬¡æ¨¡å¼
const _originalResetForm = resetForm;
resetForm = function() {
  if (state.settings.batchMode) {
    // æ‰¹æ¬¡æ¨¡å¼ï¼šåªæ¸…ç©ºé‡‘é¡ã€ç™¼ç¥¨ã€å‚™è¨»ï¼Œä¿ç•™åˆ†é¡ã€å» å•†ã€ä»˜æ¬¾æ–¹å¼
    document.getElementById('expAmount').value = '';
    document.getElementById('expTax').value = '';
    document.getElementById('expNet').value = '';
    document.getElementById('expInvoice').value = '';
    document.getElementById('expNote').value = '';
    removePhoto();
    hideOcrResult();
    // èšç„¦åˆ°é‡‘é¡
    setTimeout(() => document.getElementById('expAmount').focus(), 100);
  } else {
    _originalResetForm();
  }
};

// ==================== â‘¢ ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼åŒ– & é©—è­‰ ====================
function formatInvoiceNumber(input) {
  let val = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

  // è‡ªå‹•æ’å…¥çŸ­æ©«
  if (val.length > 2) {
    val = val.slice(0, 2) + '-' + val.slice(2);
  }

  // é™åˆ¶é•·åº¦ï¼šXX-12345678ï¼ˆå…± 11 å­—å…ƒå«çŸ­æ©«ï¼‰
  if (val.length > 11) val = val.slice(0, 11);

  input.value = val;
}

function validateInvoiceNumber(input) {
  const val = input.value.trim();
  if (!val) return; // å…è¨±ç©ºç™½

  const pattern = /^[A-Z]{2}-\d{8}$/;
  if (!pattern.test(val)) {
    input.style.borderColor = 'var(--danger)';
    showToast('ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚ºï¼šXX-12345678', 'error');
  } else {
    input.style.borderColor = '';
  }
}

// ==================== â‘£ é ç®—ç®¡ç† & è¶…æ”¯è­¦ç¤º ====================
const BUDGET_KEY = 'outrun_budgets';

function loadBudgets() {
  const saved = localStorage.getItem(BUDGET_KEY);
  return saved ? JSON.parse(saved) : {};
}

function saveBudgets() {
  const budgets = {
    'éŠ·å”®è²»ç”¨': Number(document.getElementById('budget_sales').value) || 0,
    'ç®¡ç†è²»ç”¨': Number(document.getElementById('budget_admin').value) || 0,
    'ç‡Ÿæ¥­è²»ç”¨': Number(document.getElementById('budget_ops').value) || 0,
    'ç¨…å‹™è²»ç”¨': Number(document.getElementById('budget_tax').value) || 0,
    total: Number(document.getElementById('budget_total').value) || 0,
  };

  localStorage.setItem(BUDGET_KEY, JSON.stringify(budgets));
  showToast('é ç®—è¨­å®šå·²å„²å­˜', 'success');
  renderStats(); // é‡æ–°æ¸²æŸ“çµ±è¨ˆ
}

function loadBudgetUI() {
  const budgets = loadBudgets();
  const fields = {
    'éŠ·å”®è²»ç”¨': 'budget_sales',
    'ç®¡ç†è²»ç”¨': 'budget_admin',
    'ç‡Ÿæ¥­è²»ç”¨': 'budget_ops',
    'ç¨…å‹™è²»ç”¨': 'budget_tax',
  };

  for (const [cat, fieldId] of Object.entries(fields)) {
    const el = document.getElementById(fieldId);
    if (el && budgets[cat]) el.value = budgets[cat];
  }

  if (budgets.total) {
    document.getElementById('budget_total').value = budgets.total;
  }
}

function renderBudgetProgress(filtered) {
  const budgets = loadBudgets();
  const hasBudget = Object.values(budgets).some(v => v > 0);
  const card = document.getElementById('budgetCard');

  if (!hasBudget) {
    card.style.display = 'none';
    return;
  }

  card.style.display = 'block';

  const byParent = {};
  filtered.forEach(exp => {
    if (!byParent[exp.parentCategory]) byParent[exp.parentCategory] = 0;
    byParent[exp.parentCategory] += Number(exp.amount) || 0;
  });

  const totalSpent = filtered.reduce((s, e) => s + (Number(e.amount) || 0), 0);
  let anyOver = false;

  const cats = [
    { key: 'éŠ·å”®è²»ç”¨', icon: 'ğŸª' },
    { key: 'ç®¡ç†è²»ç”¨', icon: 'ğŸ“‹' },
    { key: 'ç‡Ÿæ¥­è²»ç”¨', icon: 'ğŸ¢' },
    { key: 'ç¨…å‹™è²»ç”¨', icon: 'ğŸ›ï¸' },
  ];

  let html = '';

  // å„åˆ†é¡é ç®—
  cats.forEach(({ key, icon }) => {
    const budget = budgets[key];
    if (!budget) return;

    const spent = byParent[key] || 0;
    const pct = Math.min(spent / budget * 100, 100);
    const status = pct >= 100 ? 'over' : pct >= 80 ? 'warn' : 'ok';
    if (status === 'over') anyOver = true;

    html += `
      <div class="budget-row">
        <div class="budget-row-header">
          <span class="budget-row-label">${icon} ${key}</span>
          <span class="budget-row-amount ${status}">
            $${numberFormat(spent)} / $${numberFormat(budget)}
            ${status === 'over' ? '<span class="budget-over-tag">è¶…æ”¯</span>' : ''}
          </span>
        </div>
        <div class="budget-bar">
          <div class="budget-bar-fill ${status}" style="width:${pct}%"></div>
        </div>
      </div>`;
  });

  // ç¸½é ç®—
  if (budgets.total) {
    const pct = Math.min(totalSpent / budgets.total * 100, 100);
    const status = pct >= 100 ? 'over' : pct >= 80 ? 'warn' : 'ok';
    if (status === 'over') anyOver = true;

    html += `
      <div class="budget-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08)">
        <div class="budget-row-header">
          <span class="budget-row-label" style="font-weight:600">ğŸ’° ç¸½é ç®—</span>
          <span class="budget-row-amount ${status}" style="font-size:13px">
            $${numberFormat(totalSpent)} / $${numberFormat(budgets.total)}
            ${status === 'over' ? '<span class="budget-over-tag">è¶…æ”¯</span>' : ''}
          </span>
        </div>
        <div class="budget-bar" style="height:10px">
          <div class="budget-bar-fill ${status}" style="width:${pct}%"></div>
        </div>
      </div>`;
  }

  document.getElementById('budgetBars').innerHTML = html;

  // æ›´æ–° badge
  const badge = document.getElementById('budgetBadge');
  if (anyOver) {
    badge.textContent = 'OVER BUDGET';
    badge.style.background = 'rgba(229, 57, 53, 0.15)';
    badge.style.color = 'var(--danger)';
  } else {
    badge.textContent = 'ON TRACK';
    badge.style.background = 'rgba(67, 160, 71, 0.15)';
    badge.style.color = 'var(--success)';
  }
}

// ==================== â‘¤ æœˆå ±è‡ªå‹•å¯„é€ ====================
function setupAutoReport() {
  const email = document.getElementById('settingReportEmail').value.trim();
  if (!email) {
    showToast('è«‹è¼¸å…¥æ”¶ä»¶äºº Email', 'error');
    return;
  }

  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
    return;
  }

  // å„²å­˜ email
  state.settings.reportEmail = email;
  localStorage.setItem(APP_CONFIG.SETTINGS_KEY, JSON.stringify(state.settings));

  // å‘¼å« Apps Script è¨­å®š Time Trigger
  callApi('POST', {
    action: 'setupAutoReport',
    email: email,
  }).then(res => {
    if (res.success) {
      showToast('è‡ªå‹•å¯„é€å·²è¨­å®šï¼æ¯æœˆ 1 è™Ÿæœƒè‡ªå‹•å¯„å‡ºå ±è¡¨', 'success');
    } else {
      showToast('è¨­å®šå¤±æ•—ï¼š' + (res.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
      showAutoReportScript(email);
    }
  }).catch(() => {
    // API å°šæœªæ”¯æ´ï¼Œæä¾›æ‰‹å‹•éƒ¨ç½²æŒ‡å¼•
    showAutoReportScript(email);
  });
}

function showAutoReportScript(email) {
  // é¡¯ç¤ºè©³ç´°çš„åœ–æ–‡æ­¥é©ŸæŒ‡å¼•
  const modal = document.getElementById('detailModal');
  const content = document.getElementById('modalContent');
  content.innerHTML = `
    <h3 style="font-size:16px;margin-bottom:16px">ğŸ“§ æœˆå ±è‡ªå‹•å¯„é€ â€” è¨­å®šæ•™å­¸</h3>

    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.7">
      è¨­å®šå®Œæˆå¾Œï¼Œç³»çµ±æœƒåœ¨<strong style="color:var(--orange)">æ¯æœˆ 1 è™Ÿä¸Šåˆ 8 é»</strong>è‡ªå‹•å¯„å‡ºä¸Šæœˆçš„è²»ç”¨å½™ç¸½å ±è¡¨åˆ° <strong style="color:var(--orange)">${email}</strong>ã€‚
    </div>

    <div style="font-size:13px;line-height:1.8">

      <div style="background:rgba(237,93,43,0.08);border-left:3px solid var(--orange);padding:12px 14px;border-radius:0 6px 6px 0;margin-bottom:14px">
        <div style="font-weight:700;color:var(--orange);margin-bottom:6px">å¥½æ¶ˆæ¯ï¼å¦‚æœä½ å·²ç¶“æ›´æ–°äº† Apps Script</div>
        <div style="color:var(--text-secondary);font-size:12px">
          å¦‚æœä½ å·²ç¶“ç”¨æœ€æ–°ç‰ˆçš„ <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:3px;font-size:11px">expense-tracker-apps-script.js</code> æ›¿æ›äº† Apps Script çš„ç¨‹å¼ç¢¼ä¸¦é‡æ–°éƒ¨ç½²ï¼Œé‚£æœˆå ±åŠŸèƒ½å…¶å¯¦<strong>å·²ç¶“å…§å»ºäº†</strong>ï¼<br>
          åªè¦å†åšä¸‹é¢çš„ã€Œæ­¥é©Ÿå››ã€å°±å¥½ã€‚
        </div>
      </div>

      <div style="margin-bottom:16px">
        <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">ğŸ“Œ æ­¥é©Ÿä¸€ï¼šæ‰“é–‹ ERP è©¦ç®—è¡¨çš„ Apps Script ç·¨è¼¯å™¨</div>
        <ol style="padding-left:20px;color:var(--text-secondary);font-size:12px;line-height:2">
          <li>æ‰“é–‹ä½ çš„ ERP Google Sheets è©¦ç®—è¡¨</li>
          <li>é»ä¸Šæ–¹é¸å–®ã€Œ<strong style="color:var(--text-primary)">æ“´å……åŠŸèƒ½</strong>ã€â†’ã€Œ<strong style="color:var(--text-primary)">Apps Script</strong>ã€</li>
          <li>æœƒé–‹å•Ÿä¸€å€‹æ–°åˆ†é ï¼Œé€™å°±æ˜¯ Apps Script ç·¨è¼¯å™¨</li>
        </ol>
      </div>

      <div style="margin-bottom:16px">
        <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">ğŸ“Œ æ­¥é©ŸäºŒï¼šç¢ºèªç¨‹å¼ç¢¼å·²åŒ…å«æœˆå ±åŠŸèƒ½</div>
        <ol style="padding-left:20px;color:var(--text-secondary);font-size:12px;line-height:2">
          <li>åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­ï¼ŒæŒ‰ <strong style="color:var(--text-primary)">Ctrl+F</strong>ï¼ˆMac æŒ‰ Cmd+Fï¼‰æœå°‹</li>
          <li>è¼¸å…¥ <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:3px;font-size:11px">sendMonthlyReport</code></li>
          <li>å¦‚æœæ‰¾åˆ°äº† â†’ è¡¨ç¤ºæœˆå ±åŠŸèƒ½å·²å…§å»ºï¼Œç›´æ¥è·³åˆ°<strong>æ­¥é©Ÿå››</strong></li>
          <li>å¦‚æœæ‰¾ä¸åˆ° â†’ ä»£è¡¨éœ€è¦æ›´æ–°ç¨‹å¼ç¢¼ï¼Œé€²å…¥<strong>æ­¥é©Ÿä¸‰</strong></li>
        </ol>
      </div>

      <div style="margin-bottom:16px">
        <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">ğŸ“Œ æ­¥é©Ÿä¸‰ï¼šæ›´æ–° Apps Script ç¨‹å¼ç¢¼ï¼ˆå¦‚æœéœ€è¦ï¼‰</div>
        <ol style="padding-left:20px;color:var(--text-secondary);font-size:12px;line-height:2">
          <li>å°‡ <code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:3px;font-size:11px">expense-tracker-apps-script.js</code> æª”æ¡ˆçš„å®Œæ•´å…§å®¹è¤‡è£½</li>
          <li>åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­ï¼Œ<strong style="color:var(--text-primary)">å…¨é¸</strong>ç¾æœ‰çš„ç¨‹å¼ç¢¼ï¼ˆCtrl+A / Cmd+Aï¼‰</li>
          <li><strong style="color:var(--text-primary)">è²¼ä¸Š</strong>æ–°çš„ç¨‹å¼ç¢¼ï¼ˆCtrl+V / Cmd+Vï¼‰è¦†è“‹</li>
          <li>é»å·¦ä¸Šæ–¹çš„ ğŸ’¾ <strong style="color:var(--text-primary)">å„²å­˜</strong>ï¼ˆæˆ–æŒ‰ Ctrl+Sï¼‰</li>
          <li>é‡æ–°éƒ¨ç½²ï¼šé»ã€Œ<strong style="color:var(--text-primary)">éƒ¨ç½²</strong>ã€â†’ã€Œ<strong style="color:var(--text-primary)">ç®¡ç†éƒ¨ç½²</strong>ã€â†’ å³ä¸Šè§’é‰›ç­† âœï¸ â†’ã€Œç‰ˆæœ¬ã€é¸ã€Œ<strong style="color:var(--text-primary)">å»ºç«‹æ–°ç‰ˆæœ¬</strong>ã€â†’ã€Œ<strong style="color:var(--text-primary)">éƒ¨ç½²</strong>ã€</li>
        </ol>
      </div>

      <div style="margin-bottom:16px">
        <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px">ğŸ“Œ æ­¥é©Ÿå››ï¼šå»ºç«‹æ¯æœˆè‡ªå‹•è§¸ç™¼å™¨ï¼ˆæœ€é—œéµçš„ä¸€æ­¥ï¼ï¼‰</div>
        <ol style="padding-left:20px;color:var(--text-secondary);font-size:12px;line-height:2">
          <li>åœ¨ Apps Script ç·¨è¼¯å™¨å·¦å´ï¼Œé»é¸ â°ã€Œ<strong style="color:var(--text-primary)">è§¸ç™¼æ¢ä»¶</strong>ã€ï¼ˆæ™‚é˜åœ–ç¤ºï¼‰</li>
          <li>é»å³ä¸‹è§’ã€Œ<strong style="color:var(--text-primary)">+ æ–°å¢è§¸ç™¼æ¢ä»¶</strong>ã€</li>
          <li>è¨­å®šå¦‚ä¸‹ï¼š
            <div style="background:rgba(0,0,0,0.3);border-radius:6px;padding:10px 12px;margin:6px 0;font-size:11px;line-height:1.8">
              <div>ãƒ»é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½ï¼š<strong style="color:var(--orange)">sendMonthlyReport</strong></div>
              <div>ãƒ»é¸å–äº‹ä»¶ä¾†æºï¼š<strong style="color:var(--orange)">æ™‚é–“é©…å‹•</strong></div>
              <div>ãƒ»é¸å–æ™‚é–“å‹è§¸ç™¼æ¢ä»¶çš„é¡å‹ï¼š<strong style="color:var(--orange)">æœˆè¨ˆæ™‚å™¨</strong></div>
              <div>ãƒ»é¸å–æœˆä»½ä¸­çš„æ—¥æœŸï¼š<strong style="color:var(--orange)">1</strong>ï¼ˆæ¯æœˆ 1 è™Ÿï¼‰</div>
              <div>ãƒ»é¸å–æ™‚æ®µï¼š<strong style="color:var(--orange)">ä¸Šåˆ 8 é»åˆ° 9 é»</strong></div>
            </div>
          </li>
          <li>é»ã€Œ<strong style="color:var(--text-primary)">å„²å­˜</strong>ã€</li>
          <li>ç¬¬ä¸€æ¬¡å¯èƒ½æœƒè¦æ±‚æˆæ¬Š â†’ é»ã€Œ<strong style="color:var(--text-primary)">å¯©æŸ¥æ¬Šé™</strong>ã€â†’ é¸ä½ çš„ Google å¸³è™Ÿ â†’ å¦‚æœå‡ºç¾ã€Œé€™å€‹æ‡‰ç”¨ç¨‹å¼æœªç¶“é©—è­‰ã€â†’ é»ã€Œ<strong style="color:var(--text-primary)">é€²éš</strong>ã€â†’ã€Œ<strong style="color:var(--text-primary)">å‰å¾€ï¼ˆä¸å®‰å…¨ï¼‰</strong>ã€â†’ã€Œ<strong style="color:var(--text-primary)">å…è¨±</strong>ã€</li>
        </ol>
      </div>

      <div style="background:rgba(67,160,71,0.1);border-left:3px solid var(--success);padding:10px 14px;border-radius:0 6px 6px 0;margin-bottom:12px">
        <div style="font-weight:700;color:var(--success);margin-bottom:4px">âœ… å®Œæˆï¼</div>
        <div style="color:var(--text-secondary);font-size:12px">
          è¨­å®šå¥½ä¹‹å¾Œï¼Œæ¯æœˆ 1 è™Ÿä¸Šåˆ 8~9 é»ï¼Œç³»çµ±æœƒè‡ªå‹•ç¯©é¸ä¸Šå€‹æœˆçš„æ‰€æœ‰è²»ç”¨ç´€éŒ„ï¼Œå½™ç¸½å¾Œå¯„åˆ° ${email}ã€‚ä¿¡ä»¶å…§å®¹åŒ…å«ï¼šè²»ç”¨ç­†æ•¸ã€ç¸½é¡ã€ç¨…é¡ã€å„åˆ†é¡é‡‘é¡æ˜ç´°ã€ä»˜æ¬¾æ–¹å¼æ˜ç´°ï¼Œä»¥åŠ Google Sheets é€£çµã€‚
        </div>
      </div>

      <div style="font-size:11px;color:var(--text-dim);line-height:1.6">
        ğŸ’¡ å°æé†’ï¼šå¦‚æœæƒ³é¦¬ä¸Šæ¸¬è©¦çœ‹çœ‹æœ‰æ²’æœ‰è¨­å®šæˆåŠŸï¼Œå¯ä»¥åœ¨ Apps Script ç·¨è¼¯å™¨çš„ç¨‹å¼ç¢¼ä¸­æ‰¾åˆ° <code style="background:rgba(0,0,0,0.3);padding:1px 4px;border-radius:3px">testSendMonthlyReport</code> å‡½æ•¸ï¼Œé¸å®ƒä¸¦æŒ‰ â–¶ åŸ·è¡Œï¼Œå°±æœƒç«‹å³å¯„å‡ºä¸€å°æ¸¬è©¦å ±è¡¨ã€‚
      </div>

    </div>

    <div class="btn-group" style="margin-top:16px">
      <button class="btn btn-secondary btn-sm" onclick="closeModal()" style="flex:1">æˆ‘çŸ¥é“äº†</button>
    </div>
  `;
  modal.classList.add('active');
}

// ==================== â‘¥ å» å•†é›²ç«¯åŒæ­¥ ====================

/**
 * å°‡æœ¬åœ°å» å•†åå–®ä¸Šå‚³åˆ° Google Sheetsï¼ˆ07_å» å•†åå–®ï¼‰
 */
async function syncVendorsToCloud() {
  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
    return;
  }

  try {
    showToast('æ­£åœ¨ä¸Šå‚³å» å•†åå–®...', 'info');
    const res = await callApi('POST', {
      action: 'syncVendors',
      vendors: state.vendors,
    });

    if (res.success) {
      showToast(`å·²åŒæ­¥ ${state.vendors.length} ç­†å» å•†åˆ°é›²ç«¯`, 'success');
    } else {
      showToast('åŒæ­¥å¤±æ•—ï¼š' + (res.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
    }
  } catch (err) {
    showToast('å» å•†åŒæ­¥åŠŸèƒ½éœ€è¦æ›´æ–° Apps Script å¾Œç«¯', 'info');
  }
}

/**
 * å¾ Google Sheetsï¼ˆ07_å» å•†åå–®ï¼‰åŒ¯å…¥å» å•†åå–®åˆ°æœ¬åœ°
 */
async function pullVendorsFromCloud() {
  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
    return;
  }

  try {
    showToast('æ­£åœ¨å¾é›²ç«¯åŒ¯å…¥å» å•†åå–®...', 'info');
    const res = await callApi('GET', { action: 'getVendors' });

    if (res.success && Array.isArray(res.data)) {
      const cloudVendors = res.data;
      if (cloudVendors.length === 0) {
        showToast('é›²ç«¯å°šç„¡å» å•†è³‡æ–™', 'info');
        return;
      }

      // åˆä½µç­–ç•¥ï¼šé›²ç«¯æœ‰ä½†æœ¬åœ°æ²’æœ‰çš„ â†’ æ–°å¢
      let added = 0;
      cloudVendors.forEach(cv => {
        if (!cv.name) return;
        if (!state.vendors.some(v => v.name === cv.name)) {
          state.vendors.push({
            name: cv.name,
            note: cv.note || '',
            usedAt: cv.usedAt || '',
            createdAt: cv.createdAt || new Date().toISOString(),
          });
          added++;
        }
      });

      saveVendors();
      renderVendorSelect();
      renderVendorList();

      if (added > 0) {
        showToast(`å¾é›²ç«¯åŒ¯å…¥ ${added} ç­†æ–°å» å•†ï¼ˆå…± ${cloudVendors.length} ç­†ï¼‰`, 'success');
      } else {
        showToast(`é›²ç«¯ ${cloudVendors.length} ç­†å» å•†çš†å·²å­˜åœ¨æœ¬åœ°`, 'info');
      }
    } else {
      showToast('åŒ¯å…¥å¤±æ•—ï¼š' + (res.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
    }
  } catch (err) {
    showToast('å¾é›²ç«¯åŒ¯å…¥å» å•†éœ€è¦æ›´æ–° Apps Script å¾Œç«¯', 'info');
  }
}

// ==================== PWA é›¢ç·šå®‰è£ ====================
(function initPWA() {
  // å‹•æ…‹ç”¢ç”Ÿ Web App Manifest
  const manifest = {
    name: 'å …å¿ƒè¨˜å¸³ â€” Outrun Nutrition',
    short_name: 'å …å¿ƒè¨˜å¸³',
    description: 'Outrun Nutrition ç‡Ÿé‹è¨˜å¸³ç³»çµ±',
    start_url: location.href.split('?')[0],
    display: 'standalone',
    background_color: '#2F2F2F',
    theme_color: '#2F2F2F',
    icons: [
      {
        src: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="32" fill="#2F2F2F"/><text x="96" y="130" text-anchor="middle" font-size="110">ğŸ¥œ</text></svg>'),
        sizes: '192x192',
        type: 'image/svg+xml',
      },
      {
        src: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="64" fill="#2F2F2F"/><text x="256" y="340" text-anchor="middle" font-size="280">ğŸ¥œ</text></svg>'),
        sizes: '512x512',
        type: 'image/svg+xml',
      },
    ],
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const manifestUrl = URL.createObjectURL(manifestBlob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestUrl;
  document.head.appendChild(link);

  // PWA å®‰è£æç¤º
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showInstallBanner();
  });

  window.showInstallBanner = function() {
    if (!deferredPrompt) return;
    const existing = document.getElementById('pwaInstallBanner');
    if (existing) existing.remove();

    const banner = document.createElement('div');
    banner.id = 'pwaInstallBanner';
    banner.style.cssText = 'position:fixed;bottom:70px;left:12px;right:12px;background:var(--dark-gray);border:1px solid var(--orange);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
    banner.innerHTML = `
      <div style="font-size:28px">ğŸ“²</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:14px">åŠ åˆ°ä¸»ç•«é¢</div>
        <div style="font-size:11px;color:var(--text-secondary)">å®‰è£å …å¿ƒè¨˜å¸³ Appï¼Œé›¢ç·šä¹Ÿèƒ½ä½¿ç”¨</div>
      </div>
      <button onclick="installPWA()" style="background:var(--orange);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer">å®‰è£</button>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px">âœ•</button>
    `;
    document.body.appendChild(banner);
  };

  window.installPWA = async function() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    if (result.outcome === 'accepted') {
      showToast('å·²å®‰è£åˆ°ä¸»ç•«é¢ï¼', 'success');
    }
    deferredPrompt = null;
    const banner = document.getElementById('pwaInstallBanner');
    if (banner) banner.remove();
  };
})();
</script>
</body>
</html>
