<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å …å¿ƒå ±åƒ¹æ¡è³¼">
<meta name="theme-color" content="#2F2F2F">
<meta name="mobile-web-app-capable" content="yes">
<title>å …å¿ƒå ±åƒ¹/æ¡è³¼ â€” Outrun Nutrition</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
/* ==================== åŸºç¤è¨­å®š ==================== */
:root {
  --black: #2F2F2F;
  --orange: #ED5D2B;
  --orange-hover: #d14e1f;
  --blue: #145DDD;
  --dark-gray: #3A3A3A;
  --card-gray: #444444;
  --text-primary: #E0E0E0;
  --text-secondary: #A0A0A0;
  --text-dim: #707070;
  --danger: #E53935;
  --success: #43A047;
  --warning: #FB8C00;
  --radius-lg: 12px;
  --radius-sm: 6px;
  --radius-xs: 4px;
  --font-zh: 'Noto Sans TC', sans-serif;
  --font-en: 'Montserrat', sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; }
body {
  font-family: var(--font-zh);
  background: var(--black);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ==================== é ‚éƒ¨å°è¦½ ==================== */
.top-bar {
  background: var(--dark-gray);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  border-bottom: 1px solid rgba(237, 93, 43, 0.3);
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-icon {
  width: 32px; height: 32px;
  background: var(--orange);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
}
.brand-name {
  font-family: var(--font-en);
  font-weight: 700; font-size: 14px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--orange);
}
.brand-sub { font-size: 11px; color: var(--text-secondary); }
.sync-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; color: var(--text-secondary);
}
.sync-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--success);
}
.sync-dot.offline { background: var(--warning); }

/* ==================== åˆ†é å°è¦½ ==================== */
.tab-nav {
  display: flex;
  background: var(--dark-gray);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-btn {
  flex: 1; min-width: 70px;
  padding: 10px 6px;
  background: none; border: none;
  color: var(--text-secondary);
  font-family: var(--font-zh);
  font-size: 12px; font-weight: 500;
  cursor: pointer; text-align: center;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}
.tab-btn.active { color: var(--orange); border-bottom-color: var(--orange); }
.tab-btn:hover { color: var(--text-primary); }
.tab-icon { font-size: 16px; display: block; margin-bottom: 2px; }

/* ==================== ä¸»å…§å®¹å€ ==================== */
.main-content { max-width: 640px; margin: 0 auto; padding: 16px; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ==================== å¡ç‰‡å…ƒä»¶ ==================== */
.card {
  background: var(--dark-gray);
  border-radius: var(--radius-lg);
  padding: 20px; margin-bottom: 16px;
}
.card-header {
  display: flex; align-items: center;
  justify-content: space-between; margin-bottom: 16px;
}
.card-title { font-size: 15px; font-weight: 700; color: var(--text-primary); }
.card-badge {
  font-family: var(--font-en);
  font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.08em;
  padding: 3px 8px; border-radius: var(--radius-xs);
  background: rgba(237, 93, 43, 0.15); color: var(--orange);
}

/* ==================== è¡¨å–®å…ƒä»¶ ==================== */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 13px; font-weight: 500;
  color: var(--text-secondary); margin-bottom: 6px;
}
.form-label .required { color: var(--orange); margin-left: 2px; }
.form-input, .form-select, .form-textarea {
  width: 100%; padding: 10px 12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh); font-size: 15px;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  outline: none; border-color: var(--orange);
  background: rgba(237, 93, 43, 0.05);
}
.form-input::placeholder { color: var(--text-dim); }
.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23A0A0A0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  color-scheme: dark;
}
.form-select option { background: var(--dark-gray); color: var(--text-primary); }
.form-textarea { resize: vertical; min-height: 60px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* ==================== æŒ‰éˆ• ==================== */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 6px; padding: 12px 24px; border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-zh); font-size: 14px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; text-decoration: none;
}
.btn-primary {
  background: var(--orange); color: #fff;
  width: 100%; padding: 14px; font-size: 16px;
}
.btn-primary:hover { background: var(--orange-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: rgba(255,255,255,0.08); color: var(--text-primary); }
.btn-secondary:hover { background: rgba(255,255,255,0.12); }
.btn-outline {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--text-primary);
}
.btn-outline:hover { border-color: var(--orange); color: var(--orange); }
.btn-danger { background: rgba(229, 57, 53, 0.15); color: var(--danger); }
.btn-danger:hover { background: rgba(229, 57, 53, 0.25); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; margin-top: 16px; }

/* ==================== æ˜ç´°è¡Œè¡¨æ ¼ ==================== */
.line-items { margin-bottom: 16px; }
.line-item {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius-sm);
  padding: 12px; margin-bottom: 8px;
  position: relative;
}
.line-item-header {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 8px;
}
.line-item-num {
  font-family: var(--font-en); font-size: 11px;
  font-weight: 600; color: var(--orange);
}
.line-item-remove {
  width: 24px; height: 24px; border: none;
  background: rgba(229, 57, 53, 0.1);
  border-radius: 50%; color: var(--danger);
  font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.line-item-remove:hover { background: rgba(229, 57, 53, 0.25); }
.line-item .form-group { margin-bottom: 8px; }
.line-item .form-label { font-size: 11px; margin-bottom: 4px; }
.line-item .form-input, .line-item .form-select {
  padding: 8px 10px; font-size: 13px;
}
.line-item-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.line-item-subtotal {
  text-align: right; font-family: var(--font-en);
  font-size: 14px; font-weight: 600; color: var(--orange);
  padding-top: 4px;
}
.add-line-btn {
  width: 100%; padding: 10px; border: 2px dashed rgba(255,255,255,0.12);
  border-radius: var(--radius-sm); background: none;
  color: var(--text-secondary); font-family: var(--font-zh);
  font-size: 13px; cursor: pointer; transition: all 0.2s;
}
.add-line-btn:hover {
  border-color: var(--orange); color: var(--orange);
  background: rgba(237, 93, 43, 0.05);
}

/* ==================== é‡‘é¡åŒ¯ç¸½ ==================== */
.amount-summary {
  border-top: 1px solid rgba(255,255,255,0.08);
  padding-top: 12px; margin-top: 8px;
}
.amount-row {
  display: flex; justify-content: space-between;
  align-items: center; padding: 6px 0;
  font-size: 14px;
}
.amount-row .label { color: var(--text-secondary); }
.amount-row .value {
  font-family: var(--font-en); font-weight: 600;
}
.amount-row.total {
  border-top: 2px solid var(--orange);
  padding-top: 10px; margin-top: 6px;
  font-size: 18px;
}
.amount-row.total .label { color: var(--text-primary); font-weight: 700; }
.amount-row.total .value { color: var(--orange); font-weight: 700; }
.amount-row.discount .value { color: var(--success); }

/* ==================== åˆ—è¡¨å¡ç‰‡ ==================== */
.doc-card {
  background: var(--dark-gray);
  border-radius: var(--radius-lg);
  padding: 16px; margin-bottom: 10px;
  cursor: pointer; transition: all 0.2s;
  border: 1px solid transparent;
}
.doc-card:hover { border-color: rgba(237, 93, 43, 0.3); }
.doc-card-top {
  display: flex; justify-content: space-between;
  align-items: flex-start; margin-bottom: 8px;
}
.doc-card-id {
  font-family: var(--font-en); font-size: 13px;
  font-weight: 600; color: var(--text-primary);
}
.doc-card-date { font-size: 12px; color: var(--text-dim); }
.doc-card-mid {
  display: flex; justify-content: space-between;
  align-items: center;
}
.doc-card-name { font-size: 14px; font-weight: 500; }
.doc-card-amount {
  font-family: var(--font-en); font-size: 16px;
  font-weight: 700; color: var(--orange);
}
.doc-card-bottom {
  display: flex; justify-content: space-between;
  align-items: center; margin-top: 8px;
}
.doc-card-recorder { font-size: 11px; color: var(--text-dim); }

/* ==================== ç‹€æ…‹æ¨™ç±¤ ==================== */
.status-tag {
  display: inline-block; padding: 2px 8px;
  border-radius: var(--radius-xs);
  font-size: 11px; font-weight: 600;
}
.status-draft { background: rgba(160,160,160,0.15); color: var(--text-secondary); }
.status-sent { background: rgba(20,93,221,0.15); color: var(--blue); }
.status-accepted { background: rgba(67,160,71,0.15); color: var(--success); }
.status-rejected { background: rgba(229,57,53,0.15); color: var(--danger); }
.status-pending { background: rgba(251,140,0,0.15); color: var(--warning); }
.status-confirmed { background: rgba(20,93,221,0.15); color: var(--blue); }
.status-delivered { background: rgba(67,160,71,0.15); color: var(--success); }
.status-invoiced { background: rgba(237,93,43,0.15); color: var(--orange); }
.status-paid { background: rgba(67,160,71,0.25); color: var(--success); }

/* ==================== æœå°‹åˆ— ==================== */
.search-bar {
  display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;
}
.search-bar input {
  flex: 1; min-width: 120px; padding: 8px 12px;
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh); font-size: 13px;
}
.search-bar input:focus { outline: none; border-color: var(--orange); }
.search-bar input::placeholder { color: var(--text-dim); }
.search-bar select {
  padding: 8px 10px;
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-zh); font-size: 13px;
  color-scheme: dark;
}

/* ==================== æœˆä»½é¸æ“‡å™¨ ==================== */
.month-nav {
  display: flex; align-items: center;
  justify-content: center; gap: 16px;
  margin-bottom: 16px;
}
.month-nav button {
  width: 36px; height: 36px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 50%; color: var(--text-primary);
  font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.month-nav button:hover { border-color: var(--orange); color: var(--orange); }
.month-nav .month-label {
  font-family: var(--font-en); font-size: 16px;
  font-weight: 600; min-width: 120px; text-align: center;
}

/* ==================== çµ±è¨ˆå¡ç‰‡ ==================== */
.stats-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 10px; margin-bottom: 16px;
}
.stat-card {
  background: var(--dark-gray);
  border-radius: var(--radius-lg);
  padding: 16px; text-align: center;
}
.stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.stat-value {
  font-family: var(--font-en); font-size: 22px;
  font-weight: 700; color: var(--text-primary);
}
.stat-value.orange { color: var(--orange); }

/* ==================== è¶¨å‹¢åœ– ==================== */
.trend-chart {
  display: flex; align-items: flex-end;
  gap: 4px; height: 120px; padding: 8px 0;
}
.trend-bar-wrap {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; height: 100%;
}
.trend-bar {
  width: 100%; max-width: 28px;
  background: var(--orange);
  border-radius: 3px 3px 0 0;
  transition: height 0.3s; min-height: 2px;
}
.trend-bar.blue { background: var(--blue); }
.trend-label {
  font-size: 10px; color: var(--text-dim);
  margin-top: 4px; font-family: var(--font-en);
}
.trend-value {
  font-size: 9px; color: var(--text-secondary);
  margin-bottom: 4px; font-family: var(--font-en);
  white-space: nowrap;
}
.trend-summary {
  display: flex; justify-content: space-between;
  padding: 8px 0; border-top: 1px solid rgba(255,255,255,0.08);
  margin-top: 8px; font-size: 12px; color: var(--text-secondary);
}
.trend-summary strong { color: var(--text-primary); font-family: var(--font-en); }

/* ==================== Modal ==================== */
.modal-overlay {
  display: none; position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200; align-items: flex-end;
  justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal-box {
  background: var(--black);
  border-radius: 16px 16px 0 0;
  width: 100%; max-width: 640px;
  max-height: 85vh; overflow-y: auto;
  padding: 20px; animation: slideUp 0.25s ease;
}
.modal-box h3 { font-size: 16px; margin-bottom: 16px; }
.modal-close {
  float: right; background: none; border: none;
  color: var(--text-dim); font-size: 24px;
  cursor: pointer; padding: 0 4px;
}
.modal-close:hover { color: var(--text-primary); }

/* ==================== Toast ==================== */
.toast {
  position: fixed; top: 16px; left: 50%;
  transform: translateX(-50%);
  background: var(--dark-gray);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  padding: 12px 20px; font-size: 13px;
  z-index: 999; animation: fadeSlideIn 0.3s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  max-width: 90%; text-align: center;
}
.toast.success { border-color: var(--success); color: var(--success); }
.toast.error { border-color: var(--danger); color: var(--danger); }
.toast.info { border-color: var(--blue); color: var(--blue); }

/* ==================== ç”¢å“ç›®éŒ„ç®¡ç† ==================== */
.product-list-item {
  display: flex; justify-content: space-between;
  align-items: center; padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.product-list-item:last-child { border-bottom: none; }
.product-info { flex: 1; }
.product-name { font-size: 14px; font-weight: 500; }
.product-spec { font-size: 12px; color: var(--text-secondary); }
.product-price {
  font-family: var(--font-en); font-size: 14px;
  font-weight: 600; color: var(--orange); margin-right: 12px;
}

/* ==================== å‹•ç•« ==================== */
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateX(-50%) translateY(-12px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

/* ==================== éŸ¿æ‡‰å¼ ==================== */
@media (max-width: 380px) {
  .tab-btn { font-size: 11px; padding: 8px 4px; }
  .tab-icon { font-size: 14px; }
  .form-row, .line-item-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ==================== é ‚éƒ¨å“ç‰Œåˆ— ==================== -->
<div class="top-bar">
  <div class="brand">
    <div class="brand-icon">ğŸ¥œ</div>
    <div>
      <div class="brand-name">Outrun Nutrition</div>
      <div class="brand-sub">å ±åƒ¹ / æ¡è³¼ç®¡ç†</div>
    </div>
  </div>
  <div class="sync-status">
    <div class="sync-dot" id="syncDot"></div>
    <span id="syncLabel">æœ¬æ©Ÿ</span>
  </div>
</div>

<!-- ==================== åˆ†é å°è¦½ ==================== -->
<nav class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('quote')">
    <span class="tab-icon">ğŸ“</span>æ–°å¢å ±åƒ¹
  </button>
  <button class="tab-btn" onclick="switchTab('po')">
    <span class="tab-icon">ğŸ“¦</span>æ–°å¢æ¡è³¼
  </button>
  <button class="tab-btn" onclick="switchTab('list')">
    <span class="tab-icon">ğŸ“‹</span>å–®æ“šåˆ—è¡¨
  </button>
  <button class="tab-btn" onclick="switchTab('stats')">
    <span class="tab-icon">ğŸ“Š</span>çµ±è¨ˆ
  </button>
  <button class="tab-btn" onclick="switchTab('settings')">
    <span class="tab-icon">âš™ï¸</span>è¨­å®š
  </button>
</nav>

<div class="main-content">

<!-- ==================== Tab 1: æ–°å¢å ±åƒ¹å–® ==================== -->
<div id="tab-quote" class="tab-panel active">
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“ å ±åƒ¹å–®</span>
      <span class="card-badge">QUOTATION</span>
    </div>

    <!-- æ—¥æœŸ -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">å ±åƒ¹æ—¥æœŸ</label>
        <input type="date" id="quoteDate" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">æœ‰æ•ˆæœŸé™</label>
        <input type="date" id="quoteValidUntil" class="form-input">
      </div>
    </div>

    <!-- å®¢æˆ¶è³‡è¨Š -->
    <div class="form-group">
      <label class="form-label">å®¢æˆ¶åç¨± <span class="required">*</span></label>
      <input type="text" id="quoteCustName" class="form-input" placeholder="å…¬å¸æˆ–å€‹äººåç¨±">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">è¯ç¹«äºº</label>
        <input type="text" id="quoteCustContact" class="form-input" placeholder="å§“å">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±</label>
        <input type="tel" id="quoteCustPhone" class="form-input" placeholder="09xx-xxx-xxx">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="quoteCustEmail" class="form-input" placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">åœ°å€</label>
        <input type="text" id="quoteCustAddr" class="form-input" placeholder="é€è²¨/é€šè¨Šåœ°å€">
      </div>
    </div>
  </div>

  <!-- å•†å“æ˜ç´° -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">å•†å“æ˜ç´°</span>
      <span class="card-badge" id="quoteItemCount">0 ITEMS</span>
    </div>
    <div id="quoteLineItems" class="line-items"></div>
    <button class="add-line-btn" onclick="addQuoteLineItem()">+ æ–°å¢å“é …</button>

    <!-- é‡‘é¡åŒ¯ç¸½ -->
    <div class="amount-summary">
      <div class="amount-row">
        <span class="label">å°è¨ˆ</span>
        <span class="value" id="quoteSubtotal">NTD 0</span>
      </div>
      <div class="form-row" style="margin:8px 0">
        <div class="form-group" style="margin:0">
          <select id="quoteDiscountType" class="form-select" onchange="calcQuoteTotals()" style="font-size:13px;padding:8px">
            <option value="percent">æŠ˜æ‰£ %</option>
            <option value="fixed">æŠ˜æ‰£é‡‘é¡</option>
          </select>
        </div>
        <div class="form-group" style="margin:0">
          <input type="number" id="quoteDiscountValue" class="form-input" value="0" min="0" oninput="calcQuoteTotals()" style="font-size:13px;padding:8px">
        </div>
      </div>
      <div class="amount-row discount">
        <span class="label">æŠ˜æ‰£</span>
        <span class="value" id="quoteDiscountAmount">-NTD 0</span>
      </div>
      <div class="form-group" style="margin:8px 0 4px">
        <select id="quoteTaxType" class="form-select" onchange="calcQuoteTotals()" style="font-size:13px;padding:8px">
          <option value="excluded">ç¨…å¤–åŠ  (5%)</option>
          <option value="included">å«ç¨… (5%)</option>
          <option value="exempt">å…ç¨…</option>
        </select>
      </div>
      <div class="amount-row">
        <span class="label" id="quoteTaxLabel">ç¨…é¡ (5%)</span>
        <span class="value" id="quoteTaxAmount">NTD 0</span>
      </div>
      <div class="amount-row total">
        <span class="label">ç¸½è¨ˆ</span>
        <span class="value" id="quoteTotal">NTD 0</span>
      </div>
    </div>
  </div>

  <!-- å‚™è¨» -->
  <div class="card">
    <div class="form-group" style="margin:0">
      <label class="form-label">å‚™è¨»</label>
      <textarea id="quoteNotes" class="form-textarea" placeholder="ä»˜æ¬¾æ¢ä»¶ã€äº¤è²¨æ–¹å¼ç­‰è£œå……èªªæ˜"></textarea>
    </div>
  </div>

  <div class="btn-group">
    <button class="btn btn-primary" onclick="saveQuotation()" style="flex:2">å„²å­˜å ±åƒ¹å–®</button>
    <button class="btn btn-secondary" onclick="saveQuotation(true)" style="flex:1">å­˜æª”+PDF</button>
  </div>
</div>

<!-- ==================== Tab 2: æ–°å¢æ¡è³¼å–® ==================== -->
<div id="tab-po" class="tab-panel">
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“¦ æ¡è³¼å–®</span>
      <span class="card-badge">PURCHASE ORDER</span>
    </div>

    <div class="form-group">
      <label class="form-label">æ¡è³¼æ—¥æœŸ</label>
      <input type="date" id="poDate" class="form-input">
    </div>

    <!-- ä¾›æ‡‰å•† -->
    <div class="form-group">
      <label class="form-label">ä¾›æ‡‰å•†åç¨± <span class="required">*</span></label>
      <input type="text" id="poVendorName" class="form-input" placeholder="ä¾›æ‡‰å•†åç¨±">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">è¯ç¹«äºº</label>
        <input type="text" id="poVendorContact" class="form-input" placeholder="å§“å">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±</label>
        <input type="tel" id="poVendorPhone" class="form-input" placeholder="é›»è©±">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="poVendorEmail" class="form-input" placeholder="email@example.com">
    </div>
  </div>

  <!-- æ¡è³¼æ˜ç´° -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">æ¡è³¼æ˜ç´°</span>
      <span class="card-badge" id="poItemCount">0 ITEMS</span>
    </div>
    <div id="poLineItems" class="line-items"></div>
    <button class="add-line-btn" onclick="addPOLineItem()">+ æ–°å¢å“é …</button>

    <div class="amount-summary">
      <div class="amount-row">
        <span class="label">å°è¨ˆ</span>
        <span class="value" id="poSubtotal">NTD 0</span>
      </div>
      <div class="form-group" style="margin:8px 0 4px">
        <select id="poTaxType" class="form-select" onchange="calcPOTotals()" style="font-size:13px;padding:8px">
          <option value="excluded">ç¨…å¤–åŠ  (5%)</option>
          <option value="included">å«ç¨… (5%)</option>
          <option value="exempt">å…ç¨…</option>
        </select>
      </div>
      <div class="amount-row">
        <span class="label" id="poTaxLabel">ç¨…é¡ (5%)</span>
        <span class="value" id="poTaxAmount">NTD 0</span>
      </div>
      <div class="amount-row total">
        <span class="label">ç¸½è¨ˆ</span>
        <span class="value" id="poTotal">NTD 0</span>
      </div>
    </div>
  </div>

  <!-- äº¤è²¨èˆ‡ä»˜æ¬¾ -->
  <div class="card">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é æœŸäº¤è²¨æ—¥</label>
        <input type="date" id="poDeliveryDate" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">ä»˜æ¬¾æ¢ä»¶</label>
        <select id="poPaymentTerms" class="form-select">
          <option value="æœˆçµ30å¤©">æœˆçµ30å¤©</option>
          <option value="æœˆçµ60å¤©">æœˆçµ60å¤©</option>
          <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
          <option value="é ä»˜æ¬¾">é ä»˜æ¬¾</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">é—œè¯å ±åƒ¹å–®</label>
      <select id="poRelatedQuote" class="form-select">
        <option value="">ï¼ˆç„¡ï¼‰</option>
      </select>
    </div>
    <div class="form-group" style="margin:0">
      <label class="form-label">å‚™è¨»</label>
      <textarea id="poNotes" class="form-textarea" placeholder="ç‰¹æ®Šéœ€æ±‚ã€æ³¨æ„äº‹é …"></textarea>
    </div>
  </div>

  <div class="btn-group">
    <button class="btn btn-primary" onclick="savePurchaseOrder()" style="flex:2">å„²å­˜æ¡è³¼å–®</button>
    <button class="btn btn-secondary" onclick="savePurchaseOrder(true)" style="flex:1">å­˜æª”+PDF</button>
  </div>
</div>

<!-- ==================== Tab 3: å–®æ“šåˆ—è¡¨ ==================== -->
<div id="tab-list" class="tab-panel">
  <div class="month-nav">
    <button onclick="changeListMonth(-1)">â—€</button>
    <span class="month-label" id="listMonthLabel"></span>
    <button onclick="changeListMonth(1)">â–¶</button>
  </div>

  <div class="search-bar">
    <input type="text" id="listSearch" placeholder="æœå°‹ç·¨è™Ÿã€å®¢æˆ¶ã€ä¾›æ‡‰å•†" oninput="renderDocList()">
    <select id="listTypeFilter" onchange="renderDocList()">
      <option value="">å…¨éƒ¨</option>
      <option value="quotation">å ±åƒ¹å–®</option>
      <option value="po">æ¡è³¼å–®</option>
    </select>
  </div>

  <div id="docListContainer"></div>
  <div id="docListEmpty" style="text-align:center;padding:40px 0;color:var(--text-dim);display:none">
    <div style="font-size:40px;margin-bottom:8px">ğŸ“„</div>
    <div>æœ¬æœˆå°šç„¡å–®æ“š</div>
  </div>
</div>

<!-- ==================== Tab 4: çµ±è¨ˆ ==================== -->
<div id="tab-stats" class="tab-panel">
  <div class="month-nav">
    <button onclick="changeStatsMonth(-1)">â—€</button>
    <span class="month-label" id="statsMonthLabel"></span>
    <button onclick="changeStatsMonth(1)">â–¶</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">å ±åƒ¹å–®æ•¸</div>
      <div class="stat-value" id="statQuoteCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ¡è³¼å–®æ•¸</div>
      <div class="stat-value" id="statPOCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å ±åƒ¹ç¸½é¡</div>
      <div class="stat-value orange" id="statQuoteTotal">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ¡è³¼ç¸½é¡</div>
      <div class="stat-value orange" id="statPOTotal">0</div>
    </div>
  </div>

  <!-- å ±åƒ¹å–®ç‹€æ…‹åˆ†å¸ƒ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">å ±åƒ¹å–®ç‹€æ…‹åˆ†å¸ƒ</span>
    </div>
    <div id="quoteStatusDist"></div>
  </div>

  <!-- å¹´åº¦è¶¨å‹¢ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">å¹´åº¦è¶¨å‹¢</span>
      <select id="trendYear" class="form-select" onchange="renderTrend()" style="width:auto;padding:4px 28px 4px 8px;font-size:12px"></select>
    </div>
    <div id="trendChart" class="trend-chart"></div>
    <div id="trendSummary" class="trend-summary"></div>
  </div>
</div>

<!-- ==================== Tab 5: è¨­å®š ==================== -->
<div id="tab-settings" class="tab-panel">
  <div class="card">
    <div class="card-header">
      <span class="card-title">âš™ï¸ ç³»çµ±è¨­å®š</span>
      <span class="card-badge">SETTINGS</span>
    </div>
    <div class="form-group">
      <label class="form-label">Apps Script API ç¶²å€</label>
      <input type="url" id="settingApiUrl" class="form-input" placeholder="https://script.google.com/macros/s/...">
    </div>
    <div class="form-group">
      <label class="form-label">ä½¿ç”¨è€…åç¨±</label>
      <input type="text" id="settingRecorder" class="form-input" placeholder="ä½ çš„åå­—">
    </div>
  </div>

  <!-- å…¬å¸è³‡è¨Š -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">å…¬å¸è³‡è¨Šï¼ˆç”¨æ–¼ PDFï¼‰</span>
    </div>
    <div class="form-group">
      <label class="form-label">å…¬å¸åç¨±ï¼ˆä¸­æ–‡å“ç‰Œï¼‰</label>
      <input type="text" id="settingCompanyName" class="form-input" value="å …å¿ƒ Outrun Nutrition">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">æ³•äººåç¨±</label>
        <input type="text" id="settingLegalName" class="form-input" placeholder="ç„ çˆ¾ç‘¯è‚¡ä»½æœ‰é™å…¬å¸">
      </div>
      <div class="form-group">
        <label class="form-label">è‹±æ–‡åç¨±</label>
        <input type="text" id="settingNameEn" class="form-input" placeholder="Outrun Nutrition Co., Ltd.">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">çµ±ä¸€ç·¨è™Ÿ</label>
        <input type="text" id="settingTaxId" class="form-input" placeholder="91114185">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±</label>
        <input type="tel" id="settingCompanyPhone" class="form-input" placeholder="02-xxxx-xxxx">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="settingCompanyEmail" class="form-input" placeholder="info@outrun.com">
    </div>
    <div class="form-group">
      <label class="form-label">åœ°å€</label>
      <input type="text" id="settingCompanyAddr" class="form-input" placeholder="å…¬å¸åœ°å€">
    </div>
  </div>

  <!-- æ¥­å‹™ä»£è¡¨ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">æ¥­å‹™ä»£è¡¨ï¼ˆPDF é¡¯ç¤ºï¼‰</span>
    </div>
    <div class="form-group">
      <label class="form-label">æ¥­å‹™åç¨±</label>
      <input type="text" id="settingSalesName" class="form-input" placeholder="æ¥­å‹™ä»£è¡¨å§“å">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é›»è©±</label>
        <input type="tel" id="settingSalesPhone" class="form-input" placeholder="0912-345-678">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="settingSalesEmail" class="form-input" placeholder="sales@outrun.com">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">LINE ID</label>
      <input type="text" id="settingSalesLine" class="form-input" placeholder="LINE ID æˆ–é¡¯ç¤ºåç¨±">
    </div>
  </div>

  <!-- åŒ¯æ¬¾è³‡è¨Š -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">åŒ¯æ¬¾è³‡è¨Šï¼ˆPDF é¡¯ç¤ºï¼‰</span>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">éŠ€è¡Œåç¨±</label>
        <input type="text" id="settingBankName" class="form-input" placeholder="ç‰å±±éŠ€è¡Œ">
      </div>
      <div class="form-group">
        <label class="form-label">éŠ€è¡Œä»£ç¢¼</label>
        <input type="text" id="settingBankCode" class="form-input" placeholder="808">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">åˆ†è¡Œåç¨±ï¼ˆä»£ç¢¼ï¼‰</label>
        <input type="text" id="settingBankBranch" class="form-input" placeholder="åŒ—æ–°åˆ†è¡Œ (0901)">
      </div>
      <div class="form-group">
        <label class="form-label">æˆ¶å</label>
        <input type="text" id="settingBankHolder" class="form-input" placeholder="ç„ çˆ¾ç‘¯è‚¡ä»½æœ‰é™å…¬å¸">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">å¸³è™Ÿ</label>
      <input type="text" id="settingBankAccount" class="form-input" placeholder="0901-9400-22708">
    </div>
  </div>

  <!-- PDF åœ–ç‰‡ä¸Šå‚³ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">PDF åœ–ç‰‡è¨­å®š</span>
    </div>
    <div class="form-group">
      <label class="form-label">å…¬å¸ Logoï¼ˆå·¦ä¸Šè§’é¡¯ç¤ºï¼‰</label>
      <div id="logoPreview" style="margin-bottom:8px"></div>
      <input type="file" id="logoUpload" accept="image/*" onchange="handleImageUpload('logo', this)" style="display:none">
      <div class="btn-group">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('logoUpload').click()" style="flex:1">ğŸ“· ä¸Šå‚³ Logo</button>
        <button class="btn btn-outline btn-sm" onclick="clearImage('logo')" style="flex:0.5;color:var(--danger)">æ¸…é™¤</button>
      </div>
    </div>
    <div class="form-group" style="margin-top:12px">
      <label class="form-label">å…¬å¸ç™¼ç¥¨ç« ï¼ˆå³ä¸‹è§’ç°½ç½²å€é¡¯ç¤ºï¼‰</label>
      <div id="stampPreview" style="margin-bottom:8px"></div>
      <input type="file" id="stampUpload" accept="image/*" onchange="handleImageUpload('stamp', this)" style="display:none">
      <div class="btn-group">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('stampUpload').click()" style="flex:1">ğŸ“· ä¸Šå‚³ç™¼ç¥¨ç« </button>
        <button class="btn btn-outline btn-sm" onclick="clearImage('stamp')" style="flex:0.5;color:var(--danger)">æ¸…é™¤</button>
      </div>
    </div>
  </div>

  <!-- PDF å‚™è¨»æ¢æ¬¾ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">PDF é è¨­å‚™è¨»æ¢æ¬¾</span>
    </div>
    <div class="form-group">
      <label class="form-label">å‚™è¨»æ¢æ¬¾ï¼ˆæ¯è¡Œä¸€æ¢ï¼‰</label>
      <textarea id="settingPdfTerms" class="form-input" rows="4" placeholder="1. æœ¬å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚ºé–‹ç«‹æ—¥èµ· 30 å¤©ã€‚&#10;2. ä»˜æ¬¾æ–¹å¼ï¼šåŒ¯æ¬¾ã€‚"></textarea>
    </div>
  </div>

  <!-- ç”¢å“ç›®éŒ„ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ç”¢å“ç›®éŒ„</span>
      <span class="card-badge" id="productCountBadge">0</span>
    </div>
    <div id="productList"></div>
    <div style="border-top:1px solid rgba(255,255,255,0.08);padding-top:12px;margin-top:12px">
      <div class="form-group">
        <label class="form-label">æ–°å¢è‡ªè¨‚ç”¢å“</label>
        <div class="form-row" style="margin-bottom:8px">
          <input type="text" id="newProdName" class="form-input" placeholder="å“å" style="font-size:13px;padding:8px">
          <input type="text" id="newProdSpec" class="form-input" placeholder="è¦æ ¼" style="font-size:13px;padding:8px">
        </div>
        <div class="form-row">
          <input type="number" id="newProdPrice" class="form-input" placeholder="å”®åƒ¹" style="font-size:13px;padding:8px">
          <input type="text" id="newProdUnit" class="form-input" placeholder="å–®ä½(é è¨­:å€‹)" style="font-size:13px;padding:8px">
        </div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="addCustomProduct()" style="width:100%">+ æ–°å¢ç”¢å“</button>
    </div>
  </div>

  <button class="btn btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
  <div class="btn-group">
    <button class="btn btn-outline btn-sm" onclick="syncToCloud()" style="flex:1">â˜ï¸ é›²ç«¯åŒæ­¥</button>
    <button class="btn btn-danger btn-sm" onclick="clearLocalData()" style="flex:1">ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°è³‡æ–™</button>
  </div>
</div>

</div><!-- /main-content -->

<!-- ==================== Modal ==================== -->
<div class="modal-overlay" id="docModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- ==================== JavaScript ==================== -->
<script>
// ==================== é è¨­ç”¢å“ç›®éŒ„ ====================
const DEFAULT_PRODUCTS = [
  { name: 'çœ æ˜“å¾© é‹å‹•æ¢å¾©è† å›Š', spec: '30ç²’/ç½', price: 1299, unit: 'ç½' },
  { name: 'èƒ½æ˜“å¾© æ¢å¾©è›‹ç™½', spec: 'é»‘ç³–ä»™è‰ 750g/è¢‹', price: 1350, unit: 'è¢‹' },
  { name: 'èƒ½æ˜“å¾© æ¢å¾©è›‹ç™½', spec: 'é»‘ç³–ä»™è‰ 500g/ç›’', price: 950, unit: 'ç›’' },
  { name: 'é£Ÿå‹•åŠ› é‹å‹•é«”æ„Ÿè† å›Š', spec: '30åŒ…/ç›’', price: 1299, unit: 'ç›’' },
  { name: 'TEMPO è† å›Š', spec: '60é¡†/ç½', price: 1299, unit: 'ç½' },
  { name: 'OARC å°ˆæ¥­ç§‘å­¸è¨“ç·´è£œçµ¦çµ„', spec: 'éš¨é¸çµ„åˆ', price: 0, unit: 'çµ„' },
];

// ==================== ç‹€æ…‹å¸¸æ•¸ ====================
const QUOTE_STATUSES = ['è‰ç¨¿', 'å·²ç™¼é€', 'å·²æ¥å—', 'å·²æ‹’çµ•'];
const PO_STATUSES = ['å¾…ç¢ºèª', 'å·²ç¢ºèª', 'å·²äº¤è²¨', 'å·²é–‹ç¥¨', 'å·²çµæ¬¾'];

const STORAGE_KEYS = {
  QUOTATIONS: 'outrun_po_quotations',
  PURCHASE_ORDERS: 'outrun_po_purchase_orders',
  SETTINGS: 'outrun_po_settings',
  PRODUCTS: 'outrun_po_products',
  PENDING: 'outrun_po_pending',
};

// ==================== State ====================
let state = {
  quotations: [],
  purchaseOrders: [],
  products: [],
  pendingSync: [],
  settings: {
    apiUrl: '',
    recorder: '',
    companyInfo: {
      name: 'å …å¿ƒ Outrun Nutrition',
      nameEn: 'Outrun Nutrition Co., Ltd.',
      legalName: 'ç„ çˆ¾ç‘¯è‚¡ä»½æœ‰é™å…¬å¸',
      phone: '', email: '', address: 'æ–°åŒ—å¸‚æ–°åº—å€è¯èˆˆè¡—46è™Ÿ1æ¨“', taxId: '91114185'
    },
    salesRep: { name: '', phone: '', email: '', line: '' },
    bankInfo: { bankName: 'ç‰å±±éŠ€è¡Œ', bankCode: '808', branch: 'åŒ—æ–°åˆ†è¡Œ (0901)', holder: 'ç„ çˆ¾ç‘¯è‚¡ä»½æœ‰é™å…¬å¸', account: '0901-9400-22708' },
    logoBase64: '',
    stampBase64: '',
    pdfTerms: '1. æœ¬å ±åƒ¹å–®æœ‰æ•ˆæœŸé™ç‚ºé–‹ç«‹æ—¥èµ· 30 å¤©ã€‚\n2. ä»˜æ¬¾æ–¹å¼ï¼šåŒ¯æ¬¾ã€‚\n3. å•†å“äº¤æœŸä¾å¯¦éš›åº«å­˜ç‹€æ³ç‚ºæº–ã€‚'
  }
};

// åˆ—è¡¨/çµ±è¨ˆçš„ç•¶å‰æœˆä»½
let listYear, listMonth, statsYear, statsMonth;

// ==================== å·¥å…·å‡½å¼ ====================
function numberFormat(n) {
  return Number(n || 0).toLocaleString('en-US');
}

function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function addDays(dateStr, days) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function generateId(prefix) {
  const today = todayStr().replace(/-/g, '');
  const arr = prefix === 'QUOT' ? state.quotations : state.purchaseOrders;
  const todayDocs = arr.filter(d => d.id && d.id.startsWith(prefix + '-' + today));
  const seq = String(todayDocs.length + 1).padStart(3, '0');
  return prefix + '-' + today + '-' + seq;
}

function getStatusClass(status) {
  const map = {
    'è‰ç¨¿': 'status-draft', 'å·²ç™¼é€': 'status-sent',
    'å·²æ¥å—': 'status-accepted', 'å·²æ‹’çµ•': 'status-rejected',
    'å¾…ç¢ºèª': 'status-pending', 'å·²ç¢ºèª': 'status-confirmed',
    'å·²äº¤è²¨': 'status-delivered', 'å·²é–‹ç¥¨': 'status-invoiced',
    'å·²çµæ¬¾': 'status-paid',
  };
  return map[status] || 'status-draft';
}

function showToast(msg, type = 'info') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ==================== åˆ†é åˆ‡æ› ====================
function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  const tabs = ['quote', 'po', 'list', 'stats', 'settings'];
  const idx = tabs.indexOf(tab);
  if (idx >= 0) document.querySelectorAll('.tab-btn')[idx].classList.add('active');

  if (tab === 'list') renderDocList();
  if (tab === 'stats') renderStats();
  if (tab === 'settings') renderSettings();
  if (tab === 'po') populateRelatedQuotes();
}

// ==================== localStorage ====================
function saveState() {
  localStorage.setItem(STORAGE_KEYS.QUOTATIONS, JSON.stringify(state.quotations));
  localStorage.setItem(STORAGE_KEYS.PURCHASE_ORDERS, JSON.stringify(state.purchaseOrders));
  localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(state.settings));
  localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(state.products));
  localStorage.setItem(STORAGE_KEYS.PENDING, JSON.stringify(state.pendingSync));
}

function loadState() {
  try {
    const q = localStorage.getItem(STORAGE_KEYS.QUOTATIONS);
    if (q) state.quotations = JSON.parse(q);
    const p = localStorage.getItem(STORAGE_KEYS.PURCHASE_ORDERS);
    if (p) state.purchaseOrders = JSON.parse(p);
    const s = localStorage.getItem(STORAGE_KEYS.SETTINGS);
    if (s) state.settings = { ...state.settings, ...JSON.parse(s) };
    const pr = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
    if (pr) state.products = JSON.parse(pr);
    else state.products = [...DEFAULT_PRODUCTS];
    const pn = localStorage.getItem(STORAGE_KEYS.PENDING);
    if (pn) state.pendingSync = JSON.parse(pn);
  } catch (e) {
    console.error('loadState error', e);
    state.products = [...DEFAULT_PRODUCTS];
  }
}

// ==================== å ±åƒ¹å–®æ˜ç´°è¡Œ ====================
let quoteLineCounter = 0;

function addQuoteLineItem(data) {
  quoteLineCounter++;
  const n = quoteLineCounter;
  const container = document.getElementById('quoteLineItems');

  const productOptions = state.products.map((p, i) =>
    `<option value="${i}" ${data && data.productName === p.name ? 'selected' : ''}>${p.name} (${p.spec})</option>`
  ).join('');

  const div = document.createElement('div');
  div.className = 'line-item';
  div.id = 'quoteLine-' + n;
  div.innerHTML = `
    <div class="line-item-header">
      <span class="line-item-num">#${n}</span>
      <button class="line-item-remove" onclick="removeQuoteLine(${n})">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">ç”¢å“</label>
      <select class="form-select" onchange="onQuoteProductSelect(${n}, this.value)" id="qProd-${n}">
        <option value="">â€” è‡ªè¨‚è¼¸å…¥ â€”</option>
        ${productOptions}
      </select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">å“å</label>
        <input type="text" class="form-input" id="qName-${n}" value="${data ? data.productName : ''}" oninput="calcQuoteTotals()">
      </div>
      <div class="form-group">
        <label class="form-label">è¦æ ¼</label>
        <input type="text" class="form-input" id="qSpec-${n}" value="${data ? data.spec : ''}">
      </div>
    </div>
    <div class="line-item-row">
      <div class="form-group">
        <label class="form-label">æ•¸é‡</label>
        <input type="number" class="form-input" id="qQty-${n}" value="${data ? data.qty : 1}" min="1" oninput="calcQuoteLineSubtotal(${n})">
      </div>
      <div class="form-group">
        <label class="form-label">å–®ä½</label>
        <input type="text" class="form-input" id="qUnit-${n}" value="${data ? data.unit : 'å€‹'}">
      </div>
      <div class="form-group">
        <label class="form-label">å–®åƒ¹</label>
        <input type="number" class="form-input" id="qPrice-${n}" value="${data ? data.unitPrice : 0}" min="0" oninput="calcQuoteLineSubtotal(${n})">
      </div>
    </div>
    <div class="line-item-subtotal" id="qSubtotal-${n}">NTD 0</div>
  `;
  container.appendChild(div);
  calcQuoteLineSubtotal(n);
  updateQuoteItemCount();
}

function onQuoteProductSelect(n, idx) {
  if (idx === '') return;
  const p = state.products[parseInt(idx)];
  if (!p) return;
  document.getElementById('qName-' + n).value = p.name;
  document.getElementById('qSpec-' + n).value = p.spec;
  document.getElementById('qPrice-' + n).value = p.price;
  document.getElementById('qUnit-' + n).value = p.unit;
  calcQuoteLineSubtotal(n);
}

function removeQuoteLine(n) {
  const el = document.getElementById('quoteLine-' + n);
  if (el) el.remove();
  calcQuoteTotals();
  updateQuoteItemCount();
}

function calcQuoteLineSubtotal(n) {
  const qty = Number(document.getElementById('qQty-' + n)?.value) || 0;
  const price = Number(document.getElementById('qPrice-' + n)?.value) || 0;
  const sub = qty * price;
  const el = document.getElementById('qSubtotal-' + n);
  if (el) el.textContent = 'NTD ' + numberFormat(sub);
  calcQuoteTotals();
}

function getQuoteLineItems() {
  const items = [];
  document.querySelectorAll('#quoteLineItems .line-item').forEach(li => {
    const n = li.id.replace('quoteLine-', '');
    const qty = Number(document.getElementById('qQty-' + n)?.value) || 0;
    const unitPrice = Number(document.getElementById('qPrice-' + n)?.value) || 0;
    items.push({
      productName: document.getElementById('qName-' + n)?.value || '',
      spec: document.getElementById('qSpec-' + n)?.value || '',
      qty, unit: document.getElementById('qUnit-' + n)?.value || 'å€‹',
      unitPrice, subtotal: qty * unitPrice,
    });
  });
  return items;
}

function updateQuoteItemCount() {
  const count = document.querySelectorAll('#quoteLineItems .line-item').length;
  document.getElementById('quoteItemCount').textContent = count + ' ITEMS';
}

function calcQuoteTotals() {
  const items = getQuoteLineItems();
  const subtotal = items.reduce((s, i) => s + i.subtotal, 0);

  const discType = document.getElementById('quoteDiscountType').value;
  const discVal = Number(document.getElementById('quoteDiscountValue').value) || 0;
  let discAmount = 0;
  if (discType === 'percent') discAmount = Math.round(subtotal * discVal / 100);
  else discAmount = discVal;

  const afterDiscount = subtotal - discAmount;
  const taxType = document.getElementById('quoteTaxType').value;
  let tax = 0, total = 0;
  const taxLabel = document.getElementById('quoteTaxLabel');

  if (taxType === 'excluded') {
    tax = Math.round(afterDiscount * 0.05);
    total = afterDiscount + tax;
    taxLabel.textContent = 'ç¨…é¡ (å¤–åŠ  5%)';
  } else if (taxType === 'included') {
    tax = Math.round(afterDiscount - afterDiscount / 1.05);
    total = afterDiscount;
    taxLabel.textContent = 'ç¨…é¡ (å…§å« 5%)';
  } else {
    tax = 0;
    total = afterDiscount;
    taxLabel.textContent = 'ç¨…é¡ (å…ç¨…)';
  }

  document.getElementById('quoteSubtotal').textContent = 'NTD ' + numberFormat(subtotal);
  document.getElementById('quoteDiscountAmount').textContent = '-NTD ' + numberFormat(discAmount);
  document.getElementById('quoteTaxAmount').textContent = 'NTD ' + numberFormat(tax);
  document.getElementById('quoteTotal').textContent = 'NTD ' + numberFormat(total);
}

// ==================== æ¡è³¼å–®æ˜ç´°è¡Œ ====================
let poLineCounter = 0;

function addPOLineItem(data) {
  poLineCounter++;
  const n = poLineCounter;
  const container = document.getElementById('poLineItems');

  const div = document.createElement('div');
  div.className = 'line-item';
  div.id = 'poLine-' + n;
  div.innerHTML = `
    <div class="line-item-header">
      <span class="line-item-num">#${n}</span>
      <button class="line-item-remove" onclick="removePOLine(${n})">âœ•</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">å“å</label>
        <input type="text" class="form-input" id="pName-${n}" value="${data ? data.itemName : ''}" oninput="calcPOTotals()">
      </div>
      <div class="form-group">
        <label class="form-label">è¦æ ¼</label>
        <input type="text" class="form-input" id="pSpec-${n}" value="${data ? data.spec : ''}">
      </div>
    </div>
    <div class="line-item-row">
      <div class="form-group">
        <label class="form-label">æ•¸é‡</label>
        <input type="number" class="form-input" id="pQty-${n}" value="${data ? data.qty : 1}" min="1" oninput="calcPOLineSubtotal(${n})">
      </div>
      <div class="form-group">
        <label class="form-label">å–®ä½</label>
        <input type="text" class="form-input" id="pUnit-${n}" value="${data ? data.unit : 'å€‹'}">
      </div>
      <div class="form-group">
        <label class="form-label">å–®åƒ¹</label>
        <input type="number" class="form-input" id="pPrice-${n}" value="${data ? data.unitPrice : 0}" min="0" oninput="calcPOLineSubtotal(${n})">
      </div>
    </div>
    <div class="line-item-subtotal" id="pSubtotal-${n}">NTD 0</div>
  `;
  container.appendChild(div);
  calcPOLineSubtotal(n);
  updatePOItemCount();
}

function removePOLine(n) {
  const el = document.getElementById('poLine-' + n);
  if (el) el.remove();
  calcPOTotals();
  updatePOItemCount();
}

function calcPOLineSubtotal(n) {
  const qty = Number(document.getElementById('pQty-' + n)?.value) || 0;
  const price = Number(document.getElementById('pPrice-' + n)?.value) || 0;
  const sub = qty * price;
  const el = document.getElementById('pSubtotal-' + n);
  if (el) el.textContent = 'NTD ' + numberFormat(sub);
  calcPOTotals();
}

function getPOLineItems() {
  const items = [];
  document.querySelectorAll('#poLineItems .line-item').forEach(li => {
    const n = li.id.replace('poLine-', '');
    const qty = Number(document.getElementById('pQty-' + n)?.value) || 0;
    const unitPrice = Number(document.getElementById('pPrice-' + n)?.value) || 0;
    items.push({
      itemName: document.getElementById('pName-' + n)?.value || '',
      spec: document.getElementById('pSpec-' + n)?.value || '',
      qty, unit: document.getElementById('pUnit-' + n)?.value || 'å€‹',
      unitPrice, subtotal: qty * unitPrice,
    });
  });
  return items;
}

function updatePOItemCount() {
  const count = document.querySelectorAll('#poLineItems .line-item').length;
  document.getElementById('poItemCount').textContent = count + ' ITEMS';
}

function calcPOTotals() {
  const items = getPOLineItems();
  const subtotal = items.reduce((s, i) => s + i.subtotal, 0);
  const taxType = document.getElementById('poTaxType').value;
  let tax = 0, total = 0;
  const taxLabel = document.getElementById('poTaxLabel');

  if (taxType === 'excluded') {
    tax = Math.round(subtotal * 0.05);
    total = subtotal + tax;
    taxLabel.textContent = 'ç¨…é¡ (å¤–åŠ  5%)';
  } else if (taxType === 'included') {
    tax = Math.round(subtotal - subtotal / 1.05);
    total = subtotal;
    taxLabel.textContent = 'ç¨…é¡ (å…§å« 5%)';
  } else {
    tax = 0;
    total = subtotal;
    taxLabel.textContent = 'ç¨…é¡ (å…ç¨…)';
  }

  document.getElementById('poSubtotal').textContent = 'NTD ' + numberFormat(subtotal);
  document.getElementById('poTaxAmount').textContent = 'NTD ' + numberFormat(tax);
  document.getElementById('poTotal').textContent = 'NTD ' + numberFormat(total);
}

function populateRelatedQuotes() {
  const sel = document.getElementById('poRelatedQuote');
  sel.innerHTML = '<option value="">ï¼ˆç„¡ï¼‰</option>';
  state.quotations.filter(q => q.status === 'å·²æ¥å—').forEach(q => {
    sel.innerHTML += `<option value="${q.id}">${q.id} â€” ${q.customer.name} (NTD ${numberFormat(q.total)})</option>`;
  });
}

// ==================== å„²å­˜å ±åƒ¹å–® ====================
function saveQuotation(genPDF = false) {
  const custName = document.getElementById('quoteCustName').value.trim();
  if (!custName) { showToast('è«‹è¼¸å…¥å®¢æˆ¶åç¨±', 'error'); return; }
  const items = getQuoteLineItems();
  if (items.length === 0) { showToast('è«‹æ–°å¢è‡³å°‘ä¸€å€‹å“é …', 'error'); return; }

  const subtotal = items.reduce((s, i) => s + i.subtotal, 0);
  const discType = document.getElementById('quoteDiscountType').value;
  const discVal = Number(document.getElementById('quoteDiscountValue').value) || 0;
  let discAmount = discType === 'percent' ? Math.round(subtotal * discVal / 100) : discVal;
  const afterDisc = subtotal - discAmount;
  const taxType = document.getElementById('quoteTaxType').value;
  let tax = 0, total = 0, taxRate = 0;
  if (taxType === 'excluded') { tax = Math.round(afterDisc * 0.05); total = afterDisc + tax; taxRate = 0.05; }
  else if (taxType === 'included') { tax = Math.round(afterDisc - afterDisc / 1.05); total = afterDisc; taxRate = 0.05; }
  else { tax = 0; total = afterDisc; taxRate = 0; }

  const quotation = {
    id: generateId('QUOT'),
    date: document.getElementById('quoteDate').value || todayStr(),
    validUntil: document.getElementById('quoteValidUntil').value || addDays(todayStr(), 30),
    customer: {
      name: custName,
      contact: document.getElementById('quoteCustContact').value.trim(),
      phone: document.getElementById('quoteCustPhone').value.trim(),
      email: document.getElementById('quoteCustEmail').value.trim(),
      address: document.getElementById('quoteCustAddr').value.trim(),
    },
    items, subtotal,
    discountType: discType, discountValue: discVal, discountAmount: discAmount,
    taxType, taxRate, taxAmount: tax, total,
    notes: document.getElementById('quoteNotes').value.trim(),
    status: 'è‰ç¨¿',
    recorder: state.settings.recorder || 'æœªè¨­å®š',
    createdAt: new Date().toISOString(),
    synced: false,
  };

  state.quotations.push(quotation);
  state.pendingSync.push({ type: 'addQuotation', data: quotation });
  saveState();
  showToast('å ±åƒ¹å–®å·²å„²å­˜ï¼š' + quotation.id, 'success');

  if (genPDF) generateQuotePDF(quotation);
  resetQuoteForm();
}

function resetQuoteForm() {
  document.getElementById('quoteCustName').value = '';
  document.getElementById('quoteCustContact').value = '';
  document.getElementById('quoteCustPhone').value = '';
  document.getElementById('quoteCustEmail').value = '';
  document.getElementById('quoteCustAddr').value = '';
  document.getElementById('quoteNotes').value = '';
  document.getElementById('quoteDiscountValue').value = '0';
  document.getElementById('quoteTaxType').value = 'excluded';
  document.getElementById('quoteLineItems').innerHTML = '';
  quoteLineCounter = 0;
  initDateFields();
  calcQuoteTotals();
  updateQuoteItemCount();
}

// ==================== å„²å­˜æ¡è³¼å–® ====================
function savePurchaseOrder(genPDF = false) {
  const vendorName = document.getElementById('poVendorName').value.trim();
  if (!vendorName) { showToast('è«‹è¼¸å…¥ä¾›æ‡‰å•†åç¨±', 'error'); return; }
  const items = getPOLineItems();
  if (items.length === 0) { showToast('è«‹æ–°å¢è‡³å°‘ä¸€å€‹å“é …', 'error'); return; }

  const subtotal = items.reduce((s, i) => s + i.subtotal, 0);
  const taxType = document.getElementById('poTaxType').value;
  let tax = 0, total = 0, taxRate = 0;
  if (taxType === 'excluded') { tax = Math.round(subtotal * 0.05); total = subtotal + tax; taxRate = 0.05; }
  else if (taxType === 'included') { tax = Math.round(subtotal - subtotal / 1.05); total = subtotal; taxRate = 0.05; }
  else { tax = 0; total = subtotal; taxRate = 0; }

  const po = {
    id: generateId('PO'),
    date: document.getElementById('poDate').value || todayStr(),
    vendor: {
      name: vendorName,
      contact: document.getElementById('poVendorContact').value.trim(),
      phone: document.getElementById('poVendorPhone').value.trim(),
      email: document.getElementById('poVendorEmail').value.trim(),
    },
    items, subtotal,
    taxType, taxRate, taxAmount: tax, total,
    expectedDelivery: document.getElementById('poDeliveryDate').value || '',
    paymentTerms: document.getElementById('poPaymentTerms').value,
    notes: document.getElementById('poNotes').value.trim(),
    status: 'å¾…ç¢ºèª',
    relatedQuotationId: document.getElementById('poRelatedQuote').value || '',
    recorder: state.settings.recorder || 'æœªè¨­å®š',
    createdAt: new Date().toISOString(),
    synced: false,
  };

  state.purchaseOrders.push(po);
  state.pendingSync.push({ type: 'addPurchaseOrder', data: po });
  saveState();
  showToast('æ¡è³¼å–®å·²å„²å­˜ï¼š' + po.id, 'success');

  if (genPDF) generatePOPDF(po);
  resetPOForm();
}

function resetPOForm() {
  document.getElementById('poVendorName').value = '';
  document.getElementById('poVendorContact').value = '';
  document.getElementById('poVendorPhone').value = '';
  document.getElementById('poVendorEmail').value = '';
  document.getElementById('poNotes').value = '';
  document.getElementById('poDeliveryDate').value = '';
  document.getElementById('poRelatedQuote').value = '';
  document.getElementById('poTaxType').value = 'excluded';
  document.getElementById('poLineItems').innerHTML = '';
  poLineCounter = 0;
  initDateFields();
  calcPOTotals();
  updatePOItemCount();
}

// ==================== å–®æ“šåˆ—è¡¨ ====================
function changeListMonth(delta) {
  listMonth += delta;
  if (listMonth > 12) { listMonth = 1; listYear++; }
  if (listMonth < 1) { listMonth = 12; listYear--; }
  renderDocList();
}

function renderDocList() {
  document.getElementById('listMonthLabel').textContent = listYear + ' / ' + String(listMonth).padStart(2, '0');
  const keyword = (document.getElementById('listSearch')?.value || '').trim().toLowerCase();
  const typeFilter = document.getElementById('listTypeFilter')?.value || '';

  let docs = [];

  if (typeFilter !== 'po') {
    state.quotations.forEach(q => {
      const d = new Date(q.date);
      if (d.getFullYear() === listYear && (d.getMonth()+1) === listMonth) {
        docs.push({ ...q, _type: 'quotation' });
      }
    });
  }
  if (typeFilter !== 'quotation') {
    state.purchaseOrders.forEach(p => {
      const d = new Date(p.date);
      if (d.getFullYear() === listYear && (d.getMonth()+1) === listMonth) {
        docs.push({ ...p, _type: 'po' });
      }
    });
  }

  if (keyword) {
    docs = docs.filter(d => {
      const haystack = [
        d.id, d._type === 'quotation' ? d.customer?.name : d.vendor?.name,
        d.notes, d.recorder
      ].join(' ').toLowerCase();
      return haystack.includes(keyword);
    });
  }

  docs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

  const container = document.getElementById('docListContainer');
  const empty = document.getElementById('docListEmpty');

  if (docs.length === 0) {
    container.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  container.innerHTML = docs.map(d => {
    const isQuote = d._type === 'quotation';
    const name = isQuote ? (d.customer?.name || '') : (d.vendor?.name || '');
    const typeLabel = isQuote ? 'å ±åƒ¹' : 'æ¡è³¼';
    return `
      <div class="doc-card" onclick="showDocDetail('${d._type}','${d.id}')">
        <div class="doc-card-top">
          <span class="doc-card-id">${d.id}</span>
          <span class="doc-card-date">${d.date}</span>
        </div>
        <div class="doc-card-mid">
          <span class="doc-card-name">${typeLabel}ï½œ${name}</span>
          <span class="doc-card-amount">NTD ${numberFormat(d.total)}</span>
        </div>
        <div class="doc-card-bottom">
          <span class="doc-card-recorder">${d.recorder || ''}</span>
          <span class="status-tag ${getStatusClass(d.status)}">${d.status}</span>
        </div>
      </div>
    `;
  }).join('');
}

// ==================== å–®æ“šè©³æƒ… Modal ====================
function showDocDetail(type, id) {
  const doc = type === 'quotation'
    ? state.quotations.find(q => q.id === id)
    : state.purchaseOrders.find(p => p.id === id);
  if (!doc) return;

  const isQuote = type === 'quotation';
  const statuses = isQuote ? QUOTE_STATUSES : PO_STATUSES;
  const target = isQuote ? doc.customer : doc.vendor;
  const targetLabel = isQuote ? 'å®¢æˆ¶' : 'ä¾›æ‡‰å•†';

  let itemsHtml = doc.items.map((item, i) => `
    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px">
      <div>
        <div>${isQuote ? item.productName : item.itemName}</div>
        <div style="font-size:11px;color:var(--text-dim)">${item.spec} Ã— ${item.qty} ${item.unit}</div>
      </div>
      <div style="font-family:var(--font-en);font-weight:600">NTD ${numberFormat(item.subtotal)}</div>
    </div>
  `).join('');

  let statusBtns = statuses.map(s =>
    `<button class="btn btn-sm ${doc.status === s ? 'btn-primary' : 'btn-outline'}"
      onclick="updateDocStatus('${type}','${id}','${s}')" style="flex:1">${s}</button>`
  ).join('');

  let extraBtns = '';
  if (isQuote && doc.status === 'å·²æ¥å—') {
    extraBtns = `<button class="btn btn-secondary btn-sm" onclick="convertQuoteToPO('${id}')" style="width:100%;margin-top:8px">ğŸ“¦ è½‰ç‚ºæ¡è³¼å–®</button>`;
  }

  const content = document.getElementById('modalContent');
  content.innerHTML = `
    <h3>${isQuote ? 'ğŸ“ å ±åƒ¹å–®' : 'ğŸ“¦ æ¡è³¼å–®'} ${doc.id}</h3>
    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">
      <div>æ—¥æœŸï¼š${doc.date}${isQuote ? ' ï½œ æœ‰æ•ˆè‡³ï¼š' + doc.validUntil : ''}</div>
      <div>${targetLabel}ï¼š<strong style="color:var(--text-primary)">${target?.name || ''}</strong></div>
      ${target?.contact ? '<div>è¯ç¹«äººï¼š' + target.contact + (target.phone ? ' / ' + target.phone : '') + '</div>' : ''}
      ${target?.email ? '<div>Emailï¼š' + target.email : ''}
      ${!isQuote && doc.expectedDelivery ? '<div>é æœŸäº¤è²¨ï¼š' + doc.expectedDelivery + '</div>' : ''}
      ${!isQuote ? '<div>ä»˜æ¬¾æ¢ä»¶ï¼š' + doc.paymentTerms + '</div>' : ''}
      <div>å»ºç«‹äººï¼š${doc.recorder}</div>
    </div>

    <div class="card" style="padding:12px;margin-bottom:12px">
      ${itemsHtml}
      <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;margin-top:8px;font-size:13px">
        <div style="display:flex;justify-content:space-between;padding:2px 0">
          <span style="color:var(--text-secondary)">å°è¨ˆ</span>
          <span style="font-family:var(--font-en);font-weight:600">NTD ${numberFormat(doc.subtotal)}</span>
        </div>
        ${isQuote && doc.discountAmount ? `<div style="display:flex;justify-content:space-between;padding:2px 0">
          <span style="color:var(--text-secondary)">æŠ˜æ‰£</span>
          <span style="font-family:var(--font-en);font-weight:600;color:var(--success)">-NTD ${numberFormat(doc.discountAmount)}</span>
        </div>` : ''}
        <div style="display:flex;justify-content:space-between;padding:2px 0">
          <span style="color:var(--text-secondary)">ç¨…é¡ (${doc.taxType === 'excluded' ? 'å¤–åŠ  5%' : doc.taxType === 'included' ? 'å…§å« 5%' : 'å…ç¨…'})</span>
          <span style="font-family:var(--font-en);font-weight:600">NTD ${numberFormat(doc.taxAmount)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-top:2px solid var(--orange);margin-top:6px;font-size:16px">
          <span style="font-weight:700">ç¸½è¨ˆ</span>
          <span style="font-family:var(--font-en);font-weight:700;color:var(--orange)">NTD ${numberFormat(doc.total)}</span>
        </div>
      </div>
    </div>

    ${doc.notes ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">å‚™è¨»ï¼š${doc.notes}</div>` : ''}

    <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary)">ç‹€æ…‹è®Šæ›´</div>
    <div class="btn-group" style="flex-wrap:wrap;margin-top:0">${statusBtns}</div>
    ${extraBtns}

    <div class="btn-group" style="margin-top:12px">
      <button class="btn btn-secondary btn-sm" onclick="${isQuote ? 'generateQuotePDF' : 'generatePOPDF'}(state.${isQuote ? 'quotations' : 'purchaseOrders'}.find(d=>d.id==='${id}'))" style="flex:1">ğŸ“„ ç”¢ç”Ÿ PDF</button>
      <button class="btn btn-danger btn-sm" onclick="deleteDoc('${type}','${id}')" style="flex:1">ğŸ—‘ï¸ åˆªé™¤</button>
    </div>
  `;
  document.getElementById('docModal').classList.add('active');
}

function closeModal() {
  document.getElementById('docModal').classList.remove('active');
}

function updateDocStatus(type, id, newStatus) {
  if (type === 'quotation') {
    const q = state.quotations.find(d => d.id === id);
    if (q) q.status = newStatus;
  } else {
    const p = state.purchaseOrders.find(d => d.id === id);
    if (p) p.status = newStatus;
  }
  saveState();
  showToast('ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œ' + newStatus + 'ã€', 'success');
  showDocDetail(type, id);
  renderDocList();
}

function deleteDoc(type, id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å–®æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
  if (type === 'quotation') {
    state.quotations = state.quotations.filter(d => d.id !== id);
  } else {
    state.purchaseOrders = state.purchaseOrders.filter(d => d.id !== id);
  }
  saveState();
  closeModal();
  renderDocList();
  showToast('å·²åˆªé™¤', 'info');
}

function convertQuoteToPO(quoteId) {
  const q = state.quotations.find(d => d.id === quoteId);
  if (!q) return;
  closeModal();
  switchTab('po');

  document.getElementById('poVendorName').value = q.customer.name;
  document.getElementById('poVendorContact').value = q.customer.contact || '';
  document.getElementById('poVendorPhone').value = q.customer.phone || '';
  document.getElementById('poVendorEmail').value = q.customer.email || '';
  document.getElementById('poRelatedQuote').value = quoteId;

  document.getElementById('poLineItems').innerHTML = '';
  poLineCounter = 0;
  q.items.forEach(item => {
    addPOLineItem({
      itemName: item.productName,
      spec: item.spec,
      qty: item.qty,
      unit: item.unit,
      unitPrice: item.unitPrice,
    });
  });

  showToast('å·²å¸¶å…¥å ±åƒ¹å–®è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œå„²å­˜', 'info');
}

// ==================== çµ±è¨ˆ ====================
function changeStatsMonth(delta) {
  statsMonth += delta;
  if (statsMonth > 12) { statsMonth = 1; statsYear++; }
  if (statsMonth < 1) { statsMonth = 12; statsYear--; }
  renderStats();
}

function renderStats() {
  document.getElementById('statsMonthLabel').textContent = statsYear + ' / ' + String(statsMonth).padStart(2, '0');

  const monthQuotes = state.quotations.filter(q => {
    const d = new Date(q.date);
    return d.getFullYear() === statsYear && (d.getMonth()+1) === statsMonth;
  });
  const monthPOs = state.purchaseOrders.filter(p => {
    const d = new Date(p.date);
    return d.getFullYear() === statsYear && (d.getMonth()+1) === statsMonth;
  });

  document.getElementById('statQuoteCount').textContent = monthQuotes.length;
  document.getElementById('statPOCount').textContent = monthPOs.length;
  document.getElementById('statQuoteTotal').textContent = numberFormat(monthQuotes.reduce((s, q) => s + q.total, 0));
  document.getElementById('statPOTotal').textContent = numberFormat(monthPOs.reduce((s, p) => s + p.total, 0));

  // ç‹€æ…‹åˆ†å¸ƒ
  const distHtml = QUOTE_STATUSES.map(s => {
    const count = monthQuotes.filter(q => q.status === s).length;
    return `<div style="display:flex;justify-content:space-between;padding:6px 0;font-size:13px">
      <span class="status-tag ${getStatusClass(s)}">${s}</span>
      <span style="font-family:var(--font-en);font-weight:600">${count}</span>
    </div>`;
  }).join('');
  document.getElementById('quoteStatusDist').innerHTML = distHtml;

  renderTrend();
}

function renderTrend() {
  const yearSel = document.getElementById('trendYear');
  if (yearSel.options.length === 0) {
    const curYear = new Date().getFullYear();
    for (let y = curYear - 2; y <= curYear; y++) {
      yearSel.innerHTML += `<option value="${y}" ${y === curYear ? 'selected' : ''}>${y}</option>`;
    }
  }
  const year = Number(yearSel.value);
  const monthData = [];
  let maxVal = 0;

  for (let m = 1; m <= 12; m++) {
    const qTotal = state.quotations
      .filter(q => { const d = new Date(q.date); return d.getFullYear() === year && (d.getMonth()+1) === m; })
      .reduce((s, q) => s + q.total, 0);
    const pTotal = state.purchaseOrders
      .filter(p => { const d = new Date(p.date); return d.getFullYear() === year && (d.getMonth()+1) === m; })
      .reduce((s, p) => s + p.total, 0);
    monthData.push({ m, qTotal, pTotal });
    if (qTotal > maxVal) maxVal = qTotal;
    if (pTotal > maxVal) maxVal = pTotal;
  }

  const chartEl = document.getElementById('trendChart');
  chartEl.innerHTML = monthData.map(d => {
    const qH = maxVal > 0 ? Math.max(2, (d.qTotal / maxVal) * 90) : 2;
    const qK = d.qTotal >= 1000 ? Math.round(d.qTotal / 1000) + 'k' : d.qTotal;
    return `<div class="trend-bar-wrap">
      <div class="trend-value">${qK}</div>
      <div style="flex:1;display:flex;align-items:flex-end;width:100%">
        <div class="trend-bar" style="height:${qH}%"></div>
      </div>
      <div class="trend-label">${d.m}æœˆ</div>
    </div>`;
  }).join('');

  const yearQTotal = monthData.reduce((s, d) => s + d.qTotal, 0);
  const yearPTotal = monthData.reduce((s, d) => s + d.pTotal, 0);
  document.getElementById('trendSummary').innerHTML = `
    <span>å ±åƒ¹ <strong>NTD ${numberFormat(yearQTotal)}</strong></span>
    <span>æ¡è³¼ <strong>NTD ${numberFormat(yearPTotal)}</strong></span>
  `;
}

// ==================== è¨­å®šé  ====================
function renderSettings() {
  document.getElementById('settingApiUrl').value = state.settings.apiUrl || '';
  document.getElementById('settingRecorder').value = state.settings.recorder || '';
  document.getElementById('settingCompanyName').value = state.settings.companyInfo?.name || 'å …å¿ƒ Outrun Nutrition';
  document.getElementById('settingLegalName').value = state.settings.companyInfo?.legalName || '';
  document.getElementById('settingNameEn').value = state.settings.companyInfo?.nameEn || '';
  document.getElementById('settingTaxId').value = state.settings.companyInfo?.taxId || '';
  document.getElementById('settingCompanyPhone').value = state.settings.companyInfo?.phone || '';
  document.getElementById('settingCompanyEmail').value = state.settings.companyInfo?.email || '';
  document.getElementById('settingCompanyAddr').value = state.settings.companyInfo?.address || '';
  document.getElementById('settingSalesName').value = state.settings.salesRep?.name || '';
  document.getElementById('settingSalesPhone').value = state.settings.salesRep?.phone || '';
  document.getElementById('settingSalesEmail').value = state.settings.salesRep?.email || '';
  document.getElementById('settingSalesLine').value = state.settings.salesRep?.line || '';
  document.getElementById('settingBankName').value = state.settings.bankInfo?.bankName || '';
  document.getElementById('settingBankCode').value = state.settings.bankInfo?.bankCode || '';
  document.getElementById('settingBankBranch').value = state.settings.bankInfo?.branch || '';
  document.getElementById('settingBankHolder').value = state.settings.bankInfo?.holder || '';
  document.getElementById('settingBankAccount').value = state.settings.bankInfo?.account || '';
  document.getElementById('settingPdfTerms').value = state.settings.pdfTerms || '';
  // åœ–ç‰‡é è¦½
  renderImagePreview('logo', state.settings.logoBase64);
  renderImagePreview('stamp', state.settings.stampBase64);
  renderProductList();
}

function saveSettings() {
  state.settings.apiUrl = document.getElementById('settingApiUrl').value.trim();
  state.settings.recorder = document.getElementById('settingRecorder').value.trim();
  state.settings.companyInfo = {
    name: document.getElementById('settingCompanyName').value.trim(),
    legalName: document.getElementById('settingLegalName').value.trim(),
    nameEn: document.getElementById('settingNameEn').value.trim(),
    taxId: document.getElementById('settingTaxId').value.trim(),
    phone: document.getElementById('settingCompanyPhone').value.trim(),
    email: document.getElementById('settingCompanyEmail').value.trim(),
    address: document.getElementById('settingCompanyAddr').value.trim(),
  };
  state.settings.salesRep = {
    name: document.getElementById('settingSalesName').value.trim(),
    phone: document.getElementById('settingSalesPhone').value.trim(),
    email: document.getElementById('settingSalesEmail').value.trim(),
    line: document.getElementById('settingSalesLine').value.trim(),
  };
  state.settings.bankInfo = {
    bankName: document.getElementById('settingBankName').value.trim(),
    bankCode: document.getElementById('settingBankCode').value.trim(),
    branch: document.getElementById('settingBankBranch').value.trim(),
    holder: document.getElementById('settingBankHolder').value.trim(),
    account: document.getElementById('settingBankAccount').value.trim(),
  };
  state.settings.pdfTerms = document.getElementById('settingPdfTerms').value.trim();
  saveState();
  updateSyncStatus();
  showToast('è¨­å®šå·²å„²å­˜', 'success');
}

function renderProductList() {
  const container = document.getElementById('productList');
  document.getElementById('productCountBadge').textContent = state.products.length;
  if (state.products.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:16px">å°šç„¡ç”¢å“</div>';
    return;
  }
  container.innerHTML = state.products.map((p, i) => `
    <div class="product-list-item">
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div class="product-spec">${p.spec}ï½œ${p.unit}</div>
      </div>
      <span class="product-price">${p.price > 0 ? 'NTD ' + numberFormat(p.price) : 'ä¾å ±åƒ¹'}</span>
      <button class="btn btn-danger btn-sm" onclick="removeProduct(${i})" style="padding:4px 8px;font-size:11px">âœ•</button>
    </div>
  `).join('');
}

function addCustomProduct() {
  const name = document.getElementById('newProdName').value.trim();
  const spec = document.getElementById('newProdSpec').value.trim();
  const price = Number(document.getElementById('newProdPrice').value) || 0;
  const unit = document.getElementById('newProdUnit').value.trim() || 'å€‹';
  if (!name) { showToast('è«‹è¼¸å…¥å“å', 'error'); return; }
  state.products.push({ name, spec, price, unit });
  saveState();
  renderProductList();
  document.getElementById('newProdName').value = '';
  document.getElementById('newProdSpec').value = '';
  document.getElementById('newProdPrice').value = '';
  document.getElementById('newProdUnit').value = '';
  showToast('å·²æ–°å¢ç”¢å“', 'success');
}

function removeProduct(idx) {
  if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + state.products[idx].name + 'ã€ï¼Ÿ')) return;
  state.products.splice(idx, 1);
  saveState();
  renderProductList();
}

// ==================== é›²ç«¯åŒæ­¥éª¨æ¶ ====================
function updateSyncStatus() {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  if (state.settings.apiUrl) {
    dot.className = 'sync-dot';
    label.textContent = 'å·²é€£ç·š';
  } else {
    dot.className = 'sync-dot offline';
    label.textContent = 'æœ¬æ©Ÿ';
  }
}

async function callApi(method, data) {
  const url = state.settings.apiUrl;
  if (!url) throw new Error('æœªè¨­å®š API URL');

  if (method === 'GET') {
    const params = new URLSearchParams(data).toString();
    const res = await fetch(url + '?' + params);
    return await res.json();
  } else {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    return await res.json();
  }
}

async function syncToCloud() {
  if (!state.settings.apiUrl) {
    showToast('è«‹å…ˆåœ¨è¨­å®šé å¡«å…¥ API URL', 'error');
    return;
  }

  if (state.pendingSync.length === 0) {
    showToast('æ²’æœ‰å¾…åŒæ­¥çš„è³‡æ–™', 'info');
    return;
  }

  showToast('æ­£åœ¨åŒæ­¥...', 'info');
  let success = 0;
  let fail = 0;

  for (const item of state.pendingSync) {
    try {
      await callApi('POST', { action: item.type, ...item.data });
      success++;
    } catch (e) {
      fail++;
    }
  }

  if (fail === 0) {
    state.pendingSync = [];
    saveState();
    showToast(`åŒæ­¥å®Œæˆï¼å…± ${success} ç­†`, 'success');
  } else {
    showToast(`åŒæ­¥éƒ¨åˆ†å®Œæˆï¼š${success} æˆåŠŸ / ${fail} å¤±æ•—`, 'warning');
  }
}

function clearLocalData() {
  if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™å—ï¼Ÿ\nï¼ˆå ±åƒ¹å–®ã€æ¡è³¼å–®ã€ç”¢å“ç›®éŒ„éƒ½æœƒè¢«æ¸…é™¤ï¼‰')) return;
  if (!confirm('æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;
  Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
  state.quotations = [];
  state.purchaseOrders = [];
  state.products = [...DEFAULT_PRODUCTS];
  state.pendingSync = [];
  saveState();
  renderSettings();
  showToast('æœ¬åœ°è³‡æ–™å·²æ¸…é™¤', 'info');
}

// ==================== åœ–ç‰‡ä¸Šå‚³è™•ç† ====================
function handleImageUpload(type, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) {
    showToast('åœ–ç‰‡å¤§å°ä¸å¾—è¶…é 2MB', 'error');
    input.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result;
    if (type === 'logo') {
      state.settings.logoBase64 = base64;
    } else if (type === 'stamp') {
      state.settings.stampBase64 = base64;
    }
    saveState();
    renderImagePreview(type, base64);
    showToast((type === 'logo' ? 'Logo' : 'ç™¼ç¥¨ç« ') + ' å·²ä¸Šå‚³', 'success');
  };
  reader.readAsDataURL(file);
}

function clearImage(type) {
  if (type === 'logo') {
    state.settings.logoBase64 = '';
  } else if (type === 'stamp') {
    state.settings.stampBase64 = '';
  }
  saveState();
  renderImagePreview(type, '');
  showToast((type === 'logo' ? 'Logo' : 'ç™¼ç¥¨ç« ') + ' å·²æ¸…é™¤', 'info');
}

function renderImagePreview(type, base64) {
  const container = document.getElementById(type + 'Preview');
  if (!container) return;
  if (base64) {
    container.innerHTML = '<img src="' + base64 + '" style="max-height:60px;max-width:200px;border-radius:4px;border:1px solid rgba(255,255,255,0.1)">';
  } else {
    container.innerHTML = '<div style="color:var(--text-dim);font-size:12px">å°šæœªä¸Šå‚³</div>';
  }
}

// ==================== PDF ç”¢ç”Ÿï¼ˆhtml2canvas æ–¹æ¡ˆï¼‰====================
function escHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function buildQuoteHTML(q) {
  const co = state.settings.companyInfo;
  const sr = state.settings.salesRep || {};
  const bank = state.settings.bankInfo || {};
  const terms = state.settings.pdfTerms || '';
  const logoSrc = state.settings.logoBase64 || '';
  const stampSrc = state.settings.stampBase64 || '';
  const accent = '#145DDD';
  const afterDiscount = q.subtotal - (q.discountAmount || 0);
  const taxLabelMap = { excluded: 'ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰', included: 'ç‡Ÿæ¥­ç¨…ï¼ˆå…§å« 5%ï¼‰', exempt: 'ç‡Ÿæ¥­ç¨…ï¼ˆå…ç¨…ï¼‰' };
  const untaxed = q.taxType === 'included' ? Math.round(afterDiscount / 1.05) : afterDiscount;

  let itemsHTML = q.items.map((item, i) => `
    <tr style="border-bottom:1px solid #e5e5e5">
      <td style="text-align:center;padding:8px 4px">${i + 1}</td>
      <td style="padding:8px 6px">${escHtml(item.productName)}${item.spec ? '<br><span style="color:#888;font-size:11px">' + escHtml(item.spec) + '</span>' : ''}</td>
      <td style="text-align:center;padding:8px 4px">${item.qty}</td>
      <td style="text-align:center;padding:8px 4px">${escHtml(item.unit || 'å€‹')}</td>
      <td style="text-align:right;padding:8px 6px">NT$ ${numberFormat(item.unitPrice)}</td>
      <td style="text-align:right;padding:8px 6px">NT$ ${numberFormat(item.subtotal)}</td>
    </tr>
  `).join('');

  const allNotes = [q.notes, terms].filter(Boolean).join('\n');

  return `
  <div style="font-family:'Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif;color:#333;width:720px;padding:40px 45px;background:#fff;line-height:1.5">
    <!-- æ¨™é ­ -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
      <div>
        ${logoSrc ? '<img src="' + logoSrc + '" style="height:48px;margin-bottom:8px" crossorigin="anonymous">' : '<div style="font-size:22px;font-weight:700;color:' + accent + ';margin-bottom:4px">' + escHtml(co.name || 'å …å¿ƒ Outrun Nutrition') + '</div>'}
        ${co.legalName ? '<div style="font-size:11px;color:#666">' + escHtml(co.legalName) + (co.nameEn ? ' / ' + escHtml(co.nameEn) : '') + '</div>' : ''}
        ${co.taxId ? '<div style="font-size:11px;color:#666">çµ±ç·¨ï¼š' + escHtml(co.taxId) + '</div>' : ''}
        ${co.address ? '<div style="font-size:11px;color:#666">åœ°å€ï¼š' + escHtml(co.address) + '</div>' : ''}
        ${co.phone ? '<div style="font-size:11px;color:#666">é›»è©±ï¼š' + escHtml(co.phone) + '</div>' : ''}
      </div>
      <div style="text-align:right">
        <div style="font-size:28px;font-weight:700;color:${accent};letter-spacing:2px">QUOTATION</div>
        <div style="font-size:16px;color:#666;margin-bottom:6px">å ±åƒ¹å–®</div>
        <div style="font-size:11px;color:#555">å ±åƒ¹å–®è™Ÿï¼š${escHtml(q.id)}</div>
        <div style="font-size:11px;color:#555">é–‹ç«‹æ—¥æœŸï¼š${escHtml(q.date)}</div>
        <div style="font-size:11px;color:#555">æœ‰æ•ˆæœŸé™ï¼š${escHtml(q.validUntil)}</div>
      </div>
    </div>
    <div style="border-top:3px solid ${accent};margin-bottom:16px"></div>

    <!-- å®¢æˆ¶ + æ¥­å‹™ -->
    <div style="display:flex;gap:16px;margin-bottom:16px">
      <div style="flex:1;border:1px solid #ddd;border-radius:4px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:6px">å®¢æˆ¶è³‡è¨Š BILL TO</div>
        <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:4px">${escHtml(q.customer.name)}</div>
        ${q.customer.contact ? '<div style="font-size:11px;color:#666">è¯ç¹«äººï¼š' + escHtml(q.customer.contact) + '</div>' : ''}
        ${q.customer.address ? '<div style="font-size:11px;color:#666">åœ°å€ï¼š' + escHtml(q.customer.address) + '</div>' : ''}
        ${q.customer.phone ? '<div style="font-size:11px;color:#666">é›»è©±ï¼š' + escHtml(q.customer.phone) + '</div>' : ''}
        ${q.customer.email ? '<div style="font-size:11px;color:#666">Emailï¼š' + escHtml(q.customer.email) + '</div>' : ''}
      </div>
      <div style="flex:1;border:1px solid #ddd;border-radius:4px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:6px">æ¥­å‹™ä»£è¡¨ SALES REP</div>
        <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:4px">${escHtml(sr.name || state.settings.recorder || '')}</div>
        ${sr.phone ? '<div style="font-size:11px;color:#666">é›»è©±ï¼š' + escHtml(sr.phone) + '</div>' : ''}
        ${sr.email ? '<div style="font-size:11px;color:#666">Emailï¼š' + escHtml(sr.email) + '</div>' : ''}
        ${sr.line ? '<div style="font-size:11px;color:#666">LINEï¼š' + escHtml(sr.line) + '</div>' : ''}
      </div>
    </div>

    <!-- æ˜ç´°è¡¨æ ¼ -->
    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:12px">
      <thead>
        <tr style="background:${accent};color:#fff">
          <th style="padding:8px 6px;text-align:center;width:36px">#</th>
          <th style="padding:8px 6px;text-align:left">å“é … Description</th>
          <th style="padding:8px 6px;text-align:center;width:55px">æ•¸é‡</th>
          <th style="padding:8px 6px;text-align:center;width:50px">å–®ä½</th>
          <th style="padding:8px 6px;text-align:right;width:90px">å–®åƒ¹</th>
          <th style="padding:8px 6px;text-align:right;width:100px">å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>

    <!-- é‡‘é¡åŒ¯ç¸½ -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
      <div style="width:280px">
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666">
          <span>éŠ·å”®åˆè¨ˆï¼ˆæœªç¨…ï¼‰</span><span>NT$ ${numberFormat(untaxed)}</span>
        </div>
        ${q.discountAmount ? '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666"><span>æŠ˜æ‰£</span><span>-NT$ ' + numberFormat(q.discountAmount) + '</span></div>' : ''}
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666">
          <span>${taxLabelMap[q.taxType] || 'ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰'}</span><span>NT$ ${numberFormat(q.taxAmount)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#555">
          <span>å•†å“ç¸½é¡ï¼ˆå«ç¨…ï¼‰</span><span>NT$ ${numberFormat(q.total)}</span>
        </div>
        <div style="border-top:2px solid ${accent};margin:4px 0"></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:16px;font-weight:700;color:${accent}">
          <span>ç¸½è¨ˆ Total</span><span>NT$ ${numberFormat(q.total)}</span>
        </div>
      </div>
    </div>

    <!-- åŒ¯æ¬¾è³‡è¨Š -->
    ${(bank.bankName || bank.account) ? `
    <div style="border:1px solid #ddd;border-radius:4px;padding:10px 12px;margin-bottom:12px">
      <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:4px">åŒ¯æ¬¾è³‡è¨Š PAYMENT</div>
      ${bank.bankCode && bank.bankName ? '<div style="font-size:11px;color:#555">éŠ€è¡Œä»£ç¢¼ï¼š' + escHtml(bank.bankCode) + 'ï¼ˆ' + escHtml(bank.bankName) + 'ï¼‰</div>' : ''}
      ${bank.branch ? '<div style="font-size:11px;color:#555">åˆ†è¡Œï¼š' + escHtml(bank.branch) + '</div>' : ''}
      ${bank.account ? '<div style="font-size:11px;color:#555">å¸³è™Ÿï¼š' + escHtml(bank.account) + '</div>' : ''}
      ${bank.holder ? '<div style="font-size:11px;color:#555">æˆ¶åï¼š' + escHtml(bank.holder) + '</div>' : ''}
    </div>` : ''}

    <!-- å‚™è¨»æ¢æ¬¾ -->
    ${allNotes ? `
    <div style="border:1px solid #ddd;border-radius:4px;padding:10px 12px;margin-bottom:20px">
      <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:4px">å‚™è¨»æ¢æ¬¾ TERMS</div>
      <div style="font-size:10px;color:#666;white-space:pre-line">${escHtml(allNotes)}</div>
    </div>` : ''}

    <!-- ç°½ç½²å€ -->
    <div style="display:flex;gap:40px;margin-top:30px">
      <div style="flex:1">
        <div style="font-size:10px;color:#888;margin-bottom:30px">å®¢æˆ¶ç°½ç½² Accepted By</div>
        <div style="border-top:1px solid #ccc;padding-top:4px;font-size:9px;color:#aaa">å…¬å¸åç¨± / æ—¥æœŸ</div>
      </div>
      <div style="flex:1;text-align:center">
        <div style="font-size:10px;color:#888;margin-bottom:6px">${escHtml(co.legalName || co.name || '')} Authorized By</div>
        ${stampSrc ? '<img src="' + stampSrc + '" style="height:80px;margin-bottom:4px" crossorigin="anonymous">' : '<div style="height:80px"></div>'}
        <div style="border-top:1px solid #ccc;padding-top:4px;font-size:9px;color:#aaa">æˆæ¬Šç°½ç«  / æ—¥æœŸ</div>
      </div>
    </div>

    <!-- é è…³ -->
    <div style="text-align:center;margin-top:20px;font-size:9px;color:#bbb">
      ${escHtml([co.name, co.phone, co.email].filter(Boolean).join(' | '))}
    </div>
  </div>`;
}

function buildPOHTML(po) {
  const co = state.settings.companyInfo;
  const logoSrc = state.settings.logoBase64 || '';
  const stampSrc = state.settings.stampBase64 || '';
  const accent = '#145DDD';
  const poAfterTax = po.taxType === 'included' ? Math.round(po.subtotal / 1.05) : po.subtotal;
  const taxLabelMap = { excluded: 'ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰', included: 'ç‡Ÿæ¥­ç¨…ï¼ˆå…§å« 5%ï¼‰', exempt: 'ç‡Ÿæ¥­ç¨…ï¼ˆå…ç¨…ï¼‰' };

  let itemsHTML = po.items.map((item, i) => `
    <tr style="border-bottom:1px solid #e5e5e5">
      <td style="text-align:center;padding:8px 4px">${i + 1}</td>
      <td style="padding:8px 6px">${escHtml(item.itemName)}${item.spec ? '<br><span style="color:#888;font-size:11px">' + escHtml(item.spec) + '</span>' : ''}</td>
      <td style="text-align:center;padding:8px 4px">${item.qty}</td>
      <td style="text-align:center;padding:8px 4px">${escHtml(item.unit || 'å€‹')}</td>
      <td style="text-align:right;padding:8px 6px">NT$ ${numberFormat(item.unitPrice)}</td>
      <td style="text-align:right;padding:8px 6px">NT$ ${numberFormat(item.subtotal)}</td>
    </tr>
  `).join('');

  return `
  <div style="font-family:'Noto Sans TC','Microsoft JhengHei','PingFang TC',sans-serif;color:#333;width:720px;padding:40px 45px;background:#fff;line-height:1.5">
    <!-- æ¨™é ­ -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
      <div>
        ${logoSrc ? '<img src="' + logoSrc + '" style="height:48px;margin-bottom:8px" crossorigin="anonymous">' : '<div style="font-size:22px;font-weight:700;color:' + accent + ';margin-bottom:4px">' + escHtml(co.name || 'å …å¿ƒ Outrun Nutrition') + '</div>'}
        ${co.legalName ? '<div style="font-size:11px;color:#666">' + escHtml(co.legalName) + (co.nameEn ? ' / ' + escHtml(co.nameEn) : '') + '</div>' : ''}
        ${co.taxId ? '<div style="font-size:11px;color:#666">çµ±ç·¨ï¼š' + escHtml(co.taxId) + '</div>' : ''}
        ${co.address ? '<div style="font-size:11px;color:#666">åœ°å€ï¼š' + escHtml(co.address) + '</div>' : ''}
      </div>
      <div style="text-align:right">
        <div style="font-size:26px;font-weight:700;color:${accent};letter-spacing:1px">PURCHASE ORDER</div>
        <div style="font-size:16px;color:#666;margin-bottom:6px">æ¡è³¼å–®</div>
        <div style="font-size:11px;color:#555">æ¡è³¼å–®è™Ÿï¼š${escHtml(po.id)}</div>
        <div style="font-size:11px;color:#555">é–‹ç«‹æ—¥æœŸï¼š${escHtml(po.date)}</div>
        ${po.expectedDelivery ? '<div style="font-size:11px;color:#555">é æœŸäº¤è²¨ï¼š' + escHtml(po.expectedDelivery) + '</div>' : ''}
      </div>
    </div>
    <div style="border-top:3px solid ${accent};margin-bottom:16px"></div>

    <!-- ä¾›æ‡‰å•† + ä»˜æ¬¾æ¢ä»¶ -->
    <div style="display:flex;gap:16px;margin-bottom:16px">
      <div style="flex:1;border:1px solid #ddd;border-radius:4px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:6px">ä¾›æ‡‰å•† VENDOR</div>
        <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:4px">${escHtml(po.vendor.name)}</div>
        ${po.vendor.contact ? '<div style="font-size:11px;color:#666">è¯ç¹«äººï¼š' + escHtml(po.vendor.contact) + '</div>' : ''}
        ${po.vendor.phone ? '<div style="font-size:11px;color:#666">é›»è©±ï¼š' + escHtml(po.vendor.phone) + '</div>' : ''}
        ${po.vendor.email ? '<div style="font-size:11px;color:#666">Emailï¼š' + escHtml(po.vendor.email) + '</div>' : ''}
      </div>
      <div style="flex:1;border:1px solid #ddd;border-radius:4px;padding:12px">
        <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:6px">ä»˜æ¬¾æ¢ä»¶ TERMS</div>
        <div style="font-size:13px;font-weight:500;color:#333">${escHtml(po.paymentTerms || 'æœˆçµ30å¤©')}</div>
        ${po.relatedQuotationId ? '<div style="font-size:11px;color:#666;margin-top:6px">é—œè¯å ±åƒ¹å–®ï¼š' + escHtml(po.relatedQuotationId) + '</div>' : ''}
      </div>
    </div>

    <!-- æ˜ç´°è¡¨æ ¼ -->
    <table style="width:100%;border-collapse:collapse;margin-bottom:16px;font-size:12px">
      <thead>
        <tr style="background:${accent};color:#fff">
          <th style="padding:8px 6px;text-align:center;width:36px">#</th>
          <th style="padding:8px 6px;text-align:left">å“é … Description</th>
          <th style="padding:8px 6px;text-align:center;width:55px">æ•¸é‡</th>
          <th style="padding:8px 6px;text-align:center;width:50px">å–®ä½</th>
          <th style="padding:8px 6px;text-align:right;width:90px">å–®åƒ¹</th>
          <th style="padding:8px 6px;text-align:right;width:100px">å°è¨ˆ</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>

    <!-- é‡‘é¡åŒ¯ç¸½ -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
      <div style="width:280px">
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666">
          <span>å°è¨ˆï¼ˆæœªç¨…ï¼‰</span><span>NT$ ${numberFormat(poAfterTax)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#666">
          <span>${taxLabelMap[po.taxType] || 'ç‡Ÿæ¥­ç¨…ï¼ˆ5%ï¼‰'}</span><span>NT$ ${numberFormat(po.taxAmount)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:#555">
          <span>åˆè¨ˆé‡‘é¡ï¼ˆå«ç¨…ï¼‰</span><span>NT$ ${numberFormat(po.total)}</span>
        </div>
        <div style="border-top:2px solid ${accent};margin:4px 0"></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:16px;font-weight:700;color:${accent}">
          <span>ç¸½è¨ˆ Total</span><span>NT$ ${numberFormat(po.total)}</span>
        </div>
      </div>
    </div>

    <!-- å‚™è¨» -->
    ${po.notes ? `
    <div style="border:1px solid #ddd;border-radius:4px;padding:10px 12px;margin-bottom:20px">
      <div style="font-size:11px;font-weight:600;color:${accent};margin-bottom:4px">å‚™è¨» NOTES</div>
      <div style="font-size:10px;color:#666;white-space:pre-line">${escHtml(po.notes)}</div>
    </div>` : ''}

    <!-- ç°½ç½²å€ -->
    <div style="display:flex;gap:40px;margin-top:30px">
      <div style="flex:1">
        <div style="font-size:10px;color:#888;margin-bottom:30px">ä¾›æ‡‰å•†ç¢ºèª Vendor Confirmation</div>
        <div style="border-top:1px solid #ccc;padding-top:4px;font-size:9px;color:#aaa">å…¬å¸åç¨± / æ—¥æœŸ</div>
      </div>
      <div style="flex:1;text-align:center">
        <div style="font-size:10px;color:#888;margin-bottom:6px">${escHtml(co.legalName || co.name || '')} æ ¸å‡†</div>
        ${stampSrc ? '<img src="' + stampSrc + '" style="height:80px;margin-bottom:4px" crossorigin="anonymous">' : '<div style="height:80px"></div>'}
        <div style="border-top:1px solid #ccc;padding-top:4px;font-size:9px;color:#aaa">æˆæ¬Šç°½ç«  / æ—¥æœŸ</div>
      </div>
    </div>

    <!-- é è…³ -->
    <div style="text-align:center;margin-top:20px;font-size:9px;color:#bbb">
      ${escHtml([co.name, co.phone, co.email].filter(Boolean).join(' | '))}
    </div>
  </div>`;
}

async function htmlToPDF(htmlContent, filename) {
  showToast('æ­£åœ¨ç”¢ç”Ÿ PDF...', 'info');
  // å»ºç«‹éš±è—çš„æ¸²æŸ“å®¹å™¨
  const container = document.createElement('div');
  container.style.cssText = 'position:fixed;left:-9999px;top:0;z-index:-1;';
  container.innerHTML = htmlContent;
  document.body.appendChild(container);

  try {
    // ç­‰å¾…å­—é«”è¼‰å…¥
    if (document.fonts && document.fonts.ready) await document.fonts.ready;
    // çŸ­æš«å»¶é²ç¢ºä¿æ¸²æŸ“å®Œæˆ
    await new Promise(r => setTimeout(r, 300));

    const el = container.firstElementChild;
    const canvas = await html2canvas(el, {
      scale: 2.5,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false,
    });

    const imgData = canvas.toDataURL('image/jpeg', 0.92);
    const { jsPDF } = window.jspdf;

    // A4 æ¯”ä¾‹ï¼š210 x 297 mm
    const pdfW = 210;
    const pdfH = 297;
    const imgW = canvas.width;
    const imgH = canvas.height;
    const ratio = pdfW / imgW;
    const scaledH = imgH * ratio;

    // å¦‚æœå…§å®¹è¶…éä¸€é ï¼ŒæŒ‰é åˆ†å‰²
    if (scaledH <= pdfH) {
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      doc.addImage(imgData, 'JPEG', 0, 0, pdfW, scaledH);
      doc.save(filename);
    } else {
      const doc = new jsPDF({ unit: 'mm', format: [pdfW, scaledH] });
      doc.addImage(imgData, 'JPEG', 0, 0, pdfW, scaledH);
      doc.save(filename);
    }

    showToast('PDF å·²ä¸‹è¼‰ï¼š' + filename, 'success');
  } catch (e) {
    console.error('PDF ç”¢ç”Ÿå¤±æ•—:', e);
    showToast('PDF ç”¢ç”Ÿå¤±æ•—ï¼š' + e.message, 'error');
  } finally {
    document.body.removeChild(container);
  }
}

async function generateQuotePDF(q) {
  const html = buildQuoteHTML(q);
  await htmlToPDF(html, q.id + '.pdf');
}

async function generatePOPDF(po) {
  const html = buildPOHTML(po);
  await htmlToPDF(html, po.id + '.pdf');
}

// ==================== PWA ====================
(function initPWA() {
  const manifest = {
    name: 'å …å¿ƒå ±åƒ¹æ¡è³¼ â€” Outrun Nutrition',
    short_name: 'å …å¿ƒå ±åƒ¹æ¡è³¼',
    description: 'Outrun Nutrition å ±åƒ¹å–®èˆ‡æ¡è³¼å–®ç®¡ç†ç³»çµ±',
    start_url: location.href.split('?')[0],
    display: 'standalone',
    background_color: '#2F2F2F',
    theme_color: '#2F2F2F',
    icons: [{
      src: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="32" fill="#2F2F2F"/><text x="96" y="130" text-anchor="middle" font-size="110">ğŸ“‹</text></svg>'),
      sizes: '192x192', type: 'image/svg+xml',
    }],
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = URL.createObjectURL(blob);
  document.head.appendChild(link);

  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const banner = document.createElement('div');
    banner.id = 'pwaInstallBanner';
    banner.style.cssText = 'position:fixed;bottom:16px;left:12px;right:12px;background:var(--dark-gray);border:1px solid var(--orange);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
    banner.innerHTML = `<div style="font-size:28px">ğŸ“²</div><div style="flex:1"><div style="font-weight:600;font-size:14px">åŠ åˆ°ä¸»ç•«é¢</div><div style="font-size:11px;color:var(--text-secondary)">å®‰è£å …å¿ƒå ±åƒ¹æ¡è³¼ App</div></div>
    <button onclick="deferredPrompt.prompt();deferredPrompt=null;this.parentElement.remove()" style="background:var(--orange);color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer">å®‰è£</button>
    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px">âœ•</button>`;
    document.body.appendChild(banner);
  });
})();

// ==================== åˆå§‹åŒ– ====================
function initDateFields() {
  const today = todayStr();
  document.getElementById('quoteDate').value = today;
  document.getElementById('quoteValidUntil').value = addDays(today, 30);
  document.getElementById('poDate').value = today;
}

document.addEventListener('DOMContentLoaded', function() {
  loadState();
  initDateFields();
  updateSyncStatus();

  const now = new Date();
  listYear = statsYear = now.getFullYear();
  listMonth = statsMonth = now.getMonth() + 1;

  // é¦–æ¬¡ä½¿ç”¨åç¨±æç¤º
  if (!state.settings.recorder) {
    setTimeout(() => {
      const name = prompt('æ­¡è¿ä½¿ç”¨å …å¿ƒå ±åƒ¹/æ¡è³¼ç³»çµ±ï¼\nè«‹è¼¸å…¥ä½ çš„åå­—ï¼ˆç”¨æ–¼è¨˜éŒ„å»ºç«‹äººï¼‰ï¼š');
      if (name && name.trim()) {
        state.settings.recorder = name.trim();
        saveState();
        showToast('ä½ å¥½ï¼Œ' + name.trim() + 'ï¼', 'success');
      }
    }, 500);
  }

  addQuoteLineItem();

  // è‡ªå‹•è¼‰å…¥é è¨­ Logoï¼ˆå¦‚æœå°šæœªä¸Šå‚³è‡ªè¨‚ Logoï¼‰
  if (!state.settings.logoBase64) {
    autoLoadDefaultLogo();
  }
});

async function autoLoadDefaultLogo() {
  try {
    const resp = await fetch('logo.png');
    if (!resp.ok) return;
    const blob = await resp.blob();
    const reader = new FileReader();
    reader.onload = function(e) {
      state.settings.logoBase64 = e.target.result;
      saveState();
      renderImagePreview('logo', e.target.result);
    };
    reader.readAsDataURL(blob);
  } catch (e) { /* éœé»˜å¤±æ•— â€” æœ¬åœ°é–‹å•Ÿæ™‚å¯èƒ½æ²’æœ‰ logo.png */ }
}
</script>
</body>
</html>
